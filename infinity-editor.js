!function(t){function e(t){this._scene=t,this._guides=[],this._counter=0,this._visuals=[],this._shapeBoxGuide=new IFShapeBoxGuide(this),this._addGuide(this._shapeBoxGuide),this._addGuide(new IFPageGuide(this)),this._addGuide(new IFGridGuide(this)),this._addGuide(new IFUnitGuide(this))}IFObject.inherit(e,GEventTarget),e.VISUALS_LENGTH=20,e.InvalidationRequestEvent=function(t){this.area=t},IFObject.inherit(e.InvalidationRequestEvent,GEvent),e.InvalidationRequestEvent.prototype.area=null,e.InvalidationRequestEvent.prototype.toString=function(){return"[Event IFGuides.InvalidationRequestEvent]"},e.prototype._scene=null,e.prototype._guides=null,e.prototype._shapeBoxGuide=null,e.prototype._counter=0,e.prototype._visuals=null,e.prototype._area=null,e.prototype.beginMap=function(){0==this._counter&&(this._visuals=[],this._area&&!this._area.isEmpty()&&this.invalidate(this._area),this._area=null),++this._counter},e.prototype.finishMap=function(){if(this._counter>0&&(--this._counter,0==this._counter&&this._visuals.length)){for(var t,e=null,i=null,o=null,n=null,r=0;r<this._visuals.length;++r){t=this._visuals[r];for(var s=0;s<2;++s)(null===e||e>t[s].getX())&&(e=t[s].getX()),(null===i||i>t[s].getY())&&(i=t[s].getY()),(null===o||o<t[s].getX())&&(o=t[s].getX()),(null===n||n<t[s].getY())&&(n=t[s].getY())}e-=1,i-=1,o+=1,n+=1,this._area=new IFRect(e,i,o-e,n-i),this.invalidate(this._area),this._shapeBoxGuide.cleanExclusions()}},e.prototype.mapPoint=function(t){for(var e,i=null,o=null,n=null,r=[],s=0;s<this._guides.length&&(null===i||null===o);++s)(e=this._guides[s]).isMappingAllowed()&&((n=e.map(t.getX(),t.getY()))&&(n.x&&null===i&&(i=n.x.value,this._visuals&&n.x.guide&&(n.x.guide instanceof IFPoint?r.push(n.x.guide):this._visuals.push(n.x.guide))),n.y&&null===o&&(o=n.y.value,this._visuals&&n.y.guide&&(n.y.guide instanceof IFPoint?r.push(n.y.guide):this._visuals.push(n.y.guide)))),n=null);null===i&&(i=t.getX()),null===o&&(o=t.getY());var a,l=new IFPoint(i,o);for(s=0;s<r.length;++s)a=r[s],(Math.abs(i-a.getX())>=2||Math.abs(o-a.getY())>=2)&&this._visuals.push([l,a]);return l},e.prototype.paint=function(t,e){for(var i,o,n=0;n<this._guides.length;++n)(i=this._guides[n]).hasMixin(IFGuide.Visual)&&i.paint(t,e);for(n=0;n<this._visuals.length;++n){o=this._visuals[n];var r=t.mapPoint(o[0]),s=t.mapPoint(o[1]);e.canvas.strokeLine(Math.floor(r.getX())+.5,Math.floor(r.getY())+.5,Math.floor(s.getX())+.5,Math.floor(s.getY())+.5,1,e.guideOutlineColor)}this._visuals=[]},e.prototype.invalidate=function(t){this.hasEventListeners(e.InvalidationRequestEvent)&&(t&&!t.isEmpty()?this.trigger(new e.InvalidationRequestEvent(t)):this._area&&!this._area.isEmpty()&&(this.trigger(new e.InvalidationRequestEvent(this._area)),this._area=null))},e.prototype.getShapeBoxGuide=function(){return this._shapeBoxGuide},e.prototype.getBBoxSnapZones=function(t,i){for(var o=null,n=!1,r=0;r<this._guides.length&&!n;++r){var s=this._guides[r];!s.isMappingAllowed()||s instanceof IFUnitGuide||(n=!0)}var a=this._scene.getProperty("pickDist");if(n&&t&&!t.isEmpty()&&t.expanded(a,a,a,a).containsPoint(i)){o=[];var l,h=t.getClosestSideName(i),p=t.getSide(h),d=t.getSide(IFRect.Side.TOP_LEFT),c=t.getSide(IFRect.Side.BOTTOM_RIGHT),_=Math.abs(c.getX()-d.getX()),g=Math.abs(c.getY()-d.getY());l=_>2*e.VISUALS_LENGTH?e.VISUALS_LENGTH:_>e.VISUALS_LENGTH?_/2:_;var u=p.getY(),f=u,P=d.getX();switch(h){case IFRect.Side.TOP_CENTER:case IFRect.Side.CENTER:case IFRect.Side.BOTTOM_CENTER:P=p.getX()-l/2;break;case IFRect.Side.TOP_RIGHT:case IFRect.Side.RIGHT_CENTER:case IFRect.Side.BOTTOM_RIGHT:P=p.getX()-l}var m,I=P+l;switch(o.push([new IFPoint(P,u),new IFPoint(I,f)]),m=g>2*e.VISUALS_LENGTH?e.VISUALS_LENGTH:g>e.VISUALS_LENGTH?g/2:g,I=P=p.getX(),u=d.getY(),h){case IFRect.Side.LEFT_CENTER:case IFRect.Side.CENTER:case IFRect.Side.RIGHT_CENTER:u=p.getY()-m/2;break;case IFRect.Side.BOTTOM_LEFT:case IFRect.Side.BOTTOM_CENTER:case IFRect.Side.BOTTOM_RIGHT:u=p.getY()-m}f=u+m,o.push([new IFPoint(P,u),new IFPoint(I,f)])}return o},e.prototype._addGuide=function(t){this._guides.push(t)},e.prototype.toString=function(){return"[Object IFGuides]"},t.IFGuides=e}(this),function(t){function e(t){this._guides=t,this._scene=t._scene}IFObject.inherit(e,IFObject),e.prototype._guides=null,e.prototype._scene=null,e.Visual=function(){},e.Visual.prototype.paint=function(t,e){},e.Visual.prototype.toString=function(){return"[Mixin IFGuide.Visual]"},e.Map=function(){},e.Map.prototype.map=function(t,e){},e.Map.prototype.isMappingAllowed=function(){return!0},e.Map.prototype.toString=function(){return"[Mixin IFGuide.Map]"},e.prototype.toString=function(){return"[Object IFGuide]"},t.IFGuide=e}(this),function(t){function e(t){IFGuide.call(this,t)}IFObject.inheritAndMix(e,IFGuide,[IFGuide.Visual,IFGuide.Map]),e.MIN_CELL_SPACE=10,e.prototype.paint=function(t,i){if(this._scene.getProperty("gridActive")&&i.configuration.gridVisible){var o=IFColor.parseCSSColor("rgba(0, 0, 0, 0.125)"),n=t.getScaleFactor(),r=this._scene.getProperty("gridSizeX"),s=this._scene.getProperty("gridSizeY"),a=r*n,l=s*n;a<e.MIN_CELL_SPACE&&(a*=1+Math.floor(e.MIN_CELL_SPACE/a)),l<e.MIN_CELL_SPACE&&(l*=1+Math.floor(e.MIN_CELL_SPACE/l)),r=a/n,s=l/n;for(var h=i.dirtyMatcher.getDirtyRectangles(),p=0;p<h.length;++p){for(var d=h[p],c=new IFPoint(d.getX(),d.getY()),_=t.inverted().mapPoint(c),g=Math.ceil(_.getX()/r)*r,u=Math.ceil(_.getY()/s)*s,f=new IFPoint(g,u),P=t.mapPoint(f),m=P.getX();m-d.getX()<d.getWidth();m+=a)i.canvas.fillRect(Math.round(m),d.getY(),1,d.getHeight(),o);for(var I=P.getY();I-d.getY()<d.getHeight();I+=l)i.canvas.fillRect(d.getX(),Math.round(I),d.getWidth(),1,o)}}},e.prototype.map=function(t,e){var i=null;if(this._scene.getProperty("gridActive")){var o=this._scene.getProperty("gridSizeX"),n=this._scene.getProperty("gridSizeY");i={x:{value:Math.round(t/o)*o,guide:null},y:{value:Math.round(e/n)*n,guide:null}}}return i},e.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},e.prototype.toString=function(){return"[Object IFGridGuide]"},t.IFGridGuide=e}(this),function(t){function e(t){IFGuide.call(this,t)}IFObject.inheritAndMix(e,IFGuide,[IFGuide.Map]),e.prototype.map=function(t,e){var i=null;switch(this._scene.getProperty("unitSnap")){case IFScene.UnitSnap.Full:i={x:{value:ifMath.round(t,!0),guide:null},y:{value:ifMath.round(e,!0),guide:null}};break;case IFScene.UnitSnap.Half:i={x:{value:ifMath.round(t,!0)+.5,guide:null},y:{value:ifMath.round(e,!0)+.5,guide:null}}}return i},e.prototype.toString=function(){return"[Object IFUnitGuide]"},t.IFUnitGuide=e}(this),function(t){function e(t){IFGuide.call(this,t)}IFObject.inheritAndMix(e,IFGuide,[IFGuide.Map]),e.prototype.map=function(t,e){var i=this._scene.getProperty("snapDist"),o=null,n=null,r=null,s=null,a=null,l=function(a){var l=a.getGeometryBBox();if(l&&!l.isEmpty())for(var h=l.getSide(IFRect.Side.TOP_LEFT),p=l.getSide(IFRect.Side.BOTTOM_RIGHT),d=[h,p,l.getSide(IFRect.Side.CENTER)],c=[IFRect.Side.TOP_LEFT,IFRect.Side.BOTTOM_RIGHT,IFRect.Side.CENTER],_=0;_<c.length;++_){var g=d[_];null===o&&Math.abs(t-g.getX())<=i&&(o=g.getX(),c[_]==IFRect.Side.CENTER&&(r=[new IFPoint(o,h.getY()),new IFPoint(o,p.getY())])),null===n&&Math.abs(e-g.getY())<=i&&(n=g.getY(),c[_]==IFRect.Side.CENTER&&(s=[new IFPoint(h.getX(),n),new IFPoint(p.getX(),n)]))}};if(this._scene.getProperty("singlePage"))l(this._scene.getActivePage());else for(var h=this._scene.getFirstChild();null!==h&&(null===o||null===n);h=h.getNext())h instanceof IFPage&&!h.hasFlag(IFElement.Flag.Hidden)&&l(h);return null===o&&null===n||(a={x:null!==o?{value:o,guide:r}:null,y:null!==n?{value:n,guide:s}:null}),a},e.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},e.prototype.toString=function(){return"[Object IFPageGuide]"},t.IFPageGuide=e}(this),function(t){function e(t){IFGuide.call(this,t)}IFObject.inheritAndMix(e,IFGuide,[IFGuide.Map]),e.GUIDE_MARGIN=20,e.prototype._exclusions=null,e.prototype.map=function(t,i){var o=null,n=null,r=null,s=null,a=null;if(this._scene.getProperty("singlePage")){var l=this._scene.getProperty("snapDist"),h=function(a){if(this._exclusions)for(var h=0;h<this._exclusions.length;++h)if(this._exclusions[h]==a)return;var p=a.getGeometryBBox();if(p&&!p.isEmpty()){var d=p.getSide(IFRect.Side.TOP_LEFT),c=p.getSide(IFRect.Side.BOTTOM_RIGHT),_=[d,c,p.getSide(IFRect.Side.CENTER)],g=[IFRect.Side.TOP_LEFT,IFRect.Side.BOTTOM_RIGHT,IFRect.Side.CENTER];for(h=0;h<g.length;++h){var u=_[h];null===o&&Math.abs(t-u.getX())<=l&&(o=u.getX(),r=i<=d.getY()?[new IFPoint(o,i-e.GUIDE_MARGIN),new IFPoint(o,c.getY()+e.GUIDE_MARGIN)]:d.getY()<i&&i<c.getY()?[new IFPoint(o,d.getY()-e.GUIDE_MARGIN),new IFPoint(o,c.getY()+e.GUIDE_MARGIN)]:[new IFPoint(o,d.getY()-e.GUIDE_MARGIN),new IFPoint(o,i+e.GUIDE_MARGIN)]),null===n&&Math.abs(i-u.getY())<=l&&(n=u.getY(),s=t<=d.getX()?[new IFPoint(t-e.GUIDE_MARGIN,n),new IFPoint(c.getX()+e.GUIDE_MARGIN,n)]:d.getX()<t&&t<c.getX()?[new IFPoint(d.getX()-e.GUIDE_MARGIN,n),new IFPoint(c.getX()+e.GUIDE_MARGIN,n)]:[new IFPoint(d.getX()-e.GUIDE_MARGIN,n),new IFPoint(t+e.GUIDE_MARGIN,n)])}}}.bind(this);this._scene.getActivePage().accept(function(t){t instanceof IFShape&&t.getParent()instanceof IFLayer&&h(t)})}return null===o&&null===n||(a={x:null!==o?{value:o,guide:r}:null,y:null!==n?{value:n,guide:s}:null}),a},e.prototype.isMappingAllowed=function(){return!ifPlatform.modifiers.metaKey},e.prototype.useExclusions=function(t){this._exclusions=t},e.prototype.cleanExclusions=function(){this._exclusions=null},e.prototype.toString=function(){return"[Object IFShapeBoxGuide]"},t.IFShapeBoxGuide=e}(this),function(t){function e(t,e,i){var o=t.getSide(IFRect.Side.TOP_LEFT);this.tlx=o.getX(),this.tly=o.getY();var n=t.getSide(IFRect.Side.TOP_RIGHT);this.trx=n.getX(),this.try=n.getY();var r=t.getSide(IFRect.Side.BOTTOM_RIGHT);this.brx=r.getX(),this.bry=r.getY();var s=t.getSide(IFRect.Side.BOTTOM_LEFT);this.blx=s.getX(),this.bly=s.getY(),this._vertices=new IFVertexContainer,this.cx=e||(this.tlx+this.brx)/2,this.cy=i||(this.tly+this.bry)/2}e.ANNOT_SIZE=6,e.TRANSFORM_MARGIN=0,e.Handles={TOP_LEFT:0,TOP_CENTER:1,TOP_RIGHT:2,RIGHT_CENTER:3,BOTTOM_RIGHT:4,BOTTOM_CENTER:5,BOTTOM_LEFT:6,LEFT_CENTER:7,ROTATION_CENTER:8},e.OUTLINE=ifUtil.uuid(),e.INSIDE=ifUtil.uuid(),e.OUTSIDE=ifUtil.uuid(),e.prototype.tlx=null,e.prototype.tly=null,e.prototype.trx=null,e.prototype.try=null,e.prototype.brx=null,e.prototype.bry=null,e.prototype.blx=null,e.prototype.bly=null,e.prototype.cx=null,e.prototype.cy=null,e.prototype.trf=null,e.prototype.cTrf=null,e.prototype._vertices=null,e.prototype._extTransform=null,e.prototype.getTransform=function(){return this.trf},e.prototype.setTransform=function(t){this.trf=t},e.prototype.transform=function(t){t&&!t.isIdentity()&&(this.trf=this.trf?this.trf.multiplied(t):t)},e.prototype.rewindVertices=function(t){return(null==this._vertices||this._verticesDirty||0==this._vertices.getCount())&&(this._vertices.clearVertices(),this._generateVertices(),this._verticesDirty=!1),this._vertices.rewindVertices(t)},e.prototype.readVertex=function(t){return this._vertices.readVertex(t)},e.prototype._calculateGeometryBBox=function(){for(var t=this._getPoint(e.Handles.ROTATION_CENTER),i=t.getX(),o=i,n=t.getY(),r=n,s=[e.Handles.TOP_LEFT,e.Handles.TOP_RIGHT,e.Handles.BOTTOM_RIGHT,e.Handles.BOTTOM_LEFT],a=0;a<s.length;++a){var l=this._getPoint(s[a]);i>l.getX()&&(i=l.getX()),o<l.getX()&&(o=l.getX()),n>l.getY()&&(n=l.getY()),r<l.getY()&&(r=l.getY())}return new IFRect(i,n,o-i,r-n)},e.prototype._calculatePaintBBox=function(){var t=this._calculateGeometryBBox();return t?t=t.expanded(e.ANNOT_SIZE,e.ANNOT_SIZE,e.ANNOT_SIZE,e.ANNOT_SIZE):null},e.prototype.paint=function(t,i){var o=i.canvas.resetTransform();if(this._extTransform=t?o.multiplied(t):o,this._verticesDirty=!0,!this._centerOnly){if(!this.rewindVertices(0))return;i.canvas.putVertices(new IFVertexPixelAligner(this)),i.canvas.strokeVertices(IFColor.BLACK,1);for(var n=this._collectResizeHandles(t),r=0;r<n.length;++r){var s=this._getPoint(n[r]);ifAnnotation.paintAnnotation(i,null,s,ifAnnotation.AnnotType.Rectangle,!1,e.ANNOT_SIZE,IFColor.WHITE,IFColor.BLACK)}}ifAnnotation.paintAnnotation(i,null,this._getPoint(e.Handles.ROTATION_CENTER),ifAnnotation.AnnotType.Circle,!1,e.ANNOT_SIZE,IFColor.WHITE,IFColor.BLACK),i.canvas.setTransform(o),this._extTransform=null},e.prototype.hide=function(){this._centerOnly=!0},e.prototype.show=function(){this._centerOnly=!1},e.prototype.setCenterTransform=function(t){this.cTrf=t},e.prototype.getPartInfoAt=function(t,i,o){var n=null;i&&(this._extTransform=i,this._verticesDirty=!0);var r=this._collectResizeHandles(i);r.push(e.Handles.ROTATION_CENTER);for(var s=0;s<r.length;++s){var a=this._getPoint(r[s]);if(ifAnnotation.getAnnotationBBox(null,a,e.ANNOT_SIZE).expanded(o,o,o,o).containsPoint(t)){n=new IFElementEditor.PartInfo(null,r[s],a);break}}if(!n){var l=new IFVertexInfo.HitResult;if(ifVertexInfo.hitTest(t.getX(),t.getY(),this,o,!0,l))if(l.outline){var h=l.segment%2;n=new IFElementEditor.PartInfo(null,e.OUTLINE,h)}else n=new IFElementEditor.PartInfo(null,e.INSIDE,null);else{var p=this.getRotationSegment(t,i);n=new IFElementEditor.PartInfo(null,e.OUTSIDE,p)}}return this._extTransform=null,n},e.prototype.getRotationSegment=function(t,e){var i=0,o=e.mapPoint(new IFPoint(this.cx,this.cy)),n=Math.atan2(t.getY()-o.getY(),t.getX()-o.getX())+7*Math.PI/8;return n<0&&(n+=ifMath.PI2),((i=Math.floor(n/(Math.PI/4)))<0||i>7)&&(i=7),i},e.prototype.calculateTransformation=function(t,i,o,n,r,s,a){var l=o.subtract(i),h=l.getX(),p=l.getY(),d=function(t,e,i,o){var r=n.mapPoint(new IFPoint(t+h,e+p));i&&(h=r.getX()-t),o&&(p=r.getY()-e)}.bind(this);if(t.id<8){var c=[IFRect.Side.TOP_LEFT,IFRect.Side.TOP_CENTER,IFRect.Side.TOP_RIGHT,IFRect.Side.RIGHT_CENTER,IFRect.Side.BOTTOM_RIGHT,IFRect.Side.BOTTOM_CENTER,IFRect.Side.BOTTOM_LEFT,IFRect.Side.LEFT_CENTER],_=new IFRect(this.tlx,this.tly,this.brx-this.tlx,this.bry-this.tly),g=c[t.id],u=_.getSide(g);return d(u.getX(),u.getY(),!0,!0),_.getResizeTransform(g,h,p,s,r)}if(t.id==e.Handles.ROTATION_CENTER)return d(this.cx,this.cy,!0,!0),new IFTransform(1,0,0,1,h,p);if(t.id==e.OUTSIDE){transform1=new IFTransform(1,0,0,1,-this.cx,-this.cy),transform3=new IFTransform(1,0,0,1,this.cx,this.cy);var f=Math.atan2(i.getY()-this.cy,i.getX()-this.cx)-Math.atan2(o.getY()-this.cy,o.getX()-this.cx);if(s){var P=a||Math.PI/12;f=Math.round(f/P)*P}var m=Math.cos(f),I=Math.sin(f),v=new IFTransform(m,-I,I,m,0,0);return transform1.multiplied(v).multiplied(transform3)}if(t.id==e.OUTLINE){if(transform1=new IFTransform(1,0,0,1,-this.cx,-this.cy),transform3=new IFTransform(1,0,0,1,this.cx,this.cy),s&&a){P=a||20;h=Math.round(h/P)*P,p=Math.round(p/P)*P}v=new IFTransform(1,2*p/(this.brx-this.tlx),2*-h/(this.bry-this.tly),1,0,0);return transform1.multiplied(v).multiplied(transform3)}var y=(this.brx-this.tlx)/3,E=(this.bry-this.tly)/3,F=this.cx,T=this.cy;return i.getX()<=this.tlx+y?F=this.tlx:i.getX()>=this.tlx+2*y&&(F=this.brx),i.getY()<=this.tly+E?T=this.tly:i.getY()>=this.tly+2*E&&(T=this.bry),d(F,T,!0,!0),new IFTransform(1,0,0,1,h,p)},e.prototype.applyCenterTransform=function(){if(this.trf||this.cTrf){var t=(this.trf?this.trf:this.cTrf).mapPoint(new IFPoint(this.cx,this.cy));this.cTrf=null,this.trf=null,this.cx=t.getX(),this.cy=t.getY()}},e.prototype._generateVertices=function(){this._vertices&&5==this._vertices.getCount()?this._vertices.rewindVertices(0):this._vertices=new IFVertexContainer;var t=this._getPoint(e.Handles.TOP_LEFT),i=this._getPoint(e.Handles.TOP_RIGHT),o=this._getPoint(e.Handles.BOTTOM_RIGHT),n=this._getPoint(e.Handles.BOTTOM_LEFT);this._vertices.addVertex(IFVertex.Command.Move,t.getX(),t.getY()),this._vertices.addVertex(IFVertex.Command.Line,i.getX(),i.getY()),this._vertices.addVertex(IFVertex.Command.Line,o.getX(),o.getY()),this._vertices.addVertex(IFVertex.Command.Line,n.getX(),n.getY()),this._vertices.addVertex(IFVertex.Command.Close)},e.prototype._getPoint=function(t,i){var o=null,n=function(t,e){var o=e||this.trf,n=this._extTransform;return o&&!i&&(n=n?o.multiplied(n):o),n&&t&&(t=n.mapPoint(t)),t}.bind(this);switch(t){case e.Handles.TOP_LEFT:o=n(new IFPoint(this.tlx,this.tly)),o=new IFPoint(o.getX()-e.TRANSFORM_MARGIN,o.getY()-e.TRANSFORM_MARGIN);break;case e.Handles.TOP_CENTER:o=n(new IFPoint((this.tlx+this.trx)/2,(this.tly+this.try)/2)),o=new IFPoint(o.getX(),o.getY()-e.TRANSFORM_MARGIN);break;case e.Handles.TOP_RIGHT:o=n(new IFPoint(this.trx,this.try)),o=new IFPoint(o.getX()+e.TRANSFORM_MARGIN,o.getY()-e.TRANSFORM_MARGIN);break;case e.Handles.RIGHT_CENTER:o=n(new IFPoint((this.trx+this.brx)/2,(this.try+this.bry)/2)),o=new IFPoint(o.getX()+e.TRANSFORM_MARGIN,o.getY());break;case e.Handles.BOTTOM_RIGHT:o=n(new IFPoint(this.brx,this.bry)),o=new IFPoint(o.getX()+e.TRANSFORM_MARGIN,o.getY()+e.TRANSFORM_MARGIN);break;case e.Handles.BOTTOM_CENTER:o=n(new IFPoint((this.blx+this.brx)/2,(this.bly+this.bry)/2)),o=new IFPoint(o.getX(),o.getY()+e.TRANSFORM_MARGIN);break;case e.Handles.BOTTOM_LEFT:o=n(new IFPoint(this.blx,this.bly)),o=new IFPoint(o.getX()-e.TRANSFORM_MARGIN,o.getY()+e.TRANSFORM_MARGIN);break;case e.Handles.LEFT_CENTER:o=n(new IFPoint((this.tlx+this.blx)/2,(this.tly+this.bly)/2)),o=new IFPoint(o.getX()-e.TRANSFORM_MARGIN,o.getY());break;case e.Handles.ROTATION_CENTER:o=n(new IFPoint(this.cx,this.cy),this.cTrf)}return o},e.prototype._collectResizeHandles=function(t){var i=new IFRect(this.tlx,this.tly,this.brx-this.tlx,this.bry-this.tly);i=this.trf?this.trf.mapRect(i):i;var o=t?t.mapRect(i):i,n=[];return o.getHeight()>2*(e.ANNOT_SIZE+2)&&o.getWidth()>2*(e.ANNOT_SIZE+2)&&(n=n.concat([e.Handles.TOP_LEFT,e.Handles.TOP_RIGHT,e.Handles.BOTTOM_LEFT,e.Handles.BOTTOM_RIGHT])),o.getHeight()>3*(e.ANNOT_SIZE+2)&&(n=n.concat([e.Handles.RIGHT_CENTER,e.Handles.LEFT_CENTER])),o.getWidth()>3*(e.ANNOT_SIZE+2)&&(n=n.concat([e.Handles.TOP_CENTER,e.Handles.BOTTOM_CENTER])),n},e.prototype.toString=function(){return"[IFTransformBox]"},t.IFTransformBox=e}(this),function(t){function e(t){this._element=t}IFObject.inherit(e,IFObject),e._Editors={},e.exports=function(t,i){e._Editors[IFObject.getTypeId(i)]=t},e.OPTIONS={annotationSizeRegular:6,annotationSizeSmall:4,centerCrossSize:4},e.Flag={Selected:1,Highlighted:2,Detail:4,Outline:8},e.Annotation={Rectangle:ifAnnotation.AnnotType.Rectangle,Circle:ifAnnotation.AnnotType.Circle,Diamond:ifAnnotation.AnnotType.Diamond},e.DropType={Pattern:0,Text:1,Node:2},e.getEditor=function(t){return t.__editor__?t.__editor__:null},e.createEditor=function(t){var i=e._Editors[IFObject.getTypeId(t)];return i?new i(t):null},e.openEditor=function(t){if(!t.isAttached())throw new Error("Node is not attached to create an editor for.");if(null!=e.getEditor(t))return e.getEditor(t);var i=e.createEditor(t);if(!i)return null;for(var o=t.getParent();null!==o;o=o.getParent()){var n=e.getEditor(o);if(n||(n=e.openEditor(o)),n){for(var r=null,s=t.getNext();null!=s;s=s.getNext()){var a=e.getEditor(s);if(a){r=a;break}}n.insertEditor(i,r);break}}return i._attach(),t.__editor__=i,i},e.closeEditor=function(t){var i=e.getEditor(t);if(i){if(!e._Editors[IFObject.getTypeId(t)])return;var o=i.getEditors();if(o)for(var n=0;n<o.length;++n)e.closeEditor(o[n].getElement());i.getParentEditor()&&i.getParentEditor().removeEditor(i),i._detach(),delete t.__editor__}},e.PartInfo=function(t,e,i,o,n){this.editor=t,this.id=e,this.data=i,this.isolated=o,this.selectable=n},e.PartInfo.prototype.id=null,e.PartInfo.prototype.data=null,e.PartInfo.prototype.editor=null,e.PartInfo.prototype.isolated=null,e.PartInfo.prototype.selectable=null,e.prototype._flags=0,e.prototype._element=null,e.prototype._elementPreview=null,e.prototype._transform=null,e.prototype._parentEditor=null,e.prototype._editors=null,e.prototype._partSelection=null,e.prototype.hasFlag=function(t){return 0!=(this._flags&t)},e.prototype.setFlag=function(t){0==(this._flags&t)&&(this.requestInvalidation(),this._flags=this._flags|t,this.requestInvalidation())},e.prototype.removeFlag=function(t){0!=(this._flags&t)&&(this.requestInvalidation(),this._flags=this._flags&~t,this.requestInvalidation())},e.prototype.getElement=function(){return this._element},e.prototype.getPaintElement=function(){return this._elementPreview?this._elementPreview:this._element},e.prototype.getParentEditor=function(){return this._parentEditor},e.prototype.getEditors=function(){return this._editors},e.prototype.appendEditor=function(t){this.insertEditor(t,null)},e.prototype.insertEditor=function(t,e){var i=this._editors?this._editors.length:0;if(e&&(i=this._editors.indexOf(e))<0)throw new Error("Unknown reference editor.");if(null!=t._parentEditor)throw new Error("Editor already appended.");this._editors||(this._editors=[]),i>=this._editors.length?this._editors.push(t):this._editors.splice(i,0,t),t._parentEditor=this},e.prototype.removeEditor=function(t){var e=this._editors.indexOf(t);if(e<0)throw new Error("Unknown editor.");this._editors.splice(e,1),t._parentEditor=null},e.prototype.accept=function(t){if(!1===t.call(null,this))return!1;if(this._editors)for(var e=0;e<this._editors.length;++e)if(!1===this._editors[e].accept(t))return!1;return!0},e.prototype.isPartSelected=function(t){return this._indexOfPartId(this._partSelection,t)>=0},e.prototype.getPartSelection=function(){return this._partSelection},e.prototype.updatePartSelection=function(t,i){if(this.hasFlag(e.Flag.Selected)){var o=null;if(t&&this._partSelection){if(i){o=[];for(var n=0;n<this._partSelection.length;++n)this._indexOfPartId(i,this._partSelection[n])<0&&o.push(this._partSelection[n]);for(n=0;n<i.length;++n)this._indexOfPartId(this._partSelection,i[n])<0&&o.push(i[n]);0===o.length&&(o=null)}}else o=i&&i.length>0?i.slice():null;ifUtil.equals(o,this._partSelection,!1)||this._updatePartSelection(o)}},e.prototype.getPartInfoAt=function(t,e,i,o){if(o=o||0,this._editors&&this._editors.length)for(var n=this._editors.length-1;n>=0;--n){if(r=this._editors[n].getPartInfoAt(t,e,i,o))return r}if(i&&!0!==i.call(null,this))return null;var r,s=this.getBBox(e);if(s&&!s.isEmpty()&&(s.containsPoint(t)&&(r=this._getPartInfoAt(t,e,o))))return r;return null},e.prototype.paint=function(t,e){this._paintChildren(t,e)},e.prototype.getBBox=function(t){if(this.hasFlag(e.Flag.Selected)||this.hasFlag(e.Flag.Highlighted)){var i=t;this._transform&&(i=this._transform.multiplied(t));var o=this.getPaintElement().getGeometryBBox();if(o&&!o.isEmpty()){var n=this.getBBoxMargin();if(o=i.mapRect(o).expanded(n,n,n,n),this.hasFlag(e.Flag.Detail)){var r=this.getCustomBBox(i,!1);r&&(o=o.united(r))}}return o}return null},e.prototype.getBBoxMargin=function(){return 1},e.prototype.getCustomBBox=function(t,e){return null},e.prototype.requestInvalidation=function(t){IFEditor.getEditor(this._element.getScene()).requestInvalidation(this,t)},e.prototype.invalidate=function(t,e){return e?null:this.getBBox(t)},e.prototype.movePart=function(t,i,o,n,r,s,a){this.hasFlag(e.Flag.Outline)?this.requestInvalidation():this.setFlag(e.Flag.Outline)},e.prototype.resetPartMove=function(t,i){this._elementPreview=null,this.removeFlag(e.Flag.Outline)},e.prototype.applyPartMove=function(t,i){this._elementPreview=null,this.removeFlag(e.Flag.Outline)},e.prototype.transform=function(t,e,i){this._setTransform(t)},e.prototype.resetTransform=function(){this._elementPreview=null,this.requestInvalidation(),this._transform=null,this.removeFlag(e.Flag.Outline)},e.prototype.canApplyTransform=function(){var t=this.getElement();return this._transform&&!this._transform.isIdentity()&&t.hasMixin(IFElement.Transform)&&!t.hasFlag(IFElement.Flag.Locked)},e.prototype.applyTransform=function(t){this._transform.isIdentity()||t.transform(this._transform),this.resetTransform()},e.prototype.acceptDrop=function(t,i,o,n){if(this._editors)for(var r=0;r<this._editors.length;++r)if(!0===this._editors[r].acceptDrop(t,i,o,n))return!0;if(i===e.DropType.Node&&o&&o instanceof IFStyle&&this._element.hasMixin(IFElement.Style)){var s=IFEditor.getEditor(this._element.getScene());s.beginTransaction();try{if(o instanceof IFSharedStyle){var a=new IFLinkedStyle;a.setProperty("ref",o.getReferenceId()),this._element.getStyleSet().appendChild(a)}else this._element.getStyleSet().appendChild(o)}finally{s.commitTransaction("Drag Style")}return!0}return!1},e.prototype.initialSetup=function(){},e.prototype.canInlineEdit=function(){return!1},e.prototype.isInlineEdit=function(){return!1},e.prototype.beginInlineEdit=function(t,e){throw new Error("Not Supported.")},e.prototype.adjustInlineEditForView=function(t,e){throw new Error("Not Supported.")},e.prototype.finishInlineEdit=function(){throw new Error("Not Supported.")},e.prototype.subSelectDragStartAction=function(t){var e=null;if(this._editors)for(var i=0;i<this._editors.length;++i)if(e=this._editors[i].subSelectDragStartAction(t))return e;return t.editor===this&&(e=t),e},e.prototype._attach=function(){},e.prototype._detach=function(){},e.prototype._paintChildren=function(t,i){if(this._editors)for(var o=0;o<this._editors.length;++o){var n=this._editors[o];n instanceof e&&n.paint(t,i)}},e.prototype._getPartInfoAt=function(t,e,i){return null},e.prototype._partIdAreEqual=function(t,e){return t===e},e.prototype._indexOfPartId=function(t,e){if(t&&t.length>0)for(var i=0;i<t.length;++i)if(this._partIdAreEqual(t[i],e))return i;return-1},e.prototype._updatePartSelection=function(t){this.requestInvalidation(),this._partSelection=t,this.requestInvalidation()},e.prototype._paintAnnotation=function(t,i,o,n,r,s){var a=s?e.OPTIONS.annotationSizeSmall:e.OPTIONS.annotationSizeRegular;ifAnnotation.paintAnnotation(t,i,o,n,r,a)},e.prototype._getAnnotationBBox=function(t,i,o){var n=o?e.OPTIONS.annotationSizeSmall:e.OPTIONS.annotationSizeRegular;return ifAnnotation.getAnnotationBBox(t,i,n)},e.prototype._showAnnotations=function(){return this.hasFlag(e.Flag.Selected)&&!this.hasFlag(e.Flag.Outline)},e.prototype._setTransform=function(t){IFTransform.equals(this._transform,t)||(this.hasFlag(e.Flag.Outline)?this.requestInvalidation():this.setFlag(e.Flag.Outline),this._transform=t,this.requestInvalidation())},e.prototype.toString=function(){return"[Object IFElementEditor]"},t.IFElementEditor=e}(this),function(t){function e(t){IFElementEditor.call(this,t)}IFObject.inherit(e,IFElementEditor),e.Flag={ResizeEdges:1024,ResizeCenters:2048,ResizeAll:3072},e.RESIZE_HANDLE_PART_ID=ifUtil.uuid(),e.prototype.getBBoxMargin=function(){return this._showResizeHandles()?IFElementEditor.OPTIONS.annotationSizeSmall+1:IFElementEditor.prototype.getBBoxMargin.call(this)},e.prototype.movePart=function(t,i,o,n,r,s,a){if(IFElementEditor.prototype.movePart.call(this,t,i,o,n,r,s,a),t===e.RESIZE_HANDLE_PART_ID){var l=n.mapPoint(o),h=(l=r.mapPoint(l)).subtract(i.point),p=this._element.getGeometryBBox().getResizeTransform(i.side,h.getX(),h.getY(),s,a);this.transform(p)}},e.prototype.applyPartMove=function(t,i){t===e.RESIZE_HANDLE_PART_ID&&this.applyTransform(this._element),IFElementEditor.prototype.applyPartMove.call(this,t,i)},e.prototype.paint=function(t,e){if(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted)){var i=t;this._transform&&(i=this._transform.multiplied(t)),this._prePaint(i,e),this._showResizeHandles()&&this._iterateResizeHandles(function(i,o){this._paintAnnotation(e,t,i,IFElementEditor.Annotation.Rectangle,!1,!0)}.bind(this),t),this._postPaint(i,e)}this._paintChildren(t,e)},e.prototype._getPartInfoAt=function(t,i,o){if(this._showResizeHandles()){var n=null;if(this._iterateResizeHandles(function(o,r){if(this._getAnnotationBBox(i,o).containsPoint(t))return n=new IFElementEditor.PartInfo(this,e.RESIZE_HANDLE_PART_ID,{side:r,point:o},!0,!1),!0}.bind(this),i),n)return n}return null},e.prototype._prePaint=function(t,e){},e.prototype._postPaint=function(t,e){},e.prototype._showResizeHandles=function(){return this._showAnnotations()&&(this.hasFlag(e.Flag.ResizeEdges)||this.hasFlag(e.Flag.ResizeCenters))},e.prototype._iterateResizeHandles=function(t,i){var o=this.getPaintElement().getGeometryBBox();if(o&&!o.isEmpty()){var n=[],r=i?i.mapRect(o):o;this.hasFlag(e.Flag.ResizeEdges)&&r.getHeight()>2*(IFElementEditor.OPTIONS.annotationSizeSmall+2)&&r.getWidth()>2*(IFElementEditor.OPTIONS.annotationSizeSmall+2)&&(n=n.concat([IFRect.Side.TOP_LEFT,IFRect.Side.TOP_RIGHT,IFRect.Side.BOTTOM_LEFT,IFRect.Side.BOTTOM_RIGHT])),this.hasFlag(e.Flag.ResizeCenters)&&(r.getHeight()>3*(IFElementEditor.OPTIONS.annotationSizeSmall+2)&&(n=n.concat([IFRect.Side.RIGHT_CENTER,IFRect.Side.LEFT_CENTER])),r.getWidth()>3*(IFElementEditor.OPTIONS.annotationSizeSmall+2)&&(n=n.concat([IFRect.Side.TOP_CENTER,IFRect.Side.BOTTOM_CENTER])));for(var s=0;s<n.length;++s){var a=n[s];if(!0===t(o.getSide(a),a))break}}},e.prototype._paintBBoxOutline=function(t,e,i){var o=this._element.getGeometryBBox(),n=t.mapRect(o);if(n&&!n.isEmpty()){var r=Math.floor(n.getX()),s=Math.floor(n.getY()),a=Math.ceil(n.getX()+n.getWidth())-r,l=Math.ceil(n.getY()+n.getHeight())-s;i||(i=this.hasFlag(IFElementEditor.Flag.Highlighted)?e.highlightOutlineColor:e.selectionOutlineColor),e.canvas.strokeRect(r+.5,s+.5,a,l,1,i)}},e.prototype.toString=function(){return"[Object IFBlockEditor]"},t.IFBlockEditor=e}(this),function(t){function e(t){IFElementEditor.call(this,t)}IFObject.inherit(e,IFElementEditor),IFElementEditor.exports(e,IFScene),e.prototype._transformBox=null,e.prototype._visuals=null,e.prototype._visualsArea=null,e.TBoxMode={NA:0,PASSIVE:1,TBOXMOVE:2,CNTRMOVE:3,ROTATE:4,RESIZE:5,SKEW:6},e.prototype._tBoxMode=e.TBoxMode.NA,e.prototype._tBoxData=null,e.prototype._mouseInfo=null,e.prototype.paint=function(t,e){if(IFElementEditor.prototype.paint.call(this,t,e),this._transformBox&&(this._transformBox.paint(t,e),this._visuals)){for(var i,o=0;o<this._visuals.length;++o){var n=(i=this._visuals[o])[0],r=i[1];e.canvas.strokeLine(Math.floor(n.getX())+.5,Math.floor(n.getY())+.5,Math.floor(r.getX())+.5,Math.floor(r.getY())+.5,1,e.highlightOutlineColor)}this._visuals=null}},e.prototype.getBBox=function(t){var e=IFElementEditor.prototype.getBBox.call(this,t);if(this._transformBox){var i=this._transformBox._calculateGeometryBBox();i&&!i.isEmpty()&&(i=(i=t?t.mapRect(i):i).expanded(IFTransformBox.ANNOT_SIZE,IFTransformBox.ANNOT_SIZE,IFTransformBox.ANNOT_SIZE,IFTransformBox.ANNOT_SIZE),e=e?e.united(i):i)}return e},e.prototype._detach=function(){this._transformBox&&this.setTransformBoxActive(!1)},e.prototype.isTransformBoxActive=function(){return null!=this._transformBox},e.prototype.setTransformBoxActive=function(t,e){t||null===t?(this._transformBox||this._element.addEventListener(IFElement.GeometryChangeEvent,this._geometryChange,this),this._updateSelectionTransformBox(e)):this._transformBox&&(this._element.removeEventListener(IFElement.GeometryChangeEvent,this._geometryChange,this),this.requestInvalidation(),this._transformBox=null,this.requestInvalidation())},e.prototype.getTransformBox=function(){return this._transformBox},e.prototype.requestInvalidation=function(t){this._getGraphicEditor().requestInvalidation(this,t)},e.prototype.getTBoxMode=function(){return this._tBoxMode},e.prototype._updateTBoxMode=function(t){this._tBoxMode=t},e.prototype.hideTransformBox=function(){this._transformBox&&this._transformBox.hide(),this.requestInvalidation()},e.prototype.showTransformBox=function(){this._transformBox&&this._transformBox.show(),this.requestInvalidation()},e.prototype.getTransformBoxCenter=function(){return this._transformBox?new IFPoint(this._transformBox.cx,this._transformBox.cy):null},e.prototype._applyTBoxCenterTransform=function(){if(this._transformBox&&(this._transformBox.trf||this._transformBox.cTrf)){this._getGraphicEditor().beginTransaction();try{this._transformBox.applyCenterTransform()}finally{this._getGraphicEditor().commitTransaction("Move")}this.requestInvalidation()}},e.prototype.getCursor=function(t){var e=IFCursor.Select;switch(t.id){case IFTransformBox.INSIDE:e=IFCursor.SelectCross;break;case IFTransformBox.OUTSIDE:e=IFCursor.SelectRotate[t.data];break;case IFTransformBox.OUTLINE:e=t.data?IFCursor.SelectSkewHoriz:IFCursor.SelectSkewVert;break;case IFTransformBox.Handles.TOP_CENTER:case IFTransformBox.Handles.BOTTOM_CENTER:e=IFCursor.SelectResizeVert;break;case IFTransformBox.Handles.LEFT_CENTER:case IFTransformBox.Handles.RIGHT_CENTER:e=IFCursor.SelectResizeHoriz;break;case IFTransformBox.Handles.TOP_LEFT:case IFTransformBox.Handles.BOTTOM_RIGHT:e=IFCursor.SelectResizeUpLeftDownRight;break;case IFTransformBox.Handles.TOP_RIGHT:case IFTransformBox.Handles.BOTTOM_LEFT:e=IFCursor.SelectResizeUpRightDownLeft;break;case IFTransformBox.Handles.ROTATION_CENTER:e=IFCursor.SelectArrowOnly}return e},e.prototype.updateTBoxUnderMouse=function(t,i,o){var n=null;this._tBoxData?(n=new IFElementEditor.PartInfo(this._tBoxData.editor,this._tBoxData.id,this._tBoxData.data)).id==IFTransformBox.OUTSIDE&&(n.data=this._transformBox.getRotationSegment(t,i)):n=this._transformBox.getPartInfoAt(t,i,this._element.getProperty("pickDist")),this._mouseInfo&&this._mouseInfo.id==n.id&&this._mouseInfo.data==n.data||(this._mouseInfo=n,o.setCursor(this.getCursor(this._mouseInfo)));var r=null;if(this._visuals=null,this._tBoxMode==e.TBoxMode.PASSIVE&&this._mouseInfo.id==IFTransformBox.INSIDE){var s=this._getGraphicEditor().getSelection(),a=IFElement.prototype.getGroupGeometryBBox(s);if(a&&!a.isEmpty()){r=i.mapRect(a);var l=this._getGraphicEditor().getGuides().getBBoxSnapZones(r,t);l&&l.length&&(this._visuals=l)}}var h=this._visuals?r.expanded(2,2,2,2):null;h=h?o.getViewTransform().mapRect(h):null,(this._visualsArea||h)&&(this._visualsArea,this.requestInvalidation(),this._visualsArea=h,this.requestInvalidation())},e.prototype.getTBoxPartInfoAt=function(t,e,i){return this._transformBox.getPartInfoAt(t,e,i)},e.prototype.startTBoxTransform=function(t){this._visualsArea&&(this.requestInvalidation(),this._visualsArea=null),this._tBoxData=new IFElementEditor.PartInfo(t.editor,t.id,t.data),this._tBoxData.id==IFTransformBox.OUTLINE?this._updateTBoxMode(e.TBoxMode.SKEW):this._tBoxData.id==IFTransformBox.OUTSIDE?this._updateTBoxMode(e.TBoxMode.ROTATE):this._tBoxData.id>=0&&this._tBoxData.id<IFTransformBox.Handles.ROTATION_CENTER?this._updateTBoxMode(e.TBoxMode.RESIZE):this._tBoxData.id==IFTransformBox.Handles.ROTATION_CENTER?this._updateTBoxMode(e.TBoxMode.CNTRMOVE):this._updateTBoxMode(e.TBoxMode.TBOXMOVE),this.hideTransformBox()},e.prototype.transformTBox=function(t,i,o,n,r){if(this._tBoxMode!=e.TBoxMode.PASSIVE&&this._tBoxMode!=e.TBoxMode.NA){var s=this._getGraphicEditor().getGuides();s.getShapeBoxGuide().useExclusions(this._getGraphicEditor().getSelection()),s.beginMap();var a=r;a||this._tBoxMode!=e.TBoxMode.SKEW||(a=this._element.getProperty("gridSizeX"));var l=this._transformBox.calculateTransformation(this._tBoxData,t,i,s,o,n,a);s.finishMap(),this.requestInvalidation(),this._tBoxMode!=e.TBoxMode.CNTRMOVE?(this._transformBox.setTransform(l),this._getGraphicEditor().transformSelection(l,null,null)):(this._transformBox.setCenterTransform(l),this.requestInvalidation())}},e.prototype.applyTBoxTransform=function(t){this._tBoxMode==e.TBoxMode.CNTRMOVE?(this._applyTBoxCenterTransform(),this.showTransformBox()):this._getGraphicEditor().applySelectionTransform(t),this._updateTBoxMode(e.TBoxMode.PASSIVE),this._tBoxData=null,this._mouseInfo=null},e.prototype._updateSelectionTransformBox=function(t){this.requestInvalidation();var i=null,o=null;t?(i=t.getX(),o=t.getY()):this._transformBox&&(i=this._transformBox.cx,o=this._transformBox.cy),this._transformBox=null;var n=this._getGraphicEditor().getSelection(),r=IFElement.prototype.getGroupGeometryBBox(n);r&&(this._transformBox=new IFTransformBox(r,i,o)),this.requestInvalidation(),this._transformBox?this._updateTBoxMode(e.TBoxMode.PASSIVE):this._updateTBoxMode(e.TBoxMode.NA),this._tBoxData=null,this._mouseInfo=null,this._visualsArea&&(this._visualsArea=null)},e.prototype._geometryChange=function(t){this._transformBox&&t.type==IFElement.GeometryChangeEvent.Type.After&&t.element.hasFlag(IFNode.Flag.Selected)&&((this._transformBox.trf||this._transformBox.cTrf)&&this._transformBox.applyCenterTransform(),this._updateSelectionTransformBox())},e.prototype._getGraphicEditor=function(){return this._element.__graphic_editor__},e.prototype.toString=function(){return"[Object IFSceneEditor]"},t.IFSceneEditor=e}(this),function(t){function e(t){IFBlockEditor.call(this,t)}IFObject.inherit(e,IFBlockEditor),e.prototype.acceptDrop=function(t,e,i,o){if(!1===IFElementEditor.prototype.acceptDrop.call(this,t,e,i,o)){if(o instanceof IFStyle.HitResult&&o.entry instanceof IFPatternPaint&&i instanceof IFPattern){var n=IFEditor.getEditor(this.getElement().getScene());n.beginTransaction();try{o.entry.setProperty("pat",i)}finally{n.commitTransaction("Drop Pattern")}}return!1}return!0},e.prototype.initialSetup=function(){var t=new IFInlineStyle;t.appendChild(new IFStrokePaint),this.getElement().getStyleSet().appendChild(t)},e.prototype._hasCenterCross=function(){return!1},e.prototype._prePaint=function(t,e){if(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted)){var i=this.getPaintElement(),o=new IFVertexTransformer(i,t);e.canvas.putVertices(new IFVertexPixelAligner(o)),e.canvas.strokeVertices(this.hasFlag(IFElementEditor.Flag.Highlighted)?e.highlightOutlineColor:e.selectionOutlineColor,1)}},e.prototype._postPaint=function(t,e){if(this.hasFlag(IFElementEditor.Flag.Selected)&&this.hasFlag(IFElementEditor.Flag.Detail)&&this._hasCenterCross()){var i=this.getPaintElement(),o=i.getTransform(),n=o||new IFTransform(1,0,0,1,0,0);n=t?n.multiplied(t):n;var r=2*IFElementEditor.OPTIONS.centerCrossSize,s=n.getMatrix();if(Math.abs(s[0])*i.getOrigHalfWidth()>r&&Math.abs(s[3])*i.getOrigHalfHeight()>r){var a=n.mapPoint(i.getCenter(!1)),l=Math.floor(a.getX())+.5,h=Math.floor(a.getY())+.5,p=IFElementEditor.OPTIONS.centerCrossSize/2;e.canvas.strokeLine(l-p,h-p,l+p,h+p,1,e.selectionOutlineColor),e.canvas.strokeLine(l+p,h-p,l-p,h+p,1,e.selectionOutlineColor)}}},e.prototype.toString=function(){return"[Object IFShapeEditor]"},t.IFShapeEditor=e}(this),function(t){function e(t){IFBlockEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFBlockEditor),IFElementEditor.exports(e,IFShapeSet),e.prototype._prePaint=function(t,e){(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(t,e),IFBlockEditor.prototype._prePaint.call(this,t,e)},e.prototype.toString=function(){return"[Object IFShapeSetEditor]"},t.IFShapeSetEditor=e}(this),function(t){function e(t){IFShapeEditor.call(this,t)}IFObject.inherit(e,IFShapeEditor),e.prototype.toString=function(){return"[Object IFPathBaseEditor]"},t.IFPathBaseEditor=e}(this),function(t){function e(t){IFShapeEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFShapeEditor),IFElementEditor.exports(e,IFText),e.prototype._inlineEditor=null,e.prototype.getProperty=function(t,e){if(IFText.GeometryProperties.hasOwnProperty(t))return this.getElement().getProperty(t);if(!this.isInlineEdit())return this.getElement().getContent().getProperty(t);var i=null,o=null,n=rangy.getSelection();if(n.rangeCount)for(var r=n.getRangeAt(0),s=r.collapsed?[r.startContainer]:r.getNodes(),a=0;a<s.length;++a){var l=s[a];if(3===l.nodeType)for(var h=l.parentNode;null!==h;h=h.parentNode)1===h.nodeType&&("p"===h.nodeName.toLowerCase()?i||(i=h):"span"===h.nodeName.toLowerCase()&&(o||r.collapsed||(o=h)))}return IFText.Block.Properties.hasOwnProperty(t)?o?IFText.Block.cssToProperty(t,e?window.getComputedStyle(o):o.style):i?IFText.Block.cssToProperty(t,e?window.getComputedStyle(i):i.style):this.getElement().getContent().getProperty(t):IFText.Paragraph.Properties.hasOwnProperty(t)?i?IFText.Paragraph.cssToProperty(t,e?window.getComputedStyle(i):i.style):this.getElement().getContent().getProperty(t):void 0},e.prototype.setProperties=function(t,e){for(var i=[],o=[],n=[],r=[],s=[],a=[],l=0;l<t.length;++l)IFText.GeometryProperties.hasOwnProperty(t[l])?(i.push(t[l]),o.push(e[l])):IFText.Block.Properties.hasOwnProperty(t[l])?(n.push(t[l]),r.push(e[l])):(s.push(t[l]),a.push(e[l]));if(this.isInlineEdit()?setTimeout(function(){for(var t={},e=0;e<n.length;++e)IFText.Block.propertyToCss(n[e],r[e],t);var i={};for(e=0;e<s.length;++e)IFText.Paragraph.propertyToCss(s[e],a[e],i);this._inlineEditor.focus(),this._savedSelection&&(rangy.restoreSelection(this._savedSelection),this._savedSelection=rangy.saveSelection());var o=rangy.getSelection();if(o.rangeCount){var l=o.getRangeAt(0),h=l.collapsed?[l.startContainer]:l.getNodes();for(e=0;e<h.length;++e){var p=h[e];if(3===p.nodeType)for(var d=p.parentNode;null!==d;d=d.parentNode)if(1===d.nodeType&&"p"===d.nodeName.toLowerCase()){for(var c in i)d.style[c]=i[c];if(o.isCollapsed)for(var c in t)d.style[c]=t[c];break}}}o.isCollapsed,this._triggerSelectionChanged()}.bind(this),0):(this.getElement().getContent().setProperties(n,r),this.getElement().getContent().setProperties(s,a)),i.length>0){var h=this.getElement().getProperty("aw"),p=this.getElement().getProperty("ah");this.getElement().setProperties(i,o);var d=i.indexOf("aw"),c=i.indexOf("ah");if(d>=0||c>=0){var _=!1,g=!1;if(d>=0&&!1===o[d]&&!0===h&&(g=!0),c>=0&&!1===o[c]&&!0===p&&(_=!0),g||_){var u=this.getElement().getGeometryBBox(),f=this.getElement().getContentBBox();if(u&&f){var P=(new IFTransform).translated(-u.getX(),-u.getY()).scaled(g?f.getWidth()/u.getWidth():1,_?f.getHeight()/u.getHeight():1).translated(u.getX(),u.getY());this.getElement().transform(P)}}}}},e.prototype.initialSetup=function(){var t=new IFInlineStyle;t.appendChild(new IFFillPaint),this.getElement().getStyleSet().appendChild(t)},e.prototype.canInlineEdit=function(){return!0},e.prototype.isInlineEdit=function(){return null!==this._inlineEditor},e.prototype.beginInlineEdit=function(t,e){this.removeFlag(IFBlockEditor.Flag.ResizeAll),this.getElement().setFlag(IFElement.Flag.NoPaint);var i=this.getElement().asHtml();if(this._inlineEditor=$($("<div></div>")).css(this.getElement().getContent().propertiesToCss({})).css({position:"absolute",background:"transparent","transform-origin":"0% 0%","-webkit-transform-origin":"0% 0%","min-width":"1em","min-height":"1em"}).attr("contenteditable","true").on("mousedown",function(t){t.stopPropagation()}).on("mouseup",function(t){t.stopPropagation(),this._savedSelection&&rangy.removeMarkers(this._savedSelection),this._savedSelection=rangy.saveSelection(),this._activeParagraphElement=null;var e=rangy.getSelection();if(e.rangeCount)for(var i=e.getRangeAt(0),o=i.collapsed?[i.endContainer]:i.getNodes(),n=0;n<o.length;++n){var r=o[n];if(3===r.nodeType){for(var s=null,a=r.parentNode;null!==a;a=a.parentNode)if(1===a.nodeType&&"p"===a.nodeName.toLowerCase()){s=a;break}s&&(this._activeParagraphElement=s)}}this._triggerSelectionChanged()}.bind(this)).on("click",function(t){t.stopPropagation()}).on("dblclick",function(t){t.stopPropagation()}).on("keydown",function(t){t.stopPropagation()}).on("keyup",function(t){t.stopPropagation(),this._savedSelection&&rangy.removeMarkers(this._savedSelection),this._savedSelection=rangy.saveSelection()}.bind(this)).html(i).appendTo(e),this._inlineEditor.focus(),""===i){var o=document.createElement("p");$(o).text("Your Text Here"),this._inlineEditor.append(o);var n=rangy.createRange();n.selectNodeContents(o),rangy.getSelection().setSingleRange(n)}},e.prototype.adjustInlineEditForView=function(t,e){var i=this.getElement().getGeometryBBox();if(!i){i=IFRect.fromPoints(new IFPoint(0,0),new IFPoint(1,1));var o=this.getElement().getTransform();o&&(i=o.mapRect(i))}var n=t.getWorldTransform().mapRect(i),r=n.getX(),s=Math.floor(n.getY())+1,a="",l="";!1===this.getElement().getProperty("aw")&&i.getWidth()>0&&(a=i.getWidth()+"px"),!1===this.getElement().getProperty("ah")&&i.getHeight()>0&&(l=i.getHeight()+"px"),this._inlineEditor.css({width:a,height:l,transform:"scale("+t.getZoom()+")","-webkit-transform":"scale("+t.getZoom()+")"}).offset({top:s,left:r}),e&&this.createSelectionFromPosition(e)},e.prototype.createSelectionFromPosition=function(t,e){var i=document,o=null;if(void 0!==i.caretPositionFromPoint){o=i.createRange();var n=i.caretPositionFromPoint(t.getX(),t.getY());if(o.setStart(n.offsetNode,n.offset),e){var r=i.caretPositionFromPoint(e.getX(),e.getY());o.setEnd(r.offsetNode,r.offset)}}else if(void 0!==i.caretRangeFromPoint){o=i.createRange();n=i.caretRangeFromPoint(t.getX(),t.getY());if(o.setStart(n.startContainer,n.startOffset),e){r=i.caretRangeFromPoint(endX,endY);o.setEnd(e.getX(),e.getY())}}if(null!==o&&void 0!==window.getSelection){var s=window.getSelection();s.removeAllRanges(),s.addRange(o)}else if(void 0!==i.body.createTextRange){if((o=i.body.createTextRange()).moveToPoint(t.getX(),t.getY()),e){var a=o.duplicate();a.moveToPoint(e.getX(),e.getY()),o.setEndPoint("EndToEnd",a)}o.select()}},e.prototype.finishInlineEdit=function(){this._savedSelection&&(rangy.removeMarkers(this._savedSelection),this._savedSelection=null);var t=this._inlineEditor.html();return this.getElement().fromHtml(t),this._inlineEditor.remove(),this._inlineEditor=null,this.setFlag(IFBlockEditor.Flag.ResizeAll),this.getElement().removeFlag(IFElement.Flag.NoPaint),"Modify Text Content"},e.prototype._prePaint=function(t,e){if((this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted))&&!this.isInlineEdit()){var i=this._element.getGeometryBBox();if(i){var o=t.mapRect(i),n=Math.floor(o.getX()),r=Math.floor(o.getY()),s=Math.ceil(o.getX()+o.getWidth())-n,a=Math.ceil(o.getY()+o.getHeight())-r;e.canvas.strokeRect(n+.5,r+.5,s,a,1,this.hasFlag(IFElementEditor.Flag.Highlighted)?e.highlightOutlineColor:e.selectionOutlineColor)}}},e.prototype._triggerSelectionChanged=function(){var t=IFEditor.getEditor(this.getElement().getScene());t.hasEventListeners(IFEditor.InlineEditorEvent)&&t.trigger(new IFEditor.InlineEditorEvent(this,IFEditor.InlineEditorEvent.Type.SelectionChanged))},e.prototype.toString=function(){return"[Object IFTextEditor]"},t.IFTextEditor=e}(this),function(t){function e(t){IFPathBaseEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFPathBaseEditor),IFElementEditor.exports(e,IFEllipse),e.START_ANGLE_PART_ID=ifUtil.uuid(),e.END_ANGLE_PART_ID=ifUtil.uuid(),e.prototype.getBBoxMargin=function(){var t=IFPathBaseEditor.prototype.getBBoxMargin.call(this);return this._showSegmentDetails()?Math.max(IFElementEditor.OPTIONS.annotationSizeRegular+1,t):t},e.prototype.getCustomBBox=function(t,e){var i=null;if(this.hasFlag(IFElementEditor.Flag.Selected)&&this.hasFlag(IFElementEditor.Flag.Detail)){var o=t;e&&this._transform&&(o=this._transform.multiplied(t));var n=this.getPaintElement().getCenter(!0);i=ifAnnotation.getAnnotationBBox(o,n,2*IFElementEditor.OPTIONS.centerCrossSize)}return i},e.prototype.movePart=function(t,i,o,n,r,s,a){if(IFPathBaseEditor.prototype.movePart.call(this,t,i,o,n,r,s,a),t===e.START_ANGLE_PART_ID||t===e.END_ANGLE_PART_ID){var l=n.mapPoint(o);this._elementPreview||(this._elementPreview=new IFEllipse,this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFEllipse.GeometryProperties],!0));var h=this._element.getTransform();if(h)var p=h.inverted().mapPoint(l);else p=l;var d=Math.atan2(p.getY(),p.getX()),c=this._element.getProperty("sa"),_=this._element.getProperty("ea");if(t==e.START_ANGLE_PART_ID)var g=d-c;else g=d-_;var u=this._partSelection.indexOf(e.START_ANGLE_PART_ID)>=0,f=this._partSelection.indexOf(e.END_ANGLE_PART_ID)>=0;(u||f)&&(this._elementPreview.setProperties(["sa","ea"],[u?ifMath.normalizeAngleRadians(c+g):c,f?ifMath.normalizeAngleRadians(_+g):_]),this.requestInvalidation())}},e.prototype.applyPartMove=function(t,i){if(t===e.START_ANGLE_PART_ID||t===e.END_ANGLE_PART_ID){var o=this._elementPreview.getProperties(["sa","ea"]);this.resetPartMove(t,i),this._element.setProperties(["sa","ea"],o)}IFPathBaseEditor.prototype.applyPartMove.call(this,t,i)},e.prototype.applyTransform=function(t){t&&this._elementPreview?(t.transferProperties(this._elementPreview,[IFShape.GeometryProperties,IFEllipse.GeometryProperties]),this.resetTransform()):IFPathBaseEditor.prototype.applyTransform.call(this,t)},e.prototype._hasCenterCross=function(){return!0},e.prototype._postPaint=function(t,i){IFPathBaseEditor.prototype._postPaint.call(this,t,i),this._showSegmentDetails()&&this._iterateArcEnds(!0,function(o){var n=o.id==e.START_ANGLE_PART_ID?IFElementEditor.Annotation.Diamond:IFElementEditor.Annotation.Circle,r=this._partSelection&&this._partSelection.indexOf(o.id)>=0;return this._paintAnnotation(i,t,o.position,n,r,!1),!1}.bind(this))},e.prototype._getPartInfoAt=function(t,e,i){return this._showSegmentDetails()&&(result=null,this._iterateArcEnds(!1,function(o){return!!this._getAnnotationBBox(e,o.position).expanded(i,i,i,i).containsPoint(t)&&(result=new IFElementEditor.PartInfo(this,o.id,null,!0,!0),!0)}.bind(this)),result)?result:IFShapeEditor.prototype._getPartInfoAt.call(this,t,e,i)},e.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(IFElementEditor.Flag.Detail)&&!this._elementPreview},e.prototype._iterateArcEnds=function(t,i){var o=t?this.getPaintElement():this._element,n=o.getTransform(),r=o.getProperty("sa"),s=o.getProperty("ea");n=n||new IFTransform(1,0,0,1,0,0);for(var a=[{id:e.START_ANGLE_PART_ID,position:n.mapPoint(new IFPoint(Math.cos(r),Math.sin(r)))},{id:e.END_ANGLE_PART_ID,position:n.mapPoint(new IFPoint(Math.cos(s),Math.sin(s)))}],l=0;l<a.length&&!0!==i(a[l]);++l);},e.prototype.toString=function(){return"[Object IFEllipseEditor]"},t.IFEllipseEditor=e}(this),function(t){function e(t){IFPathBaseEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFPathBaseEditor),IFElementEditor.exports(e,IFRectangle),e.LEFT_SHOULDER_PART_ID=ifUtil.uuid(),e.RIGHT_SHOULDER_PART_ID=ifUtil.uuid(),e.ANY_SHOULDER_PART_ID=ifUtil.uuid(),IFEllipseEditor.prototype.getBBoxMargin=function(){var t=IFPathBaseEditor.prototype.getBBoxMargin.call(this);return this._showSegmentDetails()?Math.max(IFElementEditor.OPTIONS.annotationSizeRegular+1,t):t},e.prototype.movePart=function(t,i,o,n,r,s,a){if(IFPathBaseEditor.prototype.movePart.call(this,t,i,o,n,r,s,a),t.id===e.LEFT_SHOULDER_PART_ID||t.id===e.RIGHT_SHOULDER_PART_ID||t.id===e.ANY_SHOULDER_PART_ID){var l=n.mapPoint(o);this._elementPreview||(this._elementPreview=new IFRectangle,this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFRectangle.GeometryProperties],!0));var h=this._element.getTransform(),p=new IFPoint(t.ap.getProperty("x"),t.ap.getProperty("y"));h&&(p=h.mapPoint(p));var d,c=null,_=null;if(t.id==e.LEFT_SHOULDER_PART_ID||t.id===e.ANY_SHOULDER_PART_ID){var g=this._element.getAnchorPoints().getPreviousPoint(t.ap),u=new IFPoint(g.getProperty("x"),g.getProperty("y"));u=h?h.mapPoint(u):u;var f=ifMath.getVectorProjection(p.getX(),p.getY(),u.getX(),u.getY(),l.getX(),l.getY(),!0);c=ifMath.ptDist(f.getX(),f.getY(),p.getX(),p.getY())}if(t.id===e.RIGHT_SHOULDER_PART_ID||t.id===e.ANY_SHOULDER_PART_ID){g=this._element.getAnchorPoints().getNextPoint(t.ap);var P=new IFPoint(g.getProperty("x"),g.getProperty("y"));P=h?h.mapPoint(P):P;var m=ifMath.getVectorProjection(p.getX(),p.getY(),P.getX(),P.getY(),l.getX(),l.getY(),!0);_=ifMath.ptDist(m.getX(),m.getY(),p.getX(),p.getY())}d=null!==_&&null!==c?_>c?_:c:null!==_?_:c;this.getPaintElement();var I=IFRectangle.getGeometryPropertiesSidePrefix(t.side);s?this.getPaintElement().setProperties([I+"_sx",I+"_sy"],[d,d]):t.id==e.LEFT_SHOULDER_PART_ID||t.id===e.ANY_SHOULDER_PART_ID&&d==c?this.getPaintElement().setProperty(I+"_sx",d):this.getPaintElement().setProperty(I+"_sy",d),this.requestInvalidation()}},e.prototype.applyPartMove=function(t,i){t.id!==e.LEFT_SHOULDER_PART_ID&&t.id!==e.RIGHT_SHOULDER_PART_ID&&t.id!==e.ANY_SHOULDER_PART_ID||this._element.transferProperties(this._elementPreview,[IFRectangle.GeometryProperties]),IFPathBaseEditor.prototype.applyPartMove.call(this,t,i)},e.prototype.applyTransform=function(t){t&&this._elementPreview?(t.transferProperties(this._elementPreview,[IFShape.GeometryProperties,IFRectangle.GeometryProperties]),this.resetTransform()):IFPathBaseEditor.prototype.applyTransform.call(this,t)},e.prototype._hasCenterCross=function(){return!0},e.prototype._postPaint=function(t,i){IFPathBaseEditor.prototype._postPaint.call(this,t,i),this._showSegmentDetails()&&this.getPaintElement().iterateSegments(function(o,n,r,s,a,l){var h=this.getPaintElement(),p={id:e.LEFT_SHOULDER_PART_ID,side:n},d={id:e.RIGHT_SHOULDER_PART_ID,side:n},c={id:e.ANY_SHOULDER_PART_ID,side:n};if(0!=s||0!=a){var _=h.getAnchorPoints().getChildByIndex(l),g=h.getTransform(),u=g?_.getLeftShoulderPointTransformed(g,!0):_.getLeftShoulderPoint(!0);u||(u=new IFPoint(_.getProperty("x"),_.getProperty("y")),u=g?g.mapPoint(u):u),this._paintAnnotation(i,t,u,IFElementEditor.Annotation.Diamond,this.isPartSelected(p),!1);var f=g?_.getRightShoulderPointTransformed(g,!0):_.getRightShoulderPoint(!0);f||(f=new IFPoint(_.getProperty("x"),_.getProperty("y")),f=g?g.mapPoint(f):f),this._paintAnnotation(i,t,f,IFElementEditor.Annotation.Diamond,this.isPartSelected(d),!1)}else this._paintAnnotation(i,t,o,IFElementEditor.Annotation.Diamond,this.isPartSelected(p)||this.isPartSelected(d)||this.isPartSelected(c),!1)}.bind(this),!0)},e.prototype._partIdAreEqual=function(t,e){var i=t===e||t.id===e.id;return i&&t.id&&(i=t.side===e.side),i},e.prototype._getPartInfoAt=function(t,i,o){if(this._showSegmentDetails()){var n=null;if(this.getPaintElement().iterateSegments(function(r,s,a,l,h,p){var d=this.getPaintElement(),c=d.getAnchorPoints().getChildByIndex(p);if(0!=l||0!=h){var _=d.getTransform(),g=_?c.getLeftShoulderPointTransformed(_,!0):c.getLeftShoulderPoint(!0);if(g||(g=new IFPoint(c.getProperty("x"),c.getProperty("y")),g=_?_.mapPoint(g):g),this._getAnnotationBBox(i,g).expanded(o,o,o,o).containsPoint(t))return n=new IFElementEditor.PartInfo(this,{id:e.LEFT_SHOULDER_PART_ID,side:s,ap:c,point:g},null,!0,!0),!0;var u=_?c.getRightShoulderPointTransformed(_,!0):c.getRightShoulderPoint(!0);if(u||(u=new IFPoint(c.getProperty("x"),c.getProperty("y")),u=_?_.mapPoint(u):u),this._getAnnotationBBox(i,u).expanded(o,o,o,o).containsPoint(t))return n=new IFElementEditor.PartInfo(this,{id:e.RIGHT_SHOULDER_PART_ID,side:s,ap:c,point:u},null,!0,!0),!0}else if(this._getAnnotationBBox(i,r,!0).expanded(o,o,o,o).containsPoint(t))return n=new IFElementEditor.PartInfo(this,{id:e.ANY_SHOULDER_PART_ID,side:s,ap:c,point:r},null,!0,!0),!0}.bind(this),!0),n)return n}return IFPathBaseEditor.prototype._getPartInfoAt.call(this,t,i,o)},e.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(IFElementEditor.Flag.Detail)&&!this._elementPreview},e.prototype.toString=function(){return"[Object IFRectangleEditor]"},t.IFRectangleEditor=e}(this),function(t){function e(t){IFPathBaseEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFPathBaseEditor),IFElementEditor.exports(e,IFPolygon),e.INSIDE_PART_ID=ifUtil.uuid(),e.OUTSIDE_PART_ID=ifUtil.uuid(),e.prototype.getBBoxMargin=function(){return IFPathBaseEditor.prototype.getBBoxMargin.call(this)},e.prototype.getCustomBBox=function(t,e){var i=null;if(this._showSegmentDetails()){var o=t;e&&this._transform&&(o=this._transform.multiplied(t));this.getPaintElement().iterateSegments(function(t,e,n){var r;(r=this._getAnnotationBBox(o,t))&&!r.isEmpty()&&(i=i?i.united(r):r)}.bind(this),!0)}return i},e.prototype.movePart=function(t,i,o,n,r,s,a){if(IFPathBaseEditor.prototype.movePart.call(this,t,i,o,n,r,s,a),t===e.INSIDE_PART_ID||t===e.OUTSIDE_PART_ID){var l=n.mapPoint(o);l=r.mapPoint(l);var h=this._element.getProperty("trf");h&&(l=h.inverted().mapPoint(l)),this._elementPreview||(this._elementPreview=new IFPolygon,this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFPolygon.GeometryProperties],!0));var p=this._element.getCenter(!1),d=Math.atan2(l.getY()-p.getY(),l.getX()-p.getX())-i,c=ifMath.ptDist(l.getX(),l.getY(),p.getX(),p.getY()),_=this._element.getProperty("oa"),g=this._element.getProperty("or"),u=this._element.getProperty("ia"),f=this._element.getProperty("ir"),P=u,m=f,I=_,v=g,y=this._partSelection.indexOf(e.INSIDE_PART_ID)>=0,E=this._partSelection.indexOf(e.OUTSIDE_PART_ID)>=0;if(1==this._partSelection.length)y&&(s||(P=ifMath.normalizeAngleRadians(d+u)),m=c),E&&(s||(I=ifMath.normalizeAngleRadians(d+_)),v=c);else if(y&&E)if(t==e.INSIDE_PART_ID){s||(P=ifMath.normalizeAngleRadians(d+u));var F=(m=c)*Math.cos(P)-f*Math.cos(u),T=m*Math.sin(P)-f*Math.sin(u),S=new IFPoint(g*Math.cos(_)+F,g*Math.sin(_)+T);I=Math.atan2(S.getY(),S.getX()),v=ifMath.ptDist(S.getX(),S.getY(),0,0)}else if(t==e.OUTSIDE_PART_ID){s||(I=ifMath.normalizeAngleRadians(d+_));F=(v=c)*Math.cos(I)-g*Math.cos(_),T=v*Math.sin(I)-g*Math.sin(_);var M=new IFPoint(f*Math.cos(u)+F,f*Math.sin(u)+T);P=Math.atan2(M.getY(),M.getX()),m=ifMath.ptDist(M.getX(),M.getY(),0,0)}this._elementPreview.setProperties(["oa","or","ia","ir"],[I,v,P,m]),this.requestInvalidation()}},e.prototype.applyPartMove=function(t,i){if(t===e.INSIDE_PART_ID||t===e.OUTSIDE_PART_ID){var o=this._elementPreview.getProperties(["oa","or","ia","ir"]);this.resetPartMove(t,i),this._element.setProperties(["oa","or","ia","ir"],o)}IFPathBaseEditor.prototype.applyPartMove.call(this,t,i)},e.prototype.applyTransform=function(t){t&&this._elementPreview?(t.transferProperties(this._elementPreview,[IFShape.GeometryProperties,IFPolygon.GeometryProperties]),this.resetTransform()):IFPathBaseEditor.prototype.applyTransform.call(this,t)},e.prototype._hasCenterCross=function(){return!0},e.prototype._postPaint=function(t,i){(IFPathBaseEditor.prototype._postPaint.call(this,t,i),this._showSegmentDetails())&&this.getPaintElement().iterateSegments(function(o,n,r){var s=n?IFElementEditor.Annotation.Circle:IFElementEditor.Annotation.Diamond,a=n?e.INSIDE_PART_ID:e.OUTSIDE_PART_ID;this._paintAnnotation(i,t,o,s,this._partSelection&&this._partSelection.indexOf(a)>=0,!1)}.bind(this),!0)},e.prototype._getPartInfoAt=function(t,i,o){if(this._showSegmentDetails()){var n=null;if(this._element.iterateSegments(function(r,s,a){if(this._getAnnotationBBox(i,r).expanded(o,o,o,o).containsPoint(t)){var l=s?e.INSIDE_PART_ID:e.OUTSIDE_PART_ID;return n=new IFElementEditor.PartInfo(this,l,a,!0,!0),!0}}.bind(this),!0),n)return n}return IFShapeEditor.prototype._getPartInfoAt.call(this,t,i,o)},e.prototype._showSegmentDetails=function(){return this._showAnnotations()&&this.hasFlag(IFElementEditor.Flag.Detail)&&!this._elementPreview},e.prototype.toString=function(){return"[Object IFPolygonEditor]"},t.IFPolygonEditor=e}(this),function(t){function e(t){IFPathBaseEditor.call(this,t);for(var i=t.getAnchorPoints().queryAll(":selected"),o=0;o<i.length;++o)this._partSelection||(this._partSelection=[]),this._partSelection.push({type:e.PartType.Point,point:i[o]})}IFObject.inherit(e,IFPathBaseEditor),IFElementEditor.exports(e,IFPath),e.PartType={Segment:1,Point:2,LeftHandle:3,RightHandle:4,LeftShoulder:5,RightShoulder:6},e.SegmentData={HitRes:1,Handles:2},e.prototype._sourceIndexToPreviewIndex=null,e.prototype._activeExtedingMode=!1,e.prototype.isActiveExtendingMode=function(){return this._activeExtedingMode},e.prototype.setActiveExtendingMode=function(t){this._activeExtedingMode=t},e.prototype.getBBox=function(t){var e=IFPathBaseEditor.prototype.getBBox.call(this,t);if(this._showAnnotations()){this._transform&&(t=this._transform.multiplied(t));var i=function(t){t&&!t.isEmpty()&&(e=e?e.united(t):t)};return this._iteratePoints(!0,function(e){e.leftHandlePosition&&i(this._getAnnotationBBox(t,e.leftHandlePosition,!0)),e.rightHandlePosition&&i(this._getAnnotationBBox(t,e.rightHandlePosition,!0)),e.leftShoulderPosition&&i(this._getAnnotationBBox(t,e.leftShoulderPosition,!0)),e.rightShoulderPosition&&i(this._getAnnotationBBox(t,e.rightShoulderPosition,!0)),i(this._getAnnotationBBox(t,e.position,!0))}.bind(this)),e}return e},e.prototype.movePart=function(t,i,o,n,r,s,a){switch(this.requestInvalidation(),this._createPathPreviewIfNecessary(t.point),t.type){case e.PartType.LeftHandle:this._movePreviewPointCoordinates(t.point,"hlx","hly",o,n,s,r);break;case e.PartType.RightHandle:this._movePreviewPointCoordinates(t.point,"hrx","hry",o,n,s,r);break;case e.PartType.LeftShoulder:case e.PartType.RightShoulder:var l=n.mapPoint(o);this._movePreviewPointShoulders(t,l,s)}this.requestInvalidation()},e.prototype.resetPartMove=function(t,e){this.releasePathPreview(),this.requestInvalidation()},e.prototype.applyPartMove=function(t,i){switch(t.type){case e.PartType.LeftHandle:this._assignPreviewPointPropertiesToSourcePoint(t.point,["hlx","hly","ah"]);break;case e.PartType.RightHandle:this._assignPreviewPointPropertiesToSourcePoint(t.point,["hrx","hry","ah"]);break;case e.PartType.LeftShoulder:case e.PartType.RightShoulder:this._assignPreviewPointPropertiesToSourcePoint(t.point,["cl","cr"])}this.resetPartMove(t,i)},e.prototype.transform=function(t,i,o){if(this._partSelection&&this._partSelection.length>0){this.requestInvalidation(),this._createPathPreviewIfNecessary();for(var n=0;n<this._partSelection.length;++n){var r=this._partSelection[n];if(r.type===e.PartType.Point){var s=r.point;this._transformPreviewPointCoordinates(s,"x","y",t),s.getProperty("ah")||(null!=s.getProperty("hlx")&&null!=s.getProperty("hly")&&this._transformPreviewPointCoordinates(s,"hlx","hly",t),null!=s.getProperty("hrx")&&null!=s.getProperty("hry")&&this._transformPreviewPointCoordinates(s,"hrx","hry",t))}else if(r.type===e.PartType.Segment&&i&&this._partIdAreEqual(r,i)&&o.type==e.SegmentData.Handles){var a=this.getPathPointPreview(r.apLeft),l=this.getPathPointPreview(r.apRight),h=t.getTranslation(),p=new IFPoint(a.getProperty("x"),a.getProperty("y")),d=new IFPoint(l.getProperty("x"),l.getProperty("y"));if(o.fixedHDirLpt||o.fixedHDirRpt)if(o.fixedHDirLpt&&o.fixedHDirRpt){var c=h.getX(),_=h.getY(),g=ifMath.getVectorProjection(p.getX(),p.getY(),o.apLhr.getX(),o.apLhr.getY(),p.getX()+c,p.getY()+_).subtract(p);v=t.translated(-h.getX()+g.getX()*o.cL,-h.getY()+g.getY()*o.cL);this._transformPreviewPointCoordinates(r.apLeft,"hrx","hry",v,o.apLhr);g=ifMath.getVectorProjection(d.getX(),d.getY(),o.apRhl.getX(),o.apRhl.getY(),d.getX()+c,d.getY()+_).subtract(d),v=t.translated(-h.getX()+g.getX()*o.cR,-h.getY()+g.getY()*o.cR);this._transformPreviewPointCoordinates(r.apRight,"hlx","hly",v,o.apRhl)}else{c=h.getX(),_=h.getY();var u=1/(o.cL+o.cR);if(o.fixedHDirLpt&&!o.fixedHDirRpt)var f=u*(g=ifMath.getVectorProjection(p.getX(),p.getY(),o.apLhr.getX(),o.apLhr.getY(),p.getX()+c,p.getY()+_).subtract(p)).getX(),P=u*g.getY(),m=c/o.cR-o.cL/o.cR*f,I=_/o.cR-o.cL/o.cR*P;else m=u*(g=ifMath.getVectorProjection(d.getX(),d.getY(),o.apRhl.getX(),o.apRhl.getY(),d.getX()+c,d.getY()+_).subtract(d)).getX(),I=u*g.getY(),f=c/o.cL-o.cR/o.cL*m,P=_/o.cL-o.cR/o.cL*I;v=t.translated(-h.getX()+f,-h.getY()+P);this._transformPreviewPointCoordinates(r.apLeft,"hrx","hry",v,o.apLhr);v=t.translated(-h.getX()+m,-h.getY()+I);this._transformPreviewPointCoordinates(r.apRight,"hlx","hly",v,o.apRhl)}else{var v=t.translated(-h.getX()+h.getX()*o.cL,-h.getY()+h.getY()*o.cL);this._transformPreviewPointCoordinates(r.apLeft,"hrx","hry",v,o.apLhr);var v=t.translated(-h.getX()+h.getX()*o.cR,-h.getY()+h.getY()*o.cR);this._transformPreviewPointCoordinates(r.apRight,"hlx","hly",v,o.apRhl)}}}this.requestInvalidation()}else IFPathBaseEditor.prototype.transform.call(this,t,i,o)},e.prototype.resetTransform=function(){this.releasePathPreview(),IFPathBaseEditor.prototype.resetTransform.call(this)},e.prototype.canApplyTransform=function(){return this._partSelection&&this._partSelection.length>0||this._transform&&!this._transform.isIdentity()},e.prototype.applyTransform=function(t){if(this._partSelection&&this._partSelection.length>0){this._element._beginBlockEvents([IFElement.GeometryChangeEvent]);for(var i=[],o=0;o<this._partSelection.length;++o){var n=this._partSelection[o];n.type===e.PartType.Point?(o==this._partSelection.length-1&&this._element._endBlockEvents([IFElement.GeometryChangeEvent]),this._transferPreviewProperties(n.point,t),i.push(n)):n.type===e.PartType.Segment&&(this._transferPreviewProperties(n.apLeft,t),o==this._partSelection.length-1&&this._element._endBlockEvents([IFElement.GeometryChangeEvent]),this._transferPreviewProperties(n.apRight,t),i.push({type:e.PartType.Point,point:n.apLeft}),i.push({type:e.PartType.Point,point:n.apRight}))}this.requestInvalidation(),this.resetTransform(),this.updatePartSelection(!1,i)}else IFPathBaseEditor.prototype.applyTransform.call(this,t)},e.prototype.subSelectDragStartAction=function(t){if(t.editor!==this)return null;var i=t;if(t.isolated||t.id.type!=e.PartType.Point){if(t.id.type==e.PartType.Segment){var o=t.data.hitRes,n=t.id.apLeft,r=t.id.apRight;if(n&&r){this.requestInvalidation(),this._createPathPreviewIfNecessary();var s=this.getPathPointPreview(n),a=this.getPathPointPreview(r);if(s&&a){var l=n.getProperty("x"),h=n.getProperty("y"),p=r.getProperty("x"),d=r.getProperty("y");if(null!==n.getProperty("hrx")&&null!==n.getProperty("hry")||null!==r.getProperty("hlx")&&null!==r.getProperty("hly"))if(null===n.getProperty("hrx")||null===n.getProperty("hry")){m=l+2/3*((v=a.getProperty("hlx"))-l),I=h+2/3*((y=a.getProperty("hly"))-h);v=p+2/3*(v-p),y=d+2/3*(y-d),s.setProperties(["ah","hrx","hry"],[!1,m,I]),a.setProperties(["ah","hlx","hly"],[!1,v,y]),this.requestInvalidation(),i=new IFElementEditor.PartInfo(this,{type:e.PartType.Segment,point:null,apLeft:n,apRight:r},{type:e.SegmentData.Handles,cL:3*(1-o.slope)*(1-o.slope)*o.slope,apLhr:new IFPoint(m,I),fixedHDirLpt:!1,cR:3*o.slope*o.slope*(1-o.slope),apRhl:new IFPoint(v,y),fixedHDirRpt:!0},!1,!0)}else if(null===r.getProperty("hlx")||null===r.getProperty("hly")){v=p+2/3*((m=s.getProperty("hrx"))-p),y=d+2/3*((I=s.getProperty("hry"))-d);m=l+2/3*(m-l),I=h+2/3*(I-h),s.setProperties(["ah","hrx","hry"],[!1,m,I]),a.setProperties(["ah","hlx","hly"],[!1,v,y]),this.requestInvalidation(),i=new IFElementEditor.PartInfo(this,{type:e.PartType.Segment,point:null,apLeft:n,apRight:r},{type:e.SegmentData.Handles,cL:3*(1-o.slope)*(1-o.slope)*o.slope,apLhr:new IFPoint(m,I),fixedHDirLpt:!0,cR:3*o.slope*o.slope*(1-o.slope),apRhl:new IFPoint(v,y),fixedHDirRpt:!1},!1,!0)}else{s.setProperty("ah",!1),a.setProperty("ah",!1),this.requestInvalidation();m=s.getProperty("hrx"),I=s.getProperty("hry"),v=a.getProperty("hlx"),y=a.getProperty("hly");i=new IFElementEditor.PartInfo(this,{type:e.PartType.Segment,point:null,apLeft:n,apRight:r},{type:e.SegmentData.Handles,cL:3*(1-o.slope),apLhr:new IFPoint(m,I),fixedHDirLpt:!0,cR:3*o.slope,apRhl:new IFPoint(v,y),fixedHDirRpt:!0},!1,!0)}else{var c=(p-l)/3,_=(d-h)/3,g=c*o.slope,u=c-g,f=_*o.slope,P=_-f,m=o.x-g,I=o.y-f;s.setProperties(["ah","hrx","hry"],[!1,o.x-g,o.y-f]);var v=o.x+u,y=o.y+P;a.setProperties(["ah","hlx","hly"],[!1,o.x+u,o.y+P]),this.requestInvalidation(),i=new IFElementEditor.PartInfo(this,{type:e.PartType.Segment,point:null,apLeft:n,apRight:r},{type:e.SegmentData.Handles,cL:4/3,apLhr:new IFPoint(m,I),fixedHDirLpt:!1,cR:4/3,apRhl:new IFPoint(v,y),fixedHDirRpt:!1},null,!1,!0)}}else i=null}else i=null}}else{var E=t.id.point,F=e.PartType.Point,T=E.getProperty("tp");if(IFPathBase.isCornerType(T)&&null!=this._element.getAnchorPoints().getPreviousPoint(E)&&null!=this._element.getAnchorPoints().getNextPoint(E)){var S=E.getProperty("cl"),M=E.getProperty("cr"),A=this._element.getScene().getProperty("pickDist");null==M||M<2*A?F=e.PartType.RightShoulder:(null==S||S<2*A)&&(F=e.PartType.LeftShoulder)}if(F!=e.PartType.Point){if(S=null!=S?S:A,M=null!=M?M:A,this.requestInvalidation(),this._createPathPreviewIfNecessary(E),C=this.getPathPointPreview(E)){C.setProperties(["cl","cr"],[S,M]);var x=!0,w=!1;i=new IFElementEditor.PartInfo(this,{type:F,point:E},null,x,w)}else i=null}else{var v=E.getProperty("hlx"),y=E.getProperty("hly"),m=E.getProperty("hrx"),I=E.getProperty("hry");if(t.data.apSelected&&E.hasFlag(IFNode.Flag.Selected)){if(null===v||null===y||null===m||null===I){var C;if(this.requestInvalidation(),this._createPathPreviewIfNecessary(E),C=this.getPathPointPreview(E)){var R=null;x=!0,w=!1;null===m||null===I?(R=e.PartType.RightHandle,C.setProperties(["ah","hrx","hry"],[!1,E.getProperty("x"),E.getProperty("y")])):(R=e.PartType.LeftHandle,C.setProperties(["ah","hlx","hly"],[!1,E.getProperty("x"),E.getProperty("y")])),i=new IFElementEditor.PartInfo(this,{type:R,point:E},{apSelected:!0},x,w),this.updatePartSelection(!0,[i.id])}else i=null}}else E.hasFlag(IFNode.Flag.Selected)||this.selectOnePoint(E),i=new IFElementEditor.PartInfo(this,{type:e.PartType.Point,point:E},{apSelected:!0},x,w)}}return i},e.prototype._attach=function(){var t=this._element.getScene();null!=t&&t.addEventListener(IFElement.GeometryChangeEvent,this._geometryChange,this)},e.prototype._detach=function(){for(var t=this._element.getAnchorPoints().getFirstChild();null!=t;t=t.getNext())t.removeFlag(IFNode.Flag.Selected);var e=this._element.getScene();null!=e&&e.removeEventListener(IFElement.GeometryChangeEvent,this._geometryChange),IFPathBaseEditor.prototype._detach.call(this)},e.prototype.hitAnchorPoint=function(t,e,i,o){if(t){var n=this._element.getTransform();return i&&(n=n?n.multiplied(i):i),this._getAnnotationBBox(n,new IFPoint(t.getProperty("x"),t.getProperty("y")),!0).expanded(o,o,o,o).containsPoint(e)}return!1},e.prototype.getPointCoord=function(t){var e=null;if(t.getPath()==this._element||this._elementPreview&&t.getPath()==this._elementPreview){var i=this._element;this._elementPreview&&t.getPath()==this._elementPreview&&(i=this._elementPreview);var o=t.getProperty("x"),n=t.getProperty("y");e=new IFPoint(o,n);var r=i.getTransform();r&&(e=r.mapPoint(e))}return e},e.prototype._getPartInfoAt=function(t,i,o){if(this._showAnnotations()){var n=function(e,n){return!!e&&this._getAnnotationBBox(i,e,n).expanded(o,o,o,o).containsPoint(t)}.bind(this),r=null;if(this._iteratePoints(!1,function(t){var i=null,o=!0,s=!1;if(n(t.rightHandlePosition,!0)?i=e.PartType.RightHandle:n(t.leftHandlePosition,!0)?i=e.PartType.LeftHandle:n(t.rightShoulderPosition,!0)?i=e.PartType.RightShoulder:n(t.leftShoulderPosition,!0)?i=e.PartType.LeftShoulder:n(t.position,!0)&&(i=e.PartType.Point,o=!1,s=!0),i)return r=new IFElementEditor.PartInfo(this,{type:i,point:t.anchorPoint},{apSelected:t.anchorPoint.hasFlag(IFNode.Flag.Selected)},o,s),!0}.bind(this)),r)return r;if(this.hasFlag(IFElementEditor.Flag.Detail)){var s=this._element.pathHitTest(t,i,!1,this._element.getScene().getProperty("pickDist"));if(s){var a=s.data,l=this._element.getAnchorPoints().getChildByIndex(a.segment-1),h=l?this._element.getAnchorPoints().getNextPoint(l):null;return new IFElementEditor.PartInfo(this,{type:e.PartType.Segment,point:null,apLeft:l,apRight:h},{type:e.SegmentData.HitRes,hitRes:s.data},!1,!0)}return null}}return null},e.prototype._postPaint=function(t,e){IFPathBaseEditor.prototype._postPaint.call(this,t,e),this._showAnnotations()&&this._iteratePoints(!0,function(i){i.leftHandlePosition&&this._paintHandle(t,e,i.position,i.leftHandlePosition),i.rightHandlePosition&&this._paintHandle(t,e,i.position,i.rightHandlePosition),i.leftShoulderPosition&&this._paintAnnotation(e,t,i.leftShoulderPosition,IFElementEditor.Annotation.Diamond,!1,!0),i.rightShoulderPosition&&this._paintAnnotation(e,t,i.rightShoulderPosition,IFElementEditor.Annotation.Diamond,!1,!0),this._paintAnnotation(e,t,i.position,i.annotation,i.anchorPoint.hasFlag(IFNode.Flag.Selected),!0)}.bind(this))},e.prototype._partIdAreEqual=function(t,i){var o=t.type===i.type;return o&&t.type==e.PartType.Point?o=t.point===i.point:o&&t.type==e.PartType.Segment&&(o=t.apLeft===i.apLeft&&t.apRight==i.apRight),o},e.prototype._updatePartSelection=function(t){this.requestInvalidation();var i=this._filterSelection(t);if(this._partSelection)for(var o=0;o<this._partSelection.length;++o){var n=this._partSelection[o],r=!1;if(i)for(var s=0;s<i.length;++s)if(i[s].point===n.point&&n.point||n.type==e.PartType.Segment&&n.type==i[s].type&&n.apLeft==i[s].apLeft&&n.apRight==i[s].apRight){r=!0;break}r||(n.point?n.point.removeFlag(IFNode.Flag.Selected):n.type==e.PartType.Segment&&(n.apLeft.removeFlag(IFNode.Flag.Selected),n.apRight.removeFlag(IFNode.Flag.Selected)))}if(i)for(o=0;o<i.length;++o){(n=i[o]).point?n.point.setFlag(IFNode.Flag.Selected):n.type==e.PartType.Segment&&(n.apLeft.setFlag(IFNode.Flag.Selected),n.apRight.setFlag(IFNode.Flag.Selected))}this._partSelection=i,this.requestInvalidation()},e.prototype._paintHandle=function(t,e,i,o){var n=i,r=o;t&&(n=t.mapPoint(i),r=t.mapPoint(o)),e.canvas.strokeLine(n.getX(),n.getY(),r.getX(),r.getY(),1,e.selectionOutlineColor),this._paintAnnotation(e,t,o,IFElementEditor.Annotation.Circle,!1,!0)},e.prototype._iteratePoints=function(t,e){for(var i=t?this.getPaintElement():this._element,o=i.getAnchorPoints(),n=i.getTransform(),r=o.getFirstChild();null!=r;r=r.getNext()){var s=o.getPreviousPoint(r),a=o.getNextPoint(r),l=r.getProperty("tp"),h=new IFPoint(r.getProperty("x"),r.getProperty("y")),p={type:l,anchorPoint:r,position:h,annotation:IFElementEditor.Annotation.Rectangle,leftHandlePosition:null,rightHandlePosition:null,leftShoulderPosition:null,rightShoulderPosition:null};if(r.hasFlag(IFNode.Flag.Selected)&&(l===IFPathBase.AnchorPoint.Type.Connector?p.annotation=IFElementEditor.Annotation.Diamond:l!==IFPathBase.AnchorPoint.Type.Symmetric&&l!==IFPathBase.AnchorPoint.Type.Mirror||(p.annotation=IFElementEditor.Annotation.Circle)),r.hasFlag(IFNode.Flag.Selected)||s&&s.hasFlag(IFNode.Flag.Selected))null!==(d=new IFPoint(r.getProperty("hlx"),r.getProperty("hly"))).getX()&&null!==d.getY()&&(p.leftHandlePosition=d);if(r.hasFlag(IFNode.Flag.Selected)||a&&a.hasFlag(IFNode.Flag.Selected))null!==(d=new IFPoint(r.getProperty("hrx"),r.getProperty("hry"))).getX()&&null!==d.getY()&&(p.rightHandlePosition=d);if(r.hasFlag(IFNode.Flag.Selected)&&l!==IFPathBase.AnchorPoint.Type.Asymmetric&&l!==IFPathBase.AnchorPoint.Type.Symmetric&&l!==IFPathBase.AnchorPoint.Type.Mirror&&l!==IFPathBase.AnchorPoint.Type.Connector){var d;if(r.getProperty("cl")&&s)(d=r.getLeftShoulderPoint(!0))&&null!==d.getX()&&null!==d.getY()&&(p.leftShoulderPosition=d);if(r.getProperty("cr")&&a)(d=r.getRightShoulderPoint(!0))&&null!==d.getX()&&null!==d.getY()&&(p.rightShoulderPosition=d)}if(n){var c=n.mapPoint(p.position);p.leftHandlePosition&&(p.leftHandlePosition=n.mapPoint(p.leftHandlePosition)),p.rightHandlePosition&&(p.rightHandlePosition=n.mapPoint(p.rightHandlePosition)),p.leftShoulderPosition&&(p.leftShoulderPosition=r.getLeftShoulderPointTransformed(n,!0)),p.rightShoulderPosition&&(p.rightShoulderPosition=r.getRightShoulderPointTransformed(n,!0)),p.position=c}if(!0===e(p))break}},e.prototype.getPathPreview=function(t,e){return this.requestInvalidation(),t?this.extendPreviewToFull():this._createPathPreviewIfNecessary(e),this.requestInvalidation(),this._elementPreview},e.prototype.getPath=function(){return this._element},e.PointsSelectionType={No:"N",First:"F",Last:"L",Middle:"M",Several:"S"},e.prototype.getPointsSelectionType=function(){var t=e.PointsSelectionType.No;if(this._partSelection)if(this._partSelection.length>1)t=e.PointsSelectionType.Several;else if(this._partSelection[0].point.hasFlag(IFNode.Flag.Selected)){var i=this._partSelection[0].point;t=i===this._element.getAnchorPoints().getLastChild()?e.PointsSelectionType.Last:i===this._element.getAnchorPoints().getFirstChild()?e.PointsSelectionType.First:e.PointsSelectionType.Middle}return t},e.prototype.selectOnePoint=function(t){this.updatePartSelection(!1,[{type:e.PartType.Point,point:t}])},e.prototype.shiftPreviewTable=function(t,e,i){e=null!=e?e:0,i=null!=i?i:this._sourceIndexToPreviewIndex.length-1;for(var o=e;o<i;++o)this._sourceIndexToPreviewIndex[o]+=t},e.prototype.extendPreviewToFull=function(){this._createPathPreviewIfNecessary();var t=this._element.getAnchorPoints(),e=this._elementPreview.getAnchorPoints(),i=e.getFirstChild(),o=t.getFirstChild(),n=0,r=null!=this._sourceIndexToPreviewIndex[n],s=r?this._sourceIndexToPreviewIndex[n]:0;e._beginBlockChanges([IFNode._Change.BeforeChildInsert,IFNode._Change.AfterChildInsert]);try{for(;!r&&o;){(l=new IFPathBase.AnchorPoint).transferProperties(o,[IFPathBase.AnchorPoint.GeometryProperties]),o.hasFlag(IFNode.Flag.Selected)&&l.setFlag(IFNode.Flag.Selected),e.insertChild(l,i),this._sourceIndexToPreviewIndex[n]=s,o=o.getNext(),++n,++s,r=null!=this._sourceIndexToPreviewIndex[n]}for(var a=n-0;r&&o;)this._sourceIndexToPreviewIndex[n]+=a,s=this._sourceIndexToPreviewIndex[n],o=o.getNext(),++n,r=null!=this._sourceIndexToPreviewIndex[n];for(++s;!r&&o;){var l;(l=new IFPathBase.AnchorPoint).transferProperties(o,[IFPathBase.AnchorPoint.GeometryProperties]),o.hasFlag(IFNode.Flag.Selected)&&l.setFlag(IFNode.Flag.Selected),e.appendChild(l),this._sourceIndexToPreviewIndex[n]=s,o=o.getNext(),++n,++s,r=null!=this._sourceIndexToPreviewIndex[n]}}finally{e._endBlockChanges([IFNode._Change.BeforeChildInsert,IFNode._Change.AfterChildInsert])}this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFPath.GeometryProperties])},e.prototype.constrainPosition=function(t,e,i){var o=new IFPoint(i.getProperty("x"),i.getProperty("y")),n=this._element.getTransform();return o=(n=n?n.multiplied(e):e).mapPoint(o),ifMath.convertToConstrain(o.getX(),o.getY(),t.getX(),t.getY(),this._element.getScene().getProperty("crConstraint"))},e.prototype._createPathPreviewIfNecessary=function(t){if(!this._elementPreview){this._sourceIndexToPreviewIndex={},this._elementPreview=new IFPath,this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFPath.GeometryProperties]);for(var e,i,o,n=function(e){return t&&e===t||!t&&e.hasFlag(IFNode.Flag.Selected)},r=this._element.getAnchorPoints(),s=this._elementPreview.getAnchorPoints(),a=null,l=null,h=r.getFirstChild();!(null==h||a&&l);h=h.getNext())e=r.getPreviousPoint(h),i=r.getNextPoint(h),a||(!e&&n(h)?a=h:!n(h)&&i&&n(i)&&(n(o=r.getFirstRelatedPoint(i))||r.getPreviousPoint(o)&&n(r.getPreviousPoint(o))||(a=o))),l||(!i&&n(h)?l=h:!n(h)&&e&&n(e)&&(n(o=r.getLastRelatedPoint(e))||r.getNextPoint(o)&&n(r.getNextPoint(o))||(l=o)));if((a&&!l||!a&&l||a&&l&&a===l)&&(a=null,l=null),a&&l){var p=!0;for(h=r.getNextPoint(l);h&&h!=a&&p;h=r.getNextPoint(h))n(h)&&(p=!1,a=null,l=null)}var d=!1;h=a=a||r.getFirstChild();s._beginBlockChanges([IFNode._Change.BeforeChildInsert,IFNode._Change.AfterChildInsert]);try{for(;!d;){var c=new IFPathBase.AnchorPoint;c.transferProperties(h,[IFPathBase.AnchorPoint.GeometryProperties]),n(h)&&c.setFlag(IFNode.Flag.Selected),s.appendChild(c);var _=r.getIndexOfChild(h),g=s.getIndexOfChild(c);this._sourceIndexToPreviewIndex[_]=g,h==l&&(d=!0),(h=r.getNextPoint(h))&&h!=a||(d=!0)}}finally{s._endBlockChanges([IFNode._Change.BeforeChildInsert,IFNode._Change.AfterChildInsert])}this._elementPreview.transferProperties(this._element,[IFShape.GeometryProperties,IFPath.GeometryProperties]),a.getProperty("ah")||l&&l.getProperty("ah")?this.extendPreviewToFull():this._elementPreview.getProperty("closed")&&l&&this._elementPreview.setProperty("closed",!1)}return this._elementPreview},e.prototype.releasePathPreview=function(){this._elementPreview=null,this._sourceIndexToPreviewIndex=null},e.prototype.getPathPointPreview=function(t){var e=t.getParent().getIndexOfChild(t);this._sourceIndexToPreviewIndex?null==this._sourceIndexToPreviewIndex[e]&&this._createPathPreviewIfNecessary(t):this.extendPreviewToFull(),this.requestInvalidation();var i=this._sourceIndexToPreviewIndex[e];return this._elementPreview.getAnchorPoints().getChildByIndex(i)},e.prototype.getTransformFromNative=function(t){var e=this._element.getTransform();return t&&(e=e?e.multiplied(t):t),e||(e=new IFTransform),e},e.prototype.movePoint=function(t,e,i,o){var n=this.getTransformFromNative(i),r=n.inverted(),s=r.mapPoint(e);if(t.getProperty("ah"))t.setProperties(["x","y"],[s.getX(),s.getY()]);else{var a=o||t,l=a.getProperty("hlx"),h=a.getProperty("hly"),p=a.getProperty("hrx"),d=a.getProperty("hry");if(null!=l&&null!=h||null!=p&&null!=d){var c,_=n.mapPoint(new IFPoint(a.getProperty("x"),a.getProperty("y"))),g=e.getX()-_.getX(),u=e.getY()-_.getY();if(null!=l&&null!=h)l=(c=r.mapPoint(n.mapPoint(new IFPoint(l,h)).translated(g,u))).getX(),h=c.getY();if(null!=p&&null!=d)p=(c=r.mapPoint(n.mapPoint(new IFPoint(p,d)).translated(g,u))).getX(),d=c.getY()}t.setProperties(["x","y","hlx","hly","hrx","hry"],[s.getX(),s.getY(),l,h,p,d])}},e.prototype._movePreviewPointCoordinates=function(t,e,i,o,n,r,s){var a=o;if(r){var l=n.inverted();a=this.constrainPosition(o,l,t)}a=n.mapPoint(a);var h=this._element.getTransform(),p=new IFPoint(t.getProperty(e),t.getProperty(i));h&&(p=h.mapPoint(p)),this._transformPreviewPointCoordinates(t,e,i,new IFTransform(1,0,0,1,a.getX()-p.getX(),a.getY()-p.getY()))},e.prototype._transformPreviewPointCoordinates=function(t,e,i,o,n){var r=this._element.getTransform(),s=this.getPathPointPreview(t);if(s){if(n)var a=n;else a=new IFPoint(t.getProperty(e),t.getProperty(i));var l=o;r&&(l=o.multiplied(r.inverted()),l=r.multiplied(l));var h=l.mapPoint(a),p=[e,i],d=[h.getX(),h.getY()];"hlx"!==e&&"hrx"!==e&&"hly"!==i&&"hry"!==i||(p.push("ah"),d.push(!1)),s.setProperties(p,d)}},e.prototype._movePreviewPointShoulders=function(t,i,o){var n,r=this._element.getTransform(),s=new IFPoint(t.point.getProperty("x"),t.point.getProperty("y"));n=t.type==e.PartType.LeftShoulder?t.point.getLeftShoulderLimitPoint():t.point.getRightShoulderLimitPoint(),r&&(s=r.mapPoint(s),n=r.mapPoint(n));var a=ifMath.getVectorProjection(s.getX(),s.getY(),n.getX(),n.getY(),i.getX(),i.getY(),!0),l=ifMath.ptDist(a.getX(),a.getY(),s.getX(),s.getY()),h=this.getPathPointPreview(t.point);if(o)if(this.hasFlag(IFElementEditor.Flag.Detail)&&1!=h.getProperty("cu")){var p=t.point.getProperty("cl");p=null!=p?p:0;var d=t.point.getProperty("cr");if(d=null!=d?p:0,t.type==e.PartType.LeftShoulder){var c=d-(l-p);c=c>0?c:0,h.setProperties(["cl","cr"],[l,c])}else{var _=p-(l-d);_=_>0?_:0,h.setProperties(["cl","cr"],[_,l])}}else h.setProperties(["cl","cr"],[l,l]);else t.type==e.PartType.LeftShoulder?h.setProperty("cl",l):h.setProperty("cr",l)},e.prototype._assignPreviewPointPropertiesToSourcePoint=function(t,e){var i=this.getPathPointPreview(t);i&&t.setProperties(e,i.getProperties(e))},e.prototype._transferPreviewProperties=function(t,e){var i=this._element.getAnchorPoints().getIndexOfChild(t),o=e.getAnchorPoints().getChildByIndex(i),n=this.getPathPointPreview(o);n&&o.transferProperties(n,[IFPathBase.AnchorPoint.GeometryProperties])},e.prototype._filterSelection=function(t){if(!t)return null;for(var i,o=[],n=0;n<t.length;++n)if(t[n].type!=e.PartType.Point)o.push(t[n]);else{i=!0;for(var r=0;r<t.length;++r)if(t[r].type==e.PartType.Segment&&(t[n].point==t[r].apLeft||t[n].point==t[r].apRight)){i=!1;break}i&&o.push(t[n])}return o},e.prototype._geometryChange=function(t){t.type==IFElement.GeometryChangeEvent.Type.After&&t.element==this._element&&this._elementPreview&&(this.releasePathPreview(),this.requestInvalidation())},e.prototype.toString=function(){return"[Object IFPathEditor]"},t.IFPathEditor=e}(this),function(t){function e(t){IFShapeEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFShapeEditor),IFElementEditor.exports(e,IFImage),e.prototype.initialSetup=function(){this.getElement().getStyleSet().appendChild(new IFInlineStyle)},e.prototype.toString=function(){return"[Object IFImageEditor]"},t.IFImageEditor=e}(this),function(t){function e(t){IFBlockEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFBlockEditor),e.exports(e,IFPage),e.prototype.canApplyTransform=function(){if(this._transform&&!this._transform.isIdentity()&&!this.getElement().hasFlag(IFElement.Flag.Locked)){var t=this._transform.mapRect(new IFRect(this._element.getProperty("x"),this._element.getProperty("y"),this._element.getProperty("w"),this._element.getProperty("h")));return!this._element.getScene().willPageIntersectWithOthers(this._element,t)}return!1},e.prototype.applyTransform=function(){if(this._transform&&!this._transform.isIdentity()){var t=this._transform.mapRect(new IFRect(this._element.getProperty("x"),this._element.getProperty("y"),this._element.getProperty("w"),this._element.getProperty("h")));this._element.setProperties(["x","y","w","h"],[t.getX(),t.getY(),t.getWidth(),t.getHeight()]),this._transform=null}this.resetTransform()},e.prototype.acceptDrop=function(t,e,i,o){return IFBlockEditor.prototype.acceptDrop.call(this,t,e,i,o),!0},e.prototype._prePaint=function(t,e){(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(t,e),IFBlockEditor.prototype._prePaint.call(this,t,e)},e.prototype.toString=function(){return"[Object IFPageEditor]"},t.IFPageEditor=e}(this),function(t){function e(t){IFBlockEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFBlockEditor),IFElementEditor.exports(e,IFLayer),e.prototype.paint=function(t,e){var i=e.selectionOutlineColor,o=this._element.getProperty("cls");e.selectionOutlineColor=o,IFBlockEditor.prototype.paint.call(this,t,e),e.selectionOutlineColor=i},e.prototype._prePaint=function(t,e){(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(t,e),IFBlockEditor.prototype._prePaint.call(this,t,e)},e.prototype.toString=function(){return"[Object IFLayerEditor]"},t.IFLayerEditor=e}(this),function(t){function e(t){IFBlockEditor.call(this,t),this._flags|=IFBlockEditor.Flag.ResizeAll}IFObject.inherit(e,IFBlockEditor),IFElementEditor.exports(e,IFSlice),e.prototype._prePaint=function(t,e){(this.hasFlag(IFElementEditor.Flag.Selected)||this.hasFlag(IFElementEditor.Flag.Highlighted))&&this._paintBBoxOutline(t,e),IFBlockEditor.prototype._prePaint.call(this,t,e)},e.prototype.toString=function(){return"[Object IFSliceEditor]"},t.IFSliceEditor=e}(this),function(t){function e(){}IFObject.inherit(e,IFObject),e.prototype._manager=null,e.prototype._scene=null,e.prototype._view=null,e.prototype._editor=null,e.prototype.getCursor=function(){return IFCursor.Default},e.prototype.activate=function(t){this._scene=t?t.getScene():null,this._view=t,this._editor=t.getEditor()},e.prototype.deactivate=function(t){if(t.getScene()!=this._scene||t!=this._view)throw new Error("Not supposed to happen");this._scene=null,this._view=null,this._editor=null},e.prototype.isDeactivatable=function(){return!0},e.prototype.paint=function(t){},e.prototype.updateCursor=function(){this._manager&&this==this._manager.getActiveTool()&&this._manager._updateActiveToolCursor()},e.prototype.invalidateArea=function(t){this._manager&&this==this._manager.getActiveTool()&&this._manager._invalidateActiveToolArea(t)},e.prototype.catchesContextMenu=function(){return!1},e.prototype.toString=function(){return"[Object IFTool]"},t.IFTool=e}(this),function(t){function e(){this._tools=[],this._typeIdToIndexMap={},this._paintLink=this._paint.bind(this)}IFObject.inheritAndMix(e,IFObject,[GEventTarget]),e.ToolChangedEvent=function(t,e){this.previousTool=t,this.newTool=e},IFObject.inherit(e.ToolChangedEvent,GEvent),e.ToolChangedEvent.prototype.previousTool=null,e.ToolChangedEvent.prototype.newTool=null,e.ToolChangedEvent.prototype.toString=function(){return"[Event IFToolManager.ToolChangedEvent]"},e.prototype._tools=null,e.prototype._typeIdToIndexMap=null,e.prototype._activeTool=null,e.prototype._view=null,e.prototype._viewStage=null,e.prototype._temporaryActiveTool=null,e.prototype._temporarySubselect=!1,e.prototype.addTool=function(t){if(t._manager)throw new Error("Tool is already registered");this._tools.push(t),t._manager=this,this._typeIdToIndexMap={};for(var e=0;e<this._tools.length;++e){t=this._tools[e];this._typeIdToIndexMap[IFObject.getTypeId(t)]=e}this._activeTool||this.activateTool(t)},e.prototype.hasTool=function(t){return this._typeIdToIndexMap.hasOwnProperty(IFObject.getTypeId(t))},e.prototype.getToolCount=function(){return this._tools.length},e.prototype.indexOf=function(t){return this._typeIdToIndexMap.hasOwnProperty(IFObject.getTypeId(t))?this._typeIdToIndexMap[IFObject.getTypeId(t)]:-1},e.prototype.getTool=function(t){return t>=0&&t<this._tools.length?this._tools[t]:null},e.prototype.getActiveTool=function(){return this._activeTool},e.prototype.getTemporaryActiveTool=function(){return this._temporaryActiveTool},e.prototype.activateTool=function(t){return!this._temporaryActiveTool&&this._activateTool(t)},e.prototype.setView=function(t){t!=this._view&&(this._view&&(this._removeActiveToolFromView(),this._viewStage.paint=null,ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)),this._view=t,this._viewStage=t?t.getToolStage():null,this._view&&(this._addActiveToolToView(),this._viewStage.paint=this._paintLink,ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)))},e.prototype._activateTool=function(t){if(this._activeTool&&!this._activeTool.isDeactivatable())return!1;if(t instanceof IFTool||(t=this.getTool(this.indexOf(t))),t!=this._activeTool){this._removeActiveToolFromView();var i=this._activeTool;return this._activeTool=t,this.hasEventListeners(e.ToolChangedEvent)&&this.trigger(new e.ToolChangedEvent(i,t)),this._addActiveToolToView(),!0}return!1},e.prototype._addActiveToolToView=function(){this._activeTool&&this._view&&(this._activeTool.activate(this._view),this._updateActiveToolCursor())},e.prototype._removeActiveToolFromView=function(){this._activeTool&&this._view&&(this._activeTool.deactivate(this._view),this._view.setCursor(null),this._view.getEditor().closeInlineEditor())},e.prototype._updateActiveToolCursor=function(){this._activeTool&&this._view&&this._view.setCursor(this._activeTool.getCursor())},e.prototype._invalidateActiveToolArea=function(t){this._activeTool&&this._view&&this._viewStage.invalidate(t)},e.prototype._paint=function(t){this._activeTool&&this._activeTool.paint(t)},e.prototype._updateTemporaryTool=function(){if(!this._view.getEditor().isInlineEditing()){var t=this.getTool(this.indexOf(IFPointerTool)),e=this.getTool(this.indexOf(IFSubSelectTool)),i=this.getTool(this.indexOf(IFHandTool)),o=this.getTool(this.indexOf(IFZoomTool)),n=null;if(ifPlatform.modifiers.metaKey&&!ifPlatform.modifiers.spaceKey&&this._activeTool!==t&&this._temporaryActiveTool!==t&&(n=t),ifPlatform.modifiers.optionKey&&(n===t||this._activeTool instanceof IFPointerTool||this._temporaryActiveTool===t)&&(n=e),ifPlatform.modifiers.spaceKey&&this._temporaryActiveTool!==i&&(n=i),ifPlatform.modifiers.metaKey&&(n===i||this._activeTool instanceof IFHandTool)&&(n=o),!n&&this._temporaryActiveTool)this._activateTool(this._temporaryActiveTool)&&(this._temporaryActiveTool=null);else if(n&&n!==this._activeTool){var r=this._activeTool;this._activateTool(n)&&(this._temporaryActiveTool||(this._temporaryActiveTool=r))}}},e.prototype._modifiersChanged=function(t){this._updateTemporaryTool()},e.prototype.toString=function(){return"[Object IFToolManager]"},t.IFToolManager=e}(this),function(t){function e(){IFTool.call(this)}IFObject.inherit(e,IFTool),e._Mode={Select:1,Move:2,Moving:3,Transforming:4},e.prototype._selectArea=null,e.prototype._mode=null,e.prototype._elementUnderMouse=null,e.prototype._editorUnderMouseInfo=null,e.prototype._editorMovePartInfo=null,e.prototype._keyDelta=null,e.prototype._moveStart=null,e.prototype._moveStartTransformed=null,e.prototype._moveCurrent=null,e.prototype._visuals=null,e.prototype._visualsArea=null,e.prototype.getCursor=function(){return this._editorUnderMouseInfo?IFCursor.SelectDot:IFCursor.Select},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this),t.addEventListener(GUIMouseEvent.Down,this._mouseDown,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),t.addEventListener(GUIMouseEvent.Move,this._mouseMove,this),t.addEventListener(GUIMouseEvent.DblClick,this._mouseDblClick,this),t.addEventListener(GUIKeyEvent.Down,this._keyDown,this),t.addEventListener(GUIKeyEvent.Release,this._keyRelease,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},e.prototype.deactivate=function(t){this._visualsArea&&(this.invalidateArea(this._visualsArea),this._visualsArea=null),this._mode===e._Mode.Transforming&&this._closeTransformBox(),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd),t.removeEventListener(GUIMouseEvent.Down,this._mouseDown),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),t.removeEventListener(GUIMouseEvent.Move,this._mouseMove),t.removeEventListener(GUIMouseEvent.DblClick,this._mouseDblClick),t.removeEventListener(GUIKeyEvent.Down,this._keyDown),t.removeEventListener(GUIKeyEvent.Release,this._keyRelease),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged),IFTool.prototype.deactivate.call(this,t)},e.prototype.isDeactivatable=function(){return!this._mode||this._mode===e._Mode.Transforming},e.prototype.paint=function(t){if(this._mode==e._Mode.Select&&this._hasSelectArea()){var i=Math.floor(this._selectArea.getX())+.5,o=Math.floor(this._selectArea.getY())+.5,n=Math.ceil(this._selectArea.getWidth())-1,r=Math.ceil(this._selectArea.getHeight())-1;t.canvas.strokeRect(i,o,n,r,1,t.selectionOutlineColor)}if(this._visuals){for(var s,a=0;a<this._visuals.length;++a){var l=(s=this._visuals[a])[0],h=s[1];t.canvas.strokeLine(Math.floor(l.getX())+.5,Math.floor(l.getY())+.5,Math.floor(h.getX())+.5,Math.floor(h.getY())+.5,1,t.highlightOutlineColor)}this._visuals=null}},e.prototype._mouseMove=function(t){var i=IFElementEditor.getEditor(this._scene);i&&i.isTransformBoxActive()&&this._updateMode(e._Mode.Transforming),this._updateEditorUnderMouse(t.client)},e.prototype._mouseDown=function(t){if(t.button===GUIMouseEvent.BUTTON_LEFT&&!this._editor.closeInlineEditor()){this._elementUnderMouse=null,this._editor.updateByMousePosition(t.client,this._view.getWorldTransform());var i=IFElementEditor.getEditor(this._scene);if(i&&i.isTransformBoxActive())this._mode!=e._Mode.Transforming&&this._updateMode(e._Mode.Transforming),this._editorMovePartInfo=i.getTBoxPartInfoAt(t.client,this._view.getWorldTransform(),this._scene.getProperty("pickDist"));else{this._updateMode(e._Mode.Select);var o=ifPlatform.modifiers.metaKey&&null==this._manager.getTemporaryActiveTool();if(!o){var n=IFElementEditor.getEditor(this._scene);if(n){var r=n.getPartInfoAt(t.client,this._view.getWorldTransform(),function(t){return t.hasFlag(IFElementEditor.Flag.Selected)}.bind(this),this._scene.getProperty("pickDist"));if(r){var s=r.editor,a=r.id,l=r.selectable;(ifPlatform.modifiers.shiftKey||!s.isPartSelected(a)&&l)&&s.updatePartSelection(ifPlatform.modifiers.shiftKey,[a]),l&&!s.isPartSelected(a)||(this._editorMovePartInfo=r),this._updateMode(e._Mode.Move)}}}}if(this._mode===e._Mode.Select){var h,p=this._editor.getSelection(),d=[],c=null;if(p&&p.length&&!o)for(var _=0;_<p.length&&!c;++_)p[_]instanceof IFElement&&(c=(h=p[_]).hitTest(t.client,this._view.getWorldTransform(),null,o,-1,this._scene.getProperty("pickDist"),!0));if(c)d.push(h);else{var g=this._scene.hitTest(t.client,this._view.getWorldTransform(),null,o,-1,this._scene.getProperty("pickDist"));if(g){var u=[];for(_=0;_<g.length;++_)u.push(g[_].element);d=this._getSelectableElements(u)}}if(d.length>0)if(d.length>1){var f=null;for(_=0;_<d.length;++_)d[_].hasFlag(IFNode.Flag.Selected)&&(f=_);null==f||f+1>=d.length?this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[d[0]]):this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[d[f+1]])}else{if(this._elementUnderMouse=d[0],ifPlatform.modifiers.shiftKey||!this._elementUnderMouse.hasFlag(IFNode.Flag.Selected))this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[this._elementUnderMouse]);else if(this._elementUnderMouse.hasFlag(IFNode.Flag.Selected)){(s=IFElementEditor.getEditor(this._elementUnderMouse))&&s.updatePartSelection(!1,null)}(p=this._editor.getSelection())&&p.length>0&&this._updateMode(e._Mode.Move)}else this._editor.updateSelection(ifPlatform.modifiers.shiftKey,[])}}},e.prototype._mouseRelease=function(t){this._editorMovePartInfo=null,this._moveStart=null,this._moveStartTransformed=null,this._moveCurrent=null,this._mode!=e._Mode.Transforming&&this._updateMode(null),this._updateEditorUnderMouse(t.client)},e.prototype._mouseDragStart=function(t){this._visualsArea&&(this.invalidateArea(this._visualsArea),this._visualsArea=null);var i=IFElementEditor.getEditor(this._scene);i&&i.isTransformBoxActive()?this._mode!=e._Mode.Transforming&&(i.setTransformBoxActive(!1),this._updateMode(null)):this._mode==e._Mode.Transforming&&this._updateMode(null),this._mode==e._Mode.Move?(this._moveStart=t.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),this._updateMode(e._Mode.Moving)):this._mode==e._Mode.Transforming&&(this._moveStart=t.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),i.startTBoxTransform(this._editorMovePartInfo))},e.prototype._mouseDrag=function(t){if(this._mode==e._Mode.Transforming){var i=IFElementEditor.getEditor(this._scene);i&&i.isTransformBoxActive()||this._updateMode(null)}this._mode==e._Mode.Moving||this._mode==e._Mode.Transforming?(this._moveCurrent=t.client,this._updateSelectionTransform()):this._mode==e._Mode.Select&&(this._hasSelectArea()&&this.invalidateArea(this._selectArea),this._selectArea=IFRect.fromPoints(t.clientStart,t.client),this._hasSelectArea()&&this.invalidateArea(this._selectArea))},e.prototype._mouseDragEnd=function(t){if(this._mode==e._Mode.Moving)if(this._editorMovePartInfo&&this._editorMovePartInfo.isolated){this._editor.beginTransaction();try{this._editorMovePartInfo.editor.applyPartMove(this._editorMovePartInfo.id,this._editorMovePartInfo.data)}finally{var i=this._editorMovePartInfo.editor.getElement().getNodeNameTranslated();i||(i="Element"),this._editor.commitTransaction("Modify "+i)}}else this._editor.applySelectionTransform(ifPlatform.modifiers.optionKey);else if(this._mode==e._Mode.Select)if(this._hasSelectArea()){var o=this._view.getViewTransform().mapRect(this._selectArea),n=o.getX(),r=o.getY(),s=n+o.getWidth(),a=r+o.getHeight(),l=new IFVertexContainer;l.addVertex(IFVertex.Command.Move,n,r),l.addVertex(IFVertex.Command.Line,s,r),l.addVertex(IFVertex.Command.Line,s,a),l.addVertex(IFVertex.Command.Line,n,a),l.addVertex(IFVertex.Command.Close,0,0);var h=this._scene.getCollisions(l,IFElement.CollisionFlag.GeometryBBox),p=this._getSelectableElements(h);this._editor.updateSelection(ifPlatform.modifiers.shiftKey,p);var d=this._selectArea;this._selectArea=null,this.invalidateArea(d)}else this._selectArea=null;else if(this._mode==e._Mode.Transforming){var c=IFElementEditor.getEditor(this._scene);c&&c.isTransformBoxActive()&&(c.applyTBoxTransform(ifPlatform.modifiers.optionKey),this.invalidateArea())}},e.prototype._mouseDblClick=function(t){if(!this._closeTransformBox()){var e=!0;this._elementUnderMouse&&this._editor.openInlineEditor(this._elementUnderMouse,this._view,t.client)&&(e=!1),e&&this._openTransformBox()}},e.prototype._keyDown=function(t){if((t.key===IFKey.Constant.UP||t.key===IFKey.Constant.DOWN||t.key===IFKey.Constant.LEFT||t.key===IFKey.Constant.RIGHT)&&this._editor.hasSelection()&&(!this._mode||this._mode===e._Mode.Moving)){this._mode!==e._Mode.Moving&&this._updateMode(e._Mode.Moving);var i=ifPlatform.modifiers.shiftKey?this._scene.getProperty("crDistBig"):this._scene.getProperty("crDistSmall"),o=0,n=0;switch(t.key){case IFKey.Constant.UP:n-=i;break;case IFKey.Constant.DOWN:n+=i;break;case IFKey.Constant.LEFT:o-=i;break;case IFKey.Constant.RIGHT:o+=i}this._keyDelta=this._keyDelta?this._keyDelta.add(new IFPoint(o,n)):new IFPoint(o,n),this._editor.moveSelection(this._keyDelta,!1)}},e.prototype._keyRelease=function(t){t.key!==IFKey.Constant.UP&&t.key!==IFKey.Constant.DOWN&&t.key!==IFKey.Constant.LEFT&&t.key!==IFKey.Constant.RIGHT||this._keyDelta&&(this._editor.applySelectionTransform(),this._keyDelta=null,this._updateMode(null))},e.prototype._modifiersChanged=function(t){var i=IFElementEditor.getEditor(this._scene);i&&i.isTransformBoxActive()?this._mode!=e._Mode.Transforming&&this._updateMode(e._Mode.Transforming):this._mode==e._Mode.Transforming&&this._updateMode(null),!(t.changed.shiftKey||t.changed.optionKey||t.changed.metaKey)||this._mode!==e._Mode.Moving&&this._mode!=e._Mode.Transforming||this._updateSelectionTransform()},e.prototype._closeTransformBox=function(){var t=IFElementEditor.getEditor(this._scene);return!(!t||!t.isTransformBoxActive())&&(t.setTransformBoxActive(!1),this._updateMode(null),this.invalidateArea(),this.updateCursor(),!0)},e.prototype._openTransformBox=function(){var t=IFElementEditor.getEditor(this._scene);(t=t||IFElementEditor.openEditor(this._scene)).setTransformBoxActive(!0),t.isTransformBoxActive()&&this._updateMode(e._Mode.Transforming)},e.prototype._updateSelectionTransform=function(){if(this._mode==e._Mode.Moving){var t=this._moveCurrent;if(this._editorMovePartInfo&&this._editorMovePartInfo.isolated)this._editor.getGuides().getShapeBoxGuide().useExclusions(this._editor.getSelection()),this._editor.getGuides().beginMap(),this._editorMovePartInfo.editor.movePart(this._editorMovePartInfo.id,this._editorMovePartInfo.data,t,this._view.getViewTransform(),this._editor.getGuides(),ifPlatform.modifiers.shiftKey,ifPlatform.modifiers.optionKey),this._editor.getGuides().finishMap();else{if(ifPlatform.modifiers.shiftKey){var i=this._scene.getProperty("crConstraint");t=ifMath.convertToConstrain(this._moveStart.getX(),this._moveStart.getY(),t.getX(),t.getY(),i)}if(t=this._view.getViewTransform().mapPoint(t),this._editorMovePartInfo&&this._editorMovePartInfo.id&&(this._editorMovePartInfo.id.type==IFPathEditor.PartType.Point||this._editorMovePartInfo.id.type==IFPathEditor.PartType.Segment)){this._editor.getGuides().beginMap(),t=this._editor.getGuides().mapPoint(t),this._editor.getGuides().finishMap();var o=t.subtract(this._moveStartTransformed);if(this._editorMovePartInfo.id.type==IFPathEditor.PartType.Point){var n=this._editorMovePartInfo.editor.getPointCoord(this._editorMovePartInfo.id.point);o=t.subtract(n)}this._editor.moveSelection(o,!1,this._editorMovePartInfo?this._editorMovePartInfo.id:null,this._editorMovePartInfo?this._editorMovePartInfo.data:null)}else{o=t.subtract(this._moveStartTransformed);this._editor.moveSelection(o,!0,this._editorMovePartInfo?this._editorMovePartInfo.id:null,this._editorMovePartInfo?this._editorMovePartInfo.data:null,this._moveStartTransformed)}}}else if(this._mode==e._Mode.Transforming){var r=IFElementEditor.getEditor(this._scene);if(r&&r.isTransformBoxActive()&&this._moveStart){var s=this._view.getViewTransform().mapPoint(this._moveCurrent);r.transformTBox(this._moveStartTransformed,s,ifPlatform.modifiers.optionKey,ifPlatform.modifiers.shiftKey),this.invalidateArea()}}},e.prototype._updateMode=function(t){t!==this._mode&&(this._mode=t)},e.prototype._updateEditorUnderMouse=function(t){var i=!1;if(this._visuals=null,this._mode==e._Mode.Transforming){var o=IFElementEditor.getEditor(this._scene);o&&o.isTransformBoxActive()?(this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=null),o.updateTBoxUnderMouse(t,this._view.getWorldTransform(),this._view),i=!0):this._updateMode(null)}var n=null;if(!this._mode){var r=IFElementEditor.getEditor(this._scene);r&&(n=r.getPartInfoAt(t,this._view.getWorldTransform(),function(t){return t.hasFlag(IFElementEditor.Flag.Selected)}.bind(this),this._scene.getProperty("pickDist")))!==this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=n,i=!0,this.updateCursor())}var s=null;if(this._visuals=null,!this._mode&&!n||this._mode==e._Mode.Select){var a,l=this._editor.getSelection(),h=!1;if(l&&1==l.length&&l[0]instanceof IFItem&&l[0].hitTest(t,this._view.getWorldTransform(),null,h,-1,this._scene.getProperty("pickDist"),!0)&&(a=l[0]),!a){var p=this._scene.hitTest(t,this._view.getWorldTransform(),null,h,-1,this._scene.getProperty("pickDist"));if(p&&p.length)for(var d=0;d<p.length&&!a;++d)p[d].element instanceof IFItem&&!p[d].element.hasFlag(IFNode.Flag.Selected)&&(a=p[d].element)}if(a&&(s=a.getGeometryBBox())&&!s.isEmpty()){s=this._view.getWorldTransform().mapRect(s);var c=this._editor.getGuides().getBBoxSnapZones(s,t);c&&c.length&&(this._visuals=c)}}!i&&this._editorUnderMouseInfo&&(this._editorUnderMouseInfo=null,this.updateCursor());var _=this._visuals?s.expanded(2,2,2,2):null;(this._visualsArea||_)&&(this._visualsArea&&this.invalidateArea(this._visualsArea),_&&this.invalidateArea(_),this._visualsArea=_)},e.prototype._getSelectableElements=function(t){for(var e=[],i=0;i<t.length;++i){var o=this._getSelectableElement(t[i]);o&&e.indexOf(o)<0&&e.push(o)}return e},e.prototype._getSelectableElement=function(t){for(var e=t;null!==e;e=e.getParent())if(e instanceof IFItem&&(!e.getParent()||!(e.getParent()instanceof IFItem)))return e;return null},e.prototype._hasSelectArea=function(){return this._selectArea&&(this._selectArea.getHeight()>0||this._selectArea.getWidth()>0)},e.prototype.toString=function(){return"[Object IFSelectTool]"},t.IFSelectTool=e}(this),function(t){function e(t){IFTool.call(this),this._areaSelector=t}IFObject.inherit(e,IFTool),e._AreaSelector=function(){this._vertexContainer=new IFVertexContainer,this._pixelTransformer=new IFVertexPixelAligner(this._vertexContainer)},e._AreaSelector.prototype._vertexContainer=null,e._AreaSelector.prototype._pixelTransformer=null,e._AreaSelector.prototype.getAreaBounds=function(){return ifVertexInfo.calculateBounds(this._pixelTransformer,!1)},e._AreaSelector.prototype.begin=function(){this._vertexContainer.clearVertices()},e._AreaSelector.prototype.finish=function(){},e._AreaSelector.prototype.start=function(t){},e._AreaSelector.prototype.move=function(t){},e._AreaSelector.prototype.paint=function(t){t.canvas.putVertices(this._pixelTransformer),t.canvas.strokeVertices(IFColor.BLACK)},e.prototype._areaSelector=null,e.prototype._areaBounds=null,e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this),t.addEventListener(GUIMouseEvent.Down,this._mouseDown,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},e.prototype.deactivate=function(t){IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd),t.removeEventListener(GUIMouseEvent.Down,this._mouseDown),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)},e.prototype.isDeactivatable=function(){return!this._areaBounds},e.prototype.paint=function(t){this._areaBounds&&this._areaSelector.paint(t)},e.prototype._mouseDown=function(t){t.button===GUIMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(t.client,this._view.getWorldTransform())},e.prototype._mouseRelease=function(t){if(!this._areaBounds||this._areaBounds.isEmpty())this._editor.clearSelection();else if(this._areaBounds&&!this._areaBounds.isEmpty()){var e=this._areaBounds;this._areaBounds=null,this.invalidateArea(e)}else this._areaBounds=null},e.prototype._mouseDragStart=function(t){this._areaSelector.begin(),this._areaSelector.start(t.client)},e.prototype._mouseDrag=function(t){this._areaBounds&&this.invalidateArea(this._areaBounds),this._areaSelector.move(t.client),this._updateAreaBoundsAndInvalidate()},e.prototype._mouseDragEnd=function(t){if(this._areaBounds){var e=new IFVertexTransformer(this._areaSelector._pixelTransformer,this._view.getViewTransform()),i=this._scene.getCollisions(e,IFElement.CollisionFlag.GeometryBBox);this._editor.updateSelection(ifPlatform.modifiers.shiftKey,i)}this._areaSelector.finish()},e.prototype._modifiersChanged=function(t){},e.prototype._updateAreaBoundsAndInvalidate=function(){this._areaBounds=this._areaSelector.getAreaBounds(),this._areaBounds&&this._areaBounds.isEmpty()&&(this._areaBounds=null),this._areaBounds&&(this._areaBounds=this._areaBounds.expanded(1,1,1,1),this.invalidateArea(this._areaBounds))},e.prototype.toString=function(){return"[Object IFMarqueeTool]"},t.IFMarqueeTool=e}(this),function(t){function e(t,e){IFTool.call(this),this._keepRatio=t,this._fromCenter=e}IFObject.inherit(e,IFTool),e.options={centerCrossSize:4},e.prototype._dragStart=null,e.prototype._dragCurrent=null,e.prototype._keepRatio=!1,e.prototype._fromCenter=!1,e.prototype._shape=null,e.prototype._dragArea=null,e.prototype._dragLine=null,e.prototype._hasCreatedShape=!1,e.prototype.getCursor=function(){return IFCursor.Cross},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.Move,this._mouseMove,this),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this),t.addEventListener(GUIMouseEvent.Down,this._mouseDown,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},e.prototype.deactivate=function(t){IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.Move,this._mouseMove,this),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd),t.removeEventListener(GUIMouseEvent.Down,this._mouseDown),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)},e.prototype.isDeactivatable=function(){return!this._dragStart},e.prototype.paint=function(t){if(this._shape&&(this._paintOutline(t),this._hasCenterCross())){var i=this._shape.getGeometryBBox(),o=4*e.options.centerCrossSize;if(i&&!i.isEmpty()&&i.getWidth()>o&&i.getHeight()>o){var n=e.options.centerCrossSize/2+.5,r=i.getSide(IFRect.Side.CENTER),s=Math.floor(r.getX())+.5,a=Math.floor(r.getY())+.5;t.canvas.strokeLine(s-n,a-n,s+n,a+n,1,t.selectionOutlineColor),t.canvas.strokeLine(s+n,a-n,s-n,a+n,1,t.selectionOutlineColor)}}},e.prototype._paintOutline=function(t){t.canvas.putVertices(new IFVertexPixelAligner(this._shape)),t.canvas.strokeVertices(t.selectionOutlineColor)},e.prototype._mouseDown=function(t){t.button===GUIMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(t.client,this._view.getWorldTransform())},e.prototype._mouseRelease=function(t){if(!this._hasCreatedShape){var e=this._view.getViewTransform().mapPoint(t.client);e=this._editor.getGuides().mapPoint(e),this._createShapeManually(e)}this._hasCreatedShape=!1},e.prototype._mouseDragStart=function(t){this._hasCreatedShape=!1,this._dragStart=this._view.getViewTransform().mapPoint(t.client),this._editor.getGuides().beginMap(),this._dragStart=this._editor.getGuides().mapPoint(this._dragStart),this._editor.getGuides().finishMap(),this._shape=this._createShape(),this._invalidateShape(),this.updateCursor()},e.prototype._mouseDrag=function(t){this._dragCurrent=this._view.getViewTransform().mapPoint(t.client),this._invalidateShape()},e.prototype._mouseDragEnd=function(t){var e=this._shape;this._shape=null,this._invalidateShapeArea(e),this._prepareShapeForAppend(e),this._dragStart=null,this._dragCurrent=null,this._shape=null,this._dragArea=null,this._dragLine=null,this.updateCursor(),this._insertShape(e),this._hasCreatedShape=!0},e.prototype._mouseMove=function(t){},e.prototype._modifiersChanged=function(t){(this._keepRatio&&t.changed.shiftKey||this._fromCenter&&t.changed.optionKey||t.changed.metaKey)&&this._invalidateShape()},e.prototype._invalidateShape=function(){if(this._dragStart&&this._dragCurrent){this._editor.getGuides().beginMap();var t=this._editor.getGuides().mapPoint(this._dragCurrent);if(this._editor.getGuides().finishMap(),IFPoint.equals(this._dragStart,t))this._invalidateShapeArea();else{var e=this._dragStart.getX(),i=this._dragStart.getY(),o=t.getX(),n=t.getY(),r=o,s=n;if(this._keepRatio&&ifPlatform.modifiers.shiftKey){var a=Math.abs(o-e),l=Math.abs(n-i),h=o<e?-1:1,p=n<i?-1:1;a>=l?(o=e+a*h,n=i+a*p,s=a<2*l?n:i):(o=e+l*h,n=i+l*p,r=l<2*a?o:e)}var d=null,c=null;this._fromCenter&&ifPlatform.modifiers.optionKey?(d=IFRect.fromPoints(new IFPoint(e-(o-e),i-(n-i)),new IFPoint(e+(o-e),i+(n-i))),c=[new IFPoint(e-(r-e),i-(s-i)),new IFPoint(e+(r-e),i+(s-i))]):(d=IFRect.fromPoints(new IFPoint(e,i),new IFPoint(o,n)),c=[new IFPoint(e,i),new IFPoint(r,s)]),this._dragArea=d,this._dragLine=c;var _=this._view.getWorldTransform(),g=_.mapRect(d),u=[_.mapPoint(c[0]),_.mapPoint(c[1])];this._invalidateShapeArea(),this._updateShape(this._shape,g,u,!1),this._invalidateShapeArea()}}},e.prototype._prepareShapeForAppend=function(t){this._updateShape(t,this._dragArea,this._dragLine,!0)},e.prototype._insertShape=function(t){this._editor.insertElements([t])},e.prototype._invalidateShapeArea=function(t){if(t=t||this._shape){var e=t.getGeometryBBox();e&&(e.getWidth()>0||e.getHeight()>0)&&this.invalidateArea(e.expanded(1,1,1,1))}},e.prototype._createShapeManually=function(t){},e.prototype._createShape=function(){throw new Error("Not Supported.")},e.prototype._updateShape=function(t,e,i,o){throw new Error("Not Supported.")},e.prototype._hasCenterCross=function(){return!1},e.prototype.toString=function(){return"[Object IFShapeTool]"},t.IFShapeTool=e}(this),function(t){function e(){IFSelectTool.call(this)}IFObject.inherit(e,IFSelectTool),e.prototype.getCursor=function(){var t=IFSelectTool.prototype.getCursor.call(this);return t===IFCursor.Select?IFCursor.SelectInverse:t===IFCursor.SelectDot?IFCursor.SelectDotInverse:t},e.prototype.activate=function(t){IFSelectTool.prototype.activate.call(this,t),this._editor.setSelectionDetail(!0)},e.prototype.deactivate=function(t){this._editor.setSelectionDetail(!1),IFSelectTool.prototype.deactivate.call(this,t)},e.prototype._mouseDragStart=function(t){if(this._mode==IFSelectTool._Mode.Move){if(this._moveStart=t.client,this._moveStartTransformed=this._view.getViewTransform().mapPoint(this._moveStart),this._updateMode(IFSelectTool._Mode.Moving),this._editorMovePartInfo)if(this._editorMovePartInfo.isolated)this._editorMovePartInfo=this._editorMovePartInfo.editor.subSelectDragStartAction(this._editorMovePartInfo);else{var e=this._editor.getSelection();if(e&&e.length)for(var i=0;i<e.length;++i){var o=IFElementEditor.getEditor(e[i]);if(o){var n=o.subSelectDragStartAction(this._editorMovePartInfo);if(n){this._editorMovePartInfo=n;break}}}}}else IFSelectTool.prototype._mouseDragStart.call(this,t)},e.prototype._getSelectableElement=function(t){return t instanceof IFShape?t:null},e.prototype.toString=function(){return"[Object IFSubSelectTool]"},t.IFSubSelectTool=e}(this),function(t){function e(){IFMarqueeTool.call(this,new e._AreaSelector)}IFObject.inherit(e,IFMarqueeTool),e._AreaSelector=function(){IFMarqueeTool._AreaSelector.call(this)},IFObject.inherit(e._AreaSelector,IFMarqueeTool._AreaSelector),e._AreaSelector.prototype._current=null,e._AreaSelector.prototype.start=function(t){this._current=null},e._AreaSelector.prototype.move=function(t){(null==this._current||Math.abs(t.getX()-this._current.getX())>=3||Math.abs(t.getY()-this._current.getY())>=3)&&(this._vertexContainer.addVertex(0==this._vertexContainer.getCount()?IFVertex.Command.Move:IFVertex.Command.Line,t.getX(),t.getY()),this._current=t)},e.prototype.getCursor=function(){return IFCursor.Lasso},e.prototype.toString=function(){return"[Object IFLassoTool]"},t.IFLassoTool=e}(this),function(t){function e(){IFSelectTool.call(this)}IFObject.inherit(e,IFSelectTool),e.prototype.activate=function(t){IFSelectTool.prototype.activate.call(this,t),this._editor.storeSelection();var e=this._scene.getActiveLayer();e?this._editor.updateSelection(!1,[e]):this._editor.clearSelection()},e.prototype.deactivate=function(t){this._editor.restoreSelection(),IFSelectTool.prototype.deactivate.call(this,t)},e.prototype._getSelectableElement=function(t){for(var e=t;null!==e;e=e.getParent())if(e instanceof IFLayer)return e;return null},e.prototype.toString=function(){return"[Object IFLayerTool]"},t.IFLayerTool=e}(this),function(t){function e(){IFTool.call(this)}IFObject.inherit(e,IFTool),e.prototype._panning=!1,e.prototype.getCursor=function(){return this._panning?IFCursor.HandClosed:IFCursor.HandOpen},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this)},e.prototype.deactivate=function(t){IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd)},e.prototype.isDeactivatable=function(){return!this._panning},e.prototype._mouseDragStart=function(t){this._panning=!0,this.updateCursor()},e.prototype._mouseDrag=function(t){this._panning&&this._view.scrollBy(-t.clientDelta.getX(),-t.clientDelta.getY())},e.prototype._mouseDragEnd=function(t){this._panning&&(this._panning=!1,this.updateCursor())},e.prototype.toString=function(){return"[Object IFHandTool]"},t.IFHandTool=e}(this),function(t){function e(){IFTool.call(this)}IFObject.inherit(e,IFTool),e.options={zoomStep:2},e.prototype._zoomMode=!1,e.prototype._dragArea=null,e.prototype.getCursor=function(){switch(this._zoomMode){case-2:case-1:return IFCursor.ZoomMinus;case 1:case 2:return IFCursor.ZoomPlus;default:return IFCursor.ZoomNone}},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),this._updateMode(),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},e.prototype.deactivate=function(t){IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)},e.prototype.isDeactivatable=function(){return!this._dragArea},e.prototype.paint=function(t){if(this._hasDragArea()){var e=Math.floor(this._dragArea.getX())+.5,i=Math.floor(this._dragArea.getY())+.5,o=Math.ceil(this._dragArea.getWidth())-1,n=Math.ceil(this._dragArea.getHeight())-1;t.canvas.strokeRect(e,i,o,n)}},e.prototype._mouseDragStart=function(t){},e.prototype._mouseDrag=function(t){0!=this._zoomMode&&(this._hasDragArea()&&this.invalidateArea(this._dragArea),this._dragArea=IFRect.fromPoints(t.clientStart,t.client),this._hasDragArea()&&this.invalidateArea(this._dragArea))},e.prototype._mouseDragEnd=function(t){if(0!=this._zoomMode)if(this._dragArea&&!this._dragArea.isEmpty()){var e=this._view.getViewTransform().mapRect(this._dragArea);this._view.zoomAll(e,this._zoomMode<0),this._updateMode()}else this._hasDragArea()&&this.invalidateArea(this._dragArea)},e.prototype._mouseRelease=function(t){if(!this._dragArea||this._dragArea&&this._dragArea.isEmpty()){var i=null;switch(this._zoomMode){case-2:i=IFView.options.minZoomFactor;break;case-1:i=this._view.getZoom()/e.options.zoomStep;break;case 1:i=this._view.getZoom()*e.options.zoomStep;break;case 2:i=IFView.options.maxZoomFactor}if(null!=i){var o=this._view.getViewTransform().mapPoint(t.client);this._view.zoomAt(o,i),this._updateMode()}}this._dragArea=null},e.prototype._modifiersChanged=function(t){this._updateMode()},e.prototype._updateMode=function(){var t=0;ifPlatform.modifiers.optionKey?(t=-1,ifPlatform.modifiers.shiftKey&&(t=-2)):(t=1,ifPlatform.modifiers.shiftKey&&(t=2)),(t<0&&this._view.getZoom()<=IFView.options.minZoomFactor||t>0&&this._view.getZoom()>=IFView.options.maxZoomFactor)&&(t=0),t!=this._zoomMode&&(this._zoomMode=t,this.updateCursor())},e.prototype._hasDragArea=function(){return this._dragArea&&(this._dragArea.getHeight()>0||this._dragArea.getWidth()>0)},e.prototype.toString=function(){return"[Object IFZoomTool]"},t.IFZoomTool=e}(this),function(t){function e(){IFTool.call(this)}IFObject.inherit(e,IFTool),e.prototype._pathRef=null,e.prototype._dpathRef=null,e.prototype._newPoint=null,e.prototype._editPt=null,e.prototype._refPt=null,e.prototype._pathEditor=null,e.prototype._released=!0,e.prototype._dragStarted=!1,e.prototype._dragStartPt=null,e.prototype._firstAlt=!1,e.Transaction={NoTransaction:0,InsertPoint:1,AppendPoint:2,MovePoint:3,DeletePoint:4,ModifyPointProperties:5,ModifyPathProperties:6,InsertElement:7},e.prototype._transactionType=e.Transaction.NoTransaction,e.Mode={Append:0,Prepend:1,Edit:2},e.prototype._mode=e.Mode.Append,e.prototype._mDownTime=0,e.DBLCLICKTM=300,e.prototype._cursor=null,e.prototype._lastMouseEvent=null,e.prototype._deactivationAllowed=!0,e.prototype.getCursor=function(){return this._cursor},e.prototype.catchesContextMenu=function(){return!0},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.Down,this._mouseDown,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),t.addEventListener(GUIKeyEvent.Down,this._keyDown,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this),this._cursor=IFCursor.PenStart,this._transactionType=e.Transaction.NoTransaction,this._initialSelectCorrection()},e.prototype.deactivate=function(t){(this._newPoint||this._dpathRef)&&(this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation()),this._finishTransaction(),this._allowDeactivation(),this._reset(),IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.Down,this._mouseDown),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),t.removeEventListener(GUIKeyEvent.Down,this._keyDown),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)},e.prototype.isDeactivatable=function(){return this._deactivationAllowed},e.prototype._allowDeactivation=function(){this._deactivationAllowed=!0},e.prototype._blockDeactivation=function(){this._deactivationAllowed=!1},e.prototype._checkPathEditor=function(){var t=this._editor.getPathSelection();t&&(this._pathEditor=IFElementEditor.openEditor(t),this._pathEditor.setFlag(IFElementEditor.Flag.Detail))},e.prototype._checkMode=function(){if(this._checkPathEditor(),this._pathEditor)if(this._pathRef=this._pathEditor.getPath(),this._pathRef.getProperty("closed"))this._mode=e.Mode.Edit;else{var t=this._pathEditor.getPointsSelectionType();t==IFPathEditor.PointsSelectionType.No||t==IFPathEditor.PointsSelectionType.Several||t==IFPathEditor.PointsSelectionType.Middle?this._mode=e.Mode.Edit:t==IFPathEditor.PointsSelectionType.Last?this._mode=e.Mode.Append:t==IFPathEditor.PointsSelectionType.First&&(this._mode=e.Mode.Prepend)}else this._mode=e.Mode.Append,this._pathRef=null},e.prototype._initialSelectCorrection=function(){if(this._checkPathEditor(),this._pathEditor)if(this._pathRef=this._pathEditor.getPath(),this._pathRef.getProperty("closed"))this._pathEditor.setActiveExtendingMode(!1);else if(this._pathEditor.isActiveExtendingMode()){var t=this._pathEditor.getPointsSelectionType();t!=IFPathEditor.PointsSelectionType.Last&&t!=IFPathEditor.PointsSelectionType.First&&this._pathEditor.selectOnePoint(this._pathRef.getAnchorPoints().getLastChild()),this._cursor=IFCursor.Pen}},e.prototype._renewPreviewLink=function(){this._pathEditor?this._dpathRef=this._pathEditor.getPathPreview():this._dpathRef=null},e.prototype._updatePoint=function(t){var i=null;return this._pathRef&&this._editPt&&(i=this._mode!=e.Mode.Edit?this._constrainIfNeeded(t,this._view.getWorldTransform(),this._pathRef):this._constrainIfNeeded(t,this._view.getWorldTransform(),this._pathRef,this._dpathRef.getAnchorPoints().getPreviousPoint(this._editPt)),this._editor.getGuides().beginMap(),i=this._view.getWorldTransform().mapPoint(this._editor.getGuides().mapPoint(this._view.getViewTransform().mapPoint(i))),this._editor.getGuides().finishMap(),this._pathEditor.movePoint(this._editPt,i,this._view.getWorldTransform(),this._dragStartPt)),i},e.prototype._addPoint=function(t,i,o,n){if(n||t.setFlag(IFNode.Flag.Selected),this._pathEditor&&!o){var r=this._pathRef.getTransform();if(r){var s=new IFPoint(t.getProperty("x"),t.getProperty("y"));s=r.inverted().mapPoint(s),t.setProperties(["x","y"],[s.getX(),s.getY()])}}i?this._pathEditor?(this._pathEditor.requestInvalidation(),this._mode==e.Mode.Append?(n||this._dpathRef.getAnchorPoints().getLastChild().removeFlag(IFNode.Flag.Selected),this._dpathRef.getAnchorPoints().appendChild(t),this._editPt=this._dpathRef.getAnchorPoints().getLastChild(),this._newPoint=!0,this._pathEditor.setActiveExtendingMode(!0)):this._mode==e.Mode.Prepend&&(n||this._dpathRef.getAnchorPoints().getFirstChild().removeFlag(IFNode.Flag.Selected),this._dpathRef.getAnchorPoints().insertChild(t,this._dpathRef.getAnchorPoints().getFirstChild()),this._pathEditor.shiftPreviewTable(1),this._editPt=this._dpathRef.getAnchorPoints().getFirstChild(),this._newPoint=!0,this._pathEditor.setActiveExtendingMode(!0)),this._pathEditor.requestInvalidation()):(this._startTransaction(e.Transaction.InsertElement),this._createAndAppendPath(t),this._pathEditor.selectOnePoint(t),this._checkMode(),this._renewPreviewLink(),this._editPt=this._dpathRef.getAnchorPoints().getLastChild(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!0)):this._pathEditor?(this._pathEditor.requestInvalidation(),this._mode==e.Mode.Append?(this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._startTransaction(e.Transaction.AppendPoint),this._pathRef.getAnchorPoints().appendChild(t),this._pathEditor.selectOnePoint(t),this._pathEditor.setActiveExtendingMode(!0)):this._mode==e.Mode.Prepend&&(this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._startTransaction(e.Transaction.AppendPoint),this._pathRef.getAnchorPoints().insertChild(t,this._pathRef.getAnchorPoints().getFirstChild()),this._pathEditor.selectOnePoint(t),this._pathEditor.setActiveExtendingMode(!0)),this._pathEditor.requestInvalidation()):(this._startTransaction(e.Transaction.InsertElement),this._createAndAppendPath(t),this._pathEditor.selectOnePoint(t),this._checkMode(),this._renewPreviewLink(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!0))},e.prototype._commitChanges=function(){this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._reset()},e.prototype._createAndAppendPath=function(t){var e=new IFPath;e.getAnchorPoints().appendChild(t),t.setFlag(IFNode.Flag.Selected),e.setFlag(IFNode.Flag.Selected),this._editor.insertElements([e],!1,!0),this._checkPathEditor()},e.prototype._mouseDown=function(t){this._released=!1},e.prototype._mouseDblClick=function(t){this._lastMouseEvent=null,this._checkMode(),this._pathEditor&&(this._pathEditor.updatePartSelection(!1),this._pathEditor.setActiveExtendingMode(!1),this._commitChanges()),this._mode=e.Mode.Edit,this._setCursorForPosition(null,t.client)},e.prototype._mouseRelease=function(t){this._released=!0,this._dragStarted=!1,this._dragStartPt=null},e.prototype._reset=function(){this._pathEditor&&this._pathEditor.removeFlag(IFElementEditor.Flag.Detail),this._dpathRef=null,this._pathRef=null,this._pathEditor=null,this._newPoint=!1,this._editPt=null,this._dragStartPt=null,this._refPt=null},e.prototype._keyDown=function(t){t.key===IFKey.Constant.TAB&&(this._lastMouseEvent=null,this._tabAction())},e.prototype._modifiersChanged=function(t){t.changed.shiftKey&&this._lastMouseEvent&&(this._released?this._mouseMove(this._lastMouseEvent):this._mouseDrag(this._lastMouseEvent)),t.changed.optionKey&&(this._firstAlt=!1,this._released||(ifPlatform.modifiers.optionKey&&(this._firstAlt=!this._dragStarted),this._mouseDrag(this._lastMouseEvent)))},e.prototype._tabAction=function(){this._released&&(this._checkMode(),this._pathEditor&&(this._pathEditor.updatePartSelection(!1),this._pathEditor.setActiveExtendingMode(!1),this._pathRef.removeFlag(IFNode.Flag.Selected),this._commitChanges()),this._setCursorForPosition(IFCursor.PenStart))},e.prototype._constrainIfNeeded=function(t,i,o,n){var r=t;if(ifPlatform.modifiers.shiftKey){var s=null;n?s=n:o&&(this._mode==e.Mode.Append?s=o.getAnchorPoints().getLastChild():this._mode==e.Mode.Prepend&&(s=o.getAnchorPoints().getFirstChild())),s&&(r=this._pathEditor.constrainPosition(t,i,s))}return r},e.prototype._makePointMajor=function(t){this._pathEditor.selectOnePoint(t),this._dpathRef=null,this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation(),this._dpathRef=this._pathEditor.getPathPreview(!1,t)},e.prototype._startTransaction=function(t){this._transactionType==e.Transaction.NoTransaction&&this._editor.beginTransaction(),this._transactionType=t},e.prototype._finishTransaction=function(){try{switch(this._transactionType){case e.Transaction.AppendPoint:this._editor.commitTransaction("Append Point");break;case e.Transaction.InsertElement:this._editor.commitTransaction("Insert Element(s)");break;case e.Transaction.InsertPoint:this._editor.commitTransaction("Insert Point");break;case e.Transaction.MovePoint:this._editor.commitTransaction("Move Point");break;case e.Transaction.DeletePoint:this._editor.commitTransaction("Delete Point");break;case e.Transaction.ModifyPointProperties:this._editor.commitTransaction("Modify Point Properties");break;case e.Transaction.ModifyPathProperties:this._editor.commitTransaction("Modify Path Properties")}}finally{this._transactionType=e.Transaction.NoTransaction}},e.prototype._mouseDownOnEdit=function(t,i){var o=t.client;this._pathEditor.requestInvalidation(),this._pathEditor.releasePathPreview(),this._pathEditor.requestInvalidation();var n=this._pathEditor.getPartInfoAt(o,this._view.getWorldTransform(),null,this._scene.getProperty("pickDist"));if(n&&n.id.type==IFPathEditor.PartType.Point){var r=n.id.point;this._pathRef.getProperty("closed")||r!==this._pathRef.getAnchorPoints().getLastChild()?this._pathRef.getProperty("closed")||r!==this._pathRef.getAnchorPoints().getFirstChild()?(this._refPt=r,null!==this._refPt.getProperty("hlx")&&null!==this._refPt.getProperty("hly")||null!==this._refPt.getProperty("hrx")&&null!==this._refPt.getProperty("hry")?this._setCursorForPosition(IFCursor.PenModify):this._setCursorForPosition(IFCursor.PenMinus)):(this._mode=e.Mode.Prepend,this._makePointMajor(r)):(this._mode=e.Mode.Append,this._makePointMajor(r))}else if(n&&n.id.type==IFPathEditor.PartType.Segment&&n.data.type==IFPathEditor.SegmentData.HitRes){if(this._setCursorForPosition(IFCursor.PenPlus),this._startTransaction(e.Transaction.InsertPoint),r=this._pathRef.insertHitPoint(n.data.hitRes)){if(t.button==GUIMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey)r.getProperty("tp")==IFPathBase.AnchorPoint.Type.Asymmetric&&r.setProperty("tp",IFPathBase.AnchorPoint.Type.Connector);i&&i(r),this._makePointMajor(r),this._refPt=r,this._editPt=this._pathEditor.getPathPointPreview(r),this._pathEditor.requestInvalidation(),this._mode=e.Mode.Edit}else this._finishTransaction(),this._reset(),this._mode=e.Mode.Append}else this._setCursorForPosition(IFCursor.PenStart),this._pathEditor.updatePartSelection(!1),this._commitChanges(),this._mode=e.Mode.Append},e.prototype._mouseNoDragReleaseOnEdit=function(t){this._refPt&&(null!=this._refPt.getProperty("hlx")||null!=this._refPt.getProperty("hly")||null!=this._refPt.getProperty("hrx")||null!=this._refPt.getProperty("hry")?(this._transactionType==e.Transaction.NoTransaction&&this._startTransaction(e.Transaction.ModifyPointProperties),this._refPt.setProperties(["ah","hlx","hly","hrx","hry"],[!1,null,null,null,null]),this._makePointMajor(this._refPt),this._setCursorForPosition(IFCursor.PenMinus)):(this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild()&&(this._transactionType==e.Transaction.NoTransaction?this._startTransaction(e.Transaction.DeletePoint):this._transactionType=e.Transaction.DeletePoint,this._pathRef.getAnchorPoints().removeChild(this._refPt)),this._setCursorForPosition(null,t)),this._refPt=null,this._commitChanges())},e.prototype._setCursorForPosition=function(t,i){if(null!==t)this._cursor=t;else if(i)if(this._pathEditor||this._checkPathEditor(),this._pathEditor){var o=this._pathEditor.getPartInfoAt(i,this._view.getWorldTransform(),null,this._scene.getProperty("pickDist"));if(o&&o.id.type==IFPathEditor.PartType.Point){var n=o.id.point,r=this._pathEditor.getPath();r.getProperty("closed")||n!==r.getAnchorPoints().getFirstChild()&&n!==r.getAnchorPoints().getLastChild()?this._mode==e.Mode.Edit?null!==n.getProperty("hlx")&&null!==n.getProperty("hly")||null!==n.getProperty("hrx")&&null!==n.getProperty("hry")?this._cursor=IFCursor.PenModify:this._cursor=IFCursor.PenMinus:this._cursor=IFCursor.Pen:this._mode==e.Mode.Append&&n===r.getAnchorPoints().getFirstChild()||this._mode==e.Mode.Prepend&&n===r.getAnchorPoints().getLastChild()?this._cursor=IFCursor.PenEnd:this._cursor=IFCursor.Pen}else this._mode==e.Mode.Edit?o&&o.id.type==IFPathEditor.PartType.Segment?this._cursor=IFCursor.PenPlus:this._cursor=IFCursor.PenStart:this._cursor=IFCursor.Pen}else this._cursor=IFCursor.PenStart;else this._cursor=IFCursor.PenStart;this.updateCursor()},e.prototype.toString=function(){return"[Object IFPathTool]"},t.IFPathTool=e}(this),function(t){function e(){IFPathTool.call(this)}IFObject.inherit(e,IFPathTool),e.prototype.activate=function(t){IFPathTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.Move,this._mouseMove,this)},e.prototype.deactivate=function(t){IFPathTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.Move,this._mouseMove)},e.prototype._mouseDown=function(t){var e=(new Date).getTime();if(e-this._mDownTime<IFPathTool.DBLCLICKTM)this._mouseDblClick(t);else{var i=null;if(this._lastMouseEvent=t,this._dragStarted=!1,this._dragStartPt=null,this._mouseMove(t),this._mDownTime=e,this._released=!1,ifPlatform.modifiers.optionKey&&(this._firstAlt=!0),this._blockDeactivation(),this._checkMode(),this._renewPreviewLink(),this._mode==IFPathTool.Mode.Edit&&this._mouseDownOnEdit(t),this._mode!=IFPathTool.Mode.Edit)if(this._newPoint&&this._pathEditor){if(this._updatePoint(t.client),this._mode==IFPathTool.Mode.Append){var o=this._editPt.getPrevious();o&&(o.removeFlag(IFNode.Flag.Selected),this._editPt.setFlag(IFNode.Flag.Selected))}else{var n=this._editPt.getNext();n&&(n.removeFlag(IFNode.Flag.Selected),this._editPt.setFlag(IFNode.Flag.Selected))}this._pathEditor.requestInvalidation(),t.button==GUIMouseEvent.BUTTON_RIGHT?ifPlatform.modifiers.optionKey?this._editPt.setProperty("tp",IFPathBase.AnchorPoint.Type.Connector):this._editPt.setProperties(["tp","cu"],[IFPathBase.CornerType.Rounded,!0]):ifPlatform.modifiers.optionKey||this._closePreviewIfNeeded(),this._dpathRef.getProperty("closed")&&(this._mode==IFPathTool.Mode.Append?this._refPt=this._pathRef.getAnchorPoints().getFirstChild():this._refPt=this._pathRef.getAnchorPoints().getLastChild()),this._pathEditor.requestInvalidation()}else if(this._pathEditor)this._mode==IFPathTool.Mode.Append?this._refPt=this._pathRef.getAnchorPoints().getLastChild():this._refPt=this._pathRef.getAnchorPoints().getFirstChild();else{var r=this._view.getViewTransform().mapPoint(t.client);this._editor.getGuides().beginMap(),r=this._editor.getGuides().mapPoint(r),this._editor.getGuides().finishMap(),i=this._constructNewPoint(t,r),t.button==GUIMouseEvent.BUTTON_RIGHT&&(ifPlatform.modifiers.optionKey?i.setProperty("tp",IFPathBase.AnchorPoint.Type.Connector):i.setProperties(["tp","cu"],[IFPathBase.CornerType.Rounded,!0])),this._addPoint(i,!0,!1)}this._editor.updateByMousePosition(t.client,this._view.getWorldTransform())}},e.prototype._renewPreviewLink=function(){if(this._pathEditor){var t,e=this._pathEditor.getPathPreview(!0);if(this._editPt)t=this._mode==IFPathTool.Mode.Append?e.getAnchorPoints().getLastChild():e.getAnchorPoints().getFirstChild(),this._editPt!=t&&(this._newPoint=!1,this._editPt=null);this._dpathRef=e}else this._editPt=null,this._newPoint=!1,this._dpathRef=null},e.prototype._closePreviewIfNeeded=function(){if(this._pathRef&&this._newPoint&&(this._mode==IFPathTool.Mode.Append||this._mode==IFPathTool.Mode.Prepend)){var t,e;this._mode==IFPathTool.Mode.Append?(t=this._dpathRef.getAnchorPoints().getLastChild(),e=this._dpathRef.getAnchorPoints().getFirstChild()):(t=this._dpathRef.getAnchorPoints().getFirstChild(),e=this._dpathRef.getAnchorPoints().getLastChild());var i=new IFPoint(t.getProperty("x"),t.getProperty("y")),o=this._pathRef.getTransform();if(i=o?o.mapPoint(i):i,e&&this._pathEditor.hitAnchorPoint(e,i,null,this._scene.getProperty("pickDist"))){this._dpathRef=this._pathEditor.getPathPreview(!0),this._mode==IFPathTool.Mode.Append?this._editPt=this._dpathRef.getAnchorPoints().getFirstChild():this._editPt=this._dpathRef.getAnchorPoints().getLastChild();var n=this._editPt.getProperty("tp");IFPathBase.isCornerType(n)||this._editPt.setProperty("tp",IFPathBase.AnchorPoint.Type.Asymmetric),this._editPt.setProperties(["hlx","hly"],[null,null]),this._editPt.setProperty("ah",!1),this._dpathRef.getAnchorPoints().removeChild(t),this._dpathRef.setProperty("closed",!0),this._pathEditor.requestInvalidation(),this._editPt.setFlag(IFNode.Flag.Selected),this._pathEditor.requestInvalidation(),this._newPoint=!1}}},e.prototype._mouseMove=function(t){if(!((new Date).getTime()-this._mDownTime<IFPathTool.DBLCLICKTM)){var e;if(this._released)if(this._lastMouseEvent=t,this._checkMode(),this._renewPreviewLink(),this._mode==IFPathTool.Mode.Edit)this._setCursorForPosition(null,t.client);else{var i,o=t.client;if(!this._newPoint&&this._pathEditor){o=this._constrainIfNeeded(t.client,this._view.getWorldTransform(),this._pathRef);var n=this._view.getViewTransform().mapPoint(o);this._editor.getGuides().beginMap(),n=this._editor.getGuides().mapPoint(n),this._editor.getGuides().finishMap(),o=this._view.getWorldTransform().mapPoint(n),e=this._constructNewPoint(t,n),this._addPoint(e,!0,!1,!0)}else this._editPt&&(this._pathEditor.requestInvalidation(),o=this._updatePoint(t.client),this._pathEditor.requestInvalidation());if(this._editPt)i=this._mode==IFPathTool.Mode.Append?this._pathRef.getAnchorPoints().getFirstChild():this._pathRef.getAnchorPoints().getLastChild(),this._pathEditor.hitAnchorPoint(i,o,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?this._setCursorForPosition(IFCursor.PenEnd):this._setCursorForPosition(IFCursor.Pen);else this._setCursorForPosition(null,t.client)}else t.button==GUIMouseEvent.BUTTON_RIGHT&&this._mouseDrag(t)}},e.prototype._updateHandles=function(t){var e,i,o,n,r=this._editPt.getProperty("tp"),s=this._editPt.getProperty("x"),a=this._editPt.getProperty("y");if(this._pathEditor.hitAnchorPoint(this._editPt,t,this._view.getWorldTransform(),0)&&!this._firstAlt)this._mode!=IFPathTool.Mode.Edit?this._mode==IFPathTool.Mode.Append?null!==this._editPt.getProperty("hlx")&&null!==this._editPt.getProperty("hly")?this._editPt.setProperties(["tp","hrx","hry"],[IFPathBase.AnchorPoint.Type.Symmetric,null,null]):this._editPt.setProperties(["tp","hrx","hry"],[IFPathBase.AnchorPoint.Type.Asymmetric,null,null]):null!==this._editPt.getProperty("hrx")&&null!==this._editPt.getProperty("hry")?this._editPt.setProperties(["tp","hlx","hly"],[IFPathBase.AnchorPoint.Type.Symmetric,null,null]):this._editPt.setProperties(["tp","hlx","hly"],[IFPathBase.AnchorPoint.Type.Asymmetric,null,null]):ifPlatform.modifiers.optionKey?this._editPt.setProperties(["tp","hrx","hry"],[IFPathBase.AnchorPoint.Type.Asymmetric,null,null]):this._editPt.setProperties(["tp","hlx","hly","hrx","hry"],[IFPathBase.AnchorPoint.Type.Asymmetric,null,null,null,null]);else{var l=this._pathEditor.getTransformFromNative(this._view.getWorldTransform()).inverted().mapPoint(t);if(this._newPoint||!ifPlatform.modifiers.optionKey||!this._firstAlt||r==IFPathBase.AnchorPoint.Type.Connector||null==this._editPt.getPrevious()&&null==this._editPt.getNext()){if(r!=IFPathBase.AnchorPoint.Type.Connector){this._editPt.setProperty("ah",!1);var h=l.getX(),p=l.getY();if(ifPlatform.modifiers.optionKey)this._mode==IFPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hlx","hly"],[IFPathBase.AnchorPoint.Type.Asymmetric,h,p]):this._editPt.setProperties(["tp","hrx","hry"],[IFPathBase.AnchorPoint.Type.Asymmetric,h,p]);else{var d=IFPathBase.AnchorPoint.Type.Symmetric;if(this._mode==IFPathTool.Mode.Edit||this._newPoint||this._dpathRef.getProperty("closed")||!(null==this._editPt.getPrevious()&&null!=this._editPt.getNext()||null!=this._editPt.getPrevious()&&null==this._editPt.getNext())){var c=s+s-h,_=a+a-p;this._mode==IFPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hrx","hry","hlx","hly"],[d,c,_,h,p]):this._editPt.setProperties(["tp","hrx","hry","hlx","hly"],[d,h,p,c,_])}else this._mode==IFPathTool.Mode.Prepend?this._editPt.setProperties(["tp","hlx","hly"],[d,h,p]):this._editPt.setProperties(["tp","hrx","hry"],[d,h,p])}}else if(this._mode==IFPathTool.Mode.Append||this._mode==IFPathTool.Mode.Edit&&ifPlatform.modifiers.optionKey){e=null,i=null;var g=this._editPt.getPrevious();if(g){var u=g.getProperty("x"),f=g.getProperty("y"),P=Math.sqrt(ifMath.ptSqrDist(s,a,u,f));if(ifMath.isEqualEps(P,0))o=l.getX(),n=l.getY();else{var m=(s-u)/P,I=(a-f)/P;(F=ifMath.vDotProduct(m,I,l.getX()-s,l.getY()-a))>0?(o=s+m*F,n=a+I*F):(o=null,n=null)}}else o=l.getX(),n=l.getY();this._editPt.setProperties(["hlx","hly","hrx","hry"],[e,i,o,n])}else if(this._mode==IFPathTool.Mode.Prepend){o=null,n=null;var v=this._editPt.getNext();if(v){var y=v.getProperty("x"),E=v.getProperty("y");P=Math.sqrt(ifMath.ptSqrDist(s,a,y,E));if(ifMath.isEqualEps(P,0))e=l.getX(),i=l.getY();else{var F;m=(s-y)/P,I=(a-E)/P;(F=ifMath.vDotProduct(m,I,l.getX()-s,l.getY()-a))>0?(e=s+m*F,i=a+I*F):(e=null,i=null)}}else e=l.getX(),i=l.getY();this._editPt.setProperties(["hlx","hly","hrx","hry"],[e,i,o,n])}}else{var T=l.getX()-s,S=l.getY()-a;this._editPt.setProperty("ah",!1);var M=this._dragStartPt.getProperty("hrx");o=null!=M?M+T:l.getX();var A=this._dragStartPt.getProperty("hry");n=null!=A?A+S:l.getY(),this._editPt.setProperty("ah",!1),this._editPt.setProperties(["tp","hrx","hry"],[IFPathBase.AnchorPoint.Type.Asymmetric,o,n])}}this._pathEditor.requestInvalidation()},e.prototype._mouseDrag=function(t){!this._refPt||this._editPt||this._released||(this._makePointMajor(this._refPt),this._editPt=this._pathEditor.getPathPointPreview(this._refPt),this._dragStartPt=this._refPt,t.button==GUIMouseEvent.BUTTON_LEFT&&this._editPt.setProperty("tp",IFPathBase.AnchorPoint.Type.Symmetric),this._pathEditor.requestInvalidation()),!this._released&&this._editPt&&(this._lastMouseEvent=t,this._setCursorForPosition(IFCursor.PenDrag),this._dragStartPt||(this._dragStartPt=this._refPt?this._refPt:this._editPt,t.button==GUIMouseEvent.BUTTON_LEFT&&this._editPt.getProperty("tp")!=IFPathBase.AnchorPoint.Type.Connector&&this._editPt.setProperty("tp",IFPathBase.AnchorPoint.Type.Symmetric)),this._dragStarted=!0,this._updatePointProperties(t.client))},e.prototype._constructNewPoint=function(t,e){var i=new IFPath.AnchorPoint;return i.setProperties(["x","y"],[e.getX(),e.getY()]),i},e.prototype._mouseRelease=function(t){if(!this._released)try{if(this._editor.updateByMousePosition(t.client,this._view.getWorldTransform()),this._released=!0,this._pathEditor&&this._mode==IFPathTool.Mode.Edit)this._dragStarted||!this._refPt||this._editPt?this._dragStarted?(this._updatePointProperties(t.client),this._transactionType==IFPathTool.Transaction.NoTransaction&&this._startTransaction(IFPathTool.Transaction.ModifyPointProperties),this._pathEditor.applyTransform(this._pathRef),this._commitChanges(),this._setCursorForPosition(null,t.client)):(this._commitChanges(),this._setCursorForPosition(null,t.client)):this._mouseNoDragReleaseOnEdit(t.client);else if(this._dpathRef){var e,i=t.client;if(this._dragStarted&&(i=this._updatePointProperties(t.client)),this._dpathRef.getProperty("closed"))this._refPt&&(this._startTransaction(IFPathTool.Transaction.ModifyPathProperties),this._pathEditor.selectOnePoint(this._refPt),this._pathEditor.applyTransform(this._pathRef),this._pathEditor.requestInvalidation(),this._pathRef.setProperty("closed",!0),this._pathEditor.setActiveExtendingMode(!1)),this._commitChanges(),this._mode=IFPathTool.Mode.Edit,this._setCursorForPosition(null,t.client);else this._newPoint&&(this._addPoint(this._editPt,!1,!0),this._pathEditor.requestInvalidation()),this._mode==IFPathTool.Mode.Append?(this._refPt=this._pathRef.getAnchorPoints().getLastChild(),e=this._pathRef.getAnchorPoints().getFirstChild()):(this._refPt=this._pathRef.getAnchorPoints().getFirstChild(),e=this._pathRef.getAnchorPoints().getLastChild()),this._newPoint||(this._transactionType==IFPathTool.Transaction.NoTransaction&&this._startTransaction(IFPathTool.Transaction.ModifyPointProperties),this._pathEditor.selectOnePoint(this._refPt),this._pathEditor.applyTransform(this._pathRef)),e&&e!=this._refPt&&this._pathEditor.hitAnchorPoint(e,i,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?this._setCursorForPosition(IFCursor.PenEnd):this._setCursorForPosition(IFCursor.Pen),this._commitChanges();this._refPt=null}}finally{this._finishTransaction()}this._dragStarted=!1,this._dragStartPt=null,this._lastMouseEvent=null,this._firstAlt=!1,this._allowDeactivation()},e.prototype._updateShoulders=function(t){if((this._mode==IFPathTool.Mode.Append||this._mode==IFPathTool.Mode.Prepend)&&this._editPt)if(this._pathEditor.hitAnchorPoint(this._editPt,t,this._view.getWorldTransform(),0))this._mode==IFPathTool.Mode.Append?this._editPt.setProperty("cr",null):this._mode==IFPathTool.Mode.Prepend&&this._editPt.setProperty("cl",null);else{var e=this._pathEditor.getTransformFromNative(this._view.getWorldTransform()),i=new IFPoint(this._editPt.getProperty("x"),this._editPt.getProperty("y"));i=e.mapPoint(i);var o=ifMath.ptDist(i.getX(),i.getY(),t.getX(),t.getY());this._mode==IFPathTool.Mode.Append?this._editPt.setProperty("cr",o):this._mode==IFPathTool.Mode.Prepend&&this._editPt.setProperty("cl",o)}},e.prototype._updatePointProperties=function(t){var e=t;if(this._pathEditor.requestInvalidation(),this._editPt.getProperty("tp")==IFPathBase.CornerType.Rounded)this._updateShoulders(t);else{e=this._constrainIfNeeded(t,this._view.getWorldTransform(),this._pathRef,this._dragStartPt);this._updateHandles(e)}return e},e.prototype.toString=function(){return"[Object IFPenTool]"},t.IFPenTool=e}(this),function(t){function e(){IFPathTool.call(this)}IFObject.inherit(e,IFPathTool),e.prototype.activate=function(t){IFPathTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.Move,this._mouseMove,this),this._checkMode()},e.prototype.deactivate=function(t){IFPathTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.Move,this._mouseMove)},e.prototype._mouseDown=function(t){var e=(new Date).getTime();if(e-this._mDownTime<IFPathTool.DBLCLICKTM)this._mouseDblClick(t);else{this._mDownTime=e,this._lastMouseEvent=t;var i,o=null;if(this._editor.updateByMousePosition(t.client,this._view.getWorldTransform()),this._dragStarted=!1,this._dragStartPt=null,this._newPoint=null,this._editPt=null,t.button==GUIMouseEvent.BUTTON_LEFT||t.button==GUIMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey){if(this._released=!1,this._blockDeactivation(),this._checkMode(),this._renewPreviewLink(),this._mode==IFPathTool.Mode.Edit){this._mouseDownOnEdit(t,function(t){ifPlatform.modifiers.optionKey&&t.getProperty("tp")!=IFPathBase.AnchorPoint.Type.Connector&&t.setProperty("tp",IFPathBase.AnchorPoint.Type.Symmetric)})}var n,r;if(this._mode!=IFPathTool.Mode.Edit)if(i=this._constrainIfNeeded(t.client,this._view.getWorldTransform(),this._pathRef),this._pathEditor&&(n=this._mode==IFPathTool.Mode.Append?this._pathRef.getAnchorPoints().getFirstChild():this._pathRef.getAnchorPoints().getLastChild()),n&&this._pathEditor.hitAnchorPoint(n,i,this._view.getWorldTransform(),this._scene.getProperty("pickDist")))this._setCursorForPosition(IFCursor.PenEnd),this._startTransaction(IFPathTool.Transaction.ModifyPathProperties),this._pathRef.setProperty("closed",!0),this._makePointMajor(n),this._pathEditor.setActiveExtendingMode(!1),this._mode=IFPathTool.Mode.Edit,this._editPt=this._pathEditor.getPathPointPreview(n),this._pathEditor.requestInvalidation();else if(this._setCursorForPosition(IFCursor.Pen),this._pathEditor&&(r=this._mode==IFPathTool.Mode.Append?this._pathRef.getAnchorPoints().getLastChild():this._pathRef.getAnchorPoints().getFirstChild()),r&&this._pathEditor.hitAnchorPoint(r,i,this._view.getWorldTransform(),this._scene.getProperty("pickDist")))this._makePointMajor(r),this._editPt=this._pathEditor.getPathPointPreview(r),this._pathEditor.requestInvalidation();else{var s=this._view.getViewTransform().mapPoint(i);this._editor.getGuides().beginMap(),s=this._editor.getGuides().mapPoint(s),this._editor.getGuides().finishMap(),o=this._constructNewPoint(t,s),this._addPoint(o,!0,!1)}}}},e.prototype._mouseMove=function(t){this._released?(this._lastMouseEvent=t,this._setCursorForPosition(null,t.client)):t.button==GUIMouseEvent.BUTTON_RIGHT&&ifPlatform.modifiers.optionKey&&this._mouseDrag(t)},e.prototype._mouseDrag=function(t){if(this._refPt&&!this._released&&(this._makePointMajor(this._refPt),this._editPt=this._pathEditor.getPathPointPreview(this._refPt),this._dragStartPt=this._refPt,this._pathEditor.requestInvalidation(),this._refPt=null),this._editPt&&!this._released){this._lastMouseEvent=t,this._dragStarted=!0,this._pathEditor.requestInvalidation();var e,i=this._updatePoint(t.client);this._newPoint||this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild()?(this._editPt==this._dpathRef.getAnchorPoints().getLastChild()?e=this._pathRef.getAnchorPoints().getFirstChild():this._editPt==this._dpathRef.getAnchorPoints().getFirstChild()&&(e=this._pathRef.getAnchorPoints().getLastChild()),e&&this._pathEditor.hitAnchorPoint(e,i,this._view.getWorldTransform(),this._scene.getProperty("pickDist"))?this._setCursorForPosition(IFCursor.PenEnd):this._setCursorForPosition(IFCursor.Pen)):this._setCursorForPosition(IFCursor.Pen),this._pathEditor.requestInvalidation()}},e.prototype._constructNewPoint=function(t,e){var i=new IFPath.AnchorPoint;return i.setProperties(["x","y","ah"],[e.getX(),e.getY(),!0]),t.button==GUIMouseEvent.BUTTON_LEFT?ifPlatform.modifiers.optionKey?i.setProperty("tp",IFPathBase.AnchorPoint.Type.Symmetric):i.setProperty("tp",IFPathBase.AnchorPoint.Type.Asymmetric):i.setProperty("tp",IFPathBase.AnchorPoint.Type.Connector),i},e.prototype._closeIfNeeded=function(){if(this._pathRef&&(this._newPoint||this._pathRef.getAnchorPoints().getFirstChild()!=this._pathRef.getAnchorPoints().getLastChild())&&(this._mode==IFPathTool.Mode.Append||this._mode==IFPathTool.Mode.Prepend)){var t,e;this._mode==IFPathTool.Mode.Append?(t=this._dpathRef.getAnchorPoints().getLastChild(),e=this._pathRef.getAnchorPoints().getFirstChild()):(t=this._dpathRef.getAnchorPoints().getFirstChild(),e=this._pathRef.getAnchorPoints().getLastChild());var i=new IFPoint(t.getProperty("x"),t.getProperty("y")),o=this._pathRef.getTransform();i=o?o.mapPoint(i):i,e&&this._pathEditor.hitAnchorPoint(e,i,null,this._scene.getProperty("pickDist"))&&(this._transactionType==IFPathTool.Transaction.NoTransaction?this._startTransaction(IFPathTool.Transaction.ModifyPathProperties):this._transactionType=IFPathTool.Transaction.ModifyPathProperties,this._pathRef.beginUpdate(),this._pathEditor.selectOnePoint(e),ifPlatform.modifiers.optionKey&&e.setProperties(["ah","tp"],[!1,IFPathBase.AnchorPoint.Type.Asymmetric]),e.getProperty("ah")||e.setProperties(["hlx","hly"],[t.getProperty("hlx"),t.getProperty("hly")]),this._dpathRef.getAnchorPoints().removeChild(t),this._newPoint||(t=this._mode==IFPathTool.Mode.Append?this._pathRef.getAnchorPoints().getLastChild():this._pathRef.getAnchorPoints().getFirstChild(),this._pathRef.getAnchorPoints().removeChild(t)),this._dpathRef.setProperty("closed",!0),this._pathRef.setProperty("closed",!0),this._pathRef.endUpdate(),this._pathEditor.requestInvalidation(),this._pathEditor.setActiveExtendingMode(!1),this._newPoint=!1)}},e.prototype._mouseRelease=function(t){if(!this._released)try{if(this._released=!0,this._mode==IFPathTool.Mode.Append||this._mode==IFPathTool.Mode.Prepend){var e=this._updatePoint(t.client);this._closeIfNeeded(),this._pathRef.getProperty("closed")?(this._setCursorForPosition(IFCursor.PenMinus),this._mode=IFPathTool.Mode.Edit):this._newPoint?(this._addPoint(this._editPt,!1,!0),this._setCursorForPosition(IFCursor.Pen)):this._editPt&&(this._transactionType==IFPathTool.Transaction.NoTransaction&&this._startTransaction(IFPathTool.Transaction.MovePoint),this._pathEditor.applyTransform(this._pathRef),this._setCursorForPosition(IFCursor.PenEnd)),this._commitChanges()}else if(this._mode==IFPathTool.Mode.Edit&&(this._editPt||this._refPt))if(this._dragStarted&&this._editPt){e=this._updatePoint(t.client);this._transactionType==IFPathTool.Transaction.NoTransaction&&this._startTransaction(IFPathTool.Transaction.MovePoint),this._pathEditor.applyTransform(this._pathRef),this._setCursorForPosition(null,e),this._commitChanges()}else this._editPt?this._commitChanges():this._mouseNoDragReleaseOnEdit(t.client);this._dragStarted=!1,this._dragStartPt=null}finally{this._finishTransaction()}this._lastMouseEvent=null,this._allowDeactivation()},e.prototype.toString=function(){return"[Object IFBezigonTool]"},t.IFBezigonTool=e}(this),function(t){function e(){IFShapeTool.call(this,!0,!0)}IFObject.inherit(e,IFShapeTool),e.prototype._createShape=function(){var t=new IFPath;return t.getAnchorPoints().appendChild(new IFPathBase.AnchorPoint),t.getAnchorPoints().appendChild(new IFPathBase.AnchorPoint),t},e.prototype._updateShape=function(t,e,i){t.getAnchorPoints().getChildByIndex(0).setProperties(["x","y"],[i[0].getX(),i[0].getY()]),t.getAnchorPoints().getChildByIndex(1).setProperties(["x","y"],[i[1].getX(),i[1].getY()])},e.prototype.toString=function(){return"[Object IFLineTool]"},t.IFLineTool=e}(this),function(t){function e(){IFShapeTool.call(this,!0,!0)}IFObject.inherit(e,IFShapeTool),e.prototype._createShape=function(){return new IFRectangle},e.prototype._updateShape=function(t,e,i){t.setProperty("trf",new IFTransform(e.getWidth()/2,0,0,e.getHeight()/2,e.getX()+e.getWidth()/2,e.getY()+e.getHeight()/2))},e.prototype._hasCenterCross=function(){return!0},e.prototype.toString=function(){return"[Object IFRectangleTool]"},t.IFRectangleTool=e}(this),function(t){function e(){IFShapeTool.call(this,!0,!0)}IFObject.inherit(e,IFShapeTool),e.prototype._createShape=function(){return new IFEllipse},e.prototype._updateShape=function(t,e,i){t.setProperty("trf",new IFTransform(e.getWidth()/2,0,0,e.getHeight()/2,e.getX()+e.getWidth()/2,e.getY()+e.getHeight()/2))},e.prototype._hasCenterCross=function(){return!0},e.prototype.toString=function(){return"[Object IFEllipseTool]"},t.IFEllipseTool=e}(this),function(t){function e(){IFShapeTool.call(this,!1,!1)}IFObject.inherit(e,IFShapeTool),e.prototype._numberOfPoints=6,e.prototype._innerRadiusFactor=.5,e.prototype._modifiersChanged=function(t){(t.changed.shiftKey||t.changed.optionKey)&&this._invalidateShape(),IFShapeTool.prototype._modifiersChanged.call(this,t)},e.prototype._createShape=function(){return new IFPolygon},e.prototype._updateShape=function(t,e,i){var o=i[1].getX()-i[0].getX(),n=i[1].getY()-i[0].getY(),r=ifMath.normalizeAngleRadians(Math.atan2(n,o)),s=ifMath.ptDist(i[1].getX(),i[1].getY(),i[0].getX(),i[0].getY());ifPlatform.modifiers.shiftKey&&(r=Math.round(12*r/Math.PI)*Math.PI/12);var a=r,l=ifMath.normalizeAngleRadians(r+Math.PI/this._numberOfPoints),h=s,p=s*Math.cos(Math.PI/this._numberOfPoints);ifPlatform.modifiers.optionKey&&(p=s*this._innerRadiusFactor),t.setProperties(["pts","cx","cy","ir","or","ia","oa"],[this._numberOfPoints,i[0].getX(),i[0].getY(),p,h,l,a])},e.prototype._hasCenterCross=function(){return!0},e.prototype.toString=function(){return"[Object IFPolygonTool]"},t.IFPolygonTool=e}(this),function(t){function e(){IFShapeTool.call(this,!0,!0)}IFObject.inherit(e,IFShapeTool),e.prototype._textUnderMouse=null,e.prototype.getCursor=function(){return this._textUnderMouse?IFCursor.SelectDot:this._shape?IFShapeTool.prototype.getCursor.call(this):IFCursor.Text},e.prototype._mouseRelease=function(t){if(this._textUnderMouse){var e=this._editor,i=this._view;this._manager.activateTool(IFPointerTool),e.openInlineEditor(this._textUnderMouse,i,t.client)}else IFShapeTool.prototype._mouseRelease.call(this,t)},e.prototype._mouseMove=function(t){if(IFShapeTool.prototype._mouseMove.call(this,t),this._textUnderMouse&&(this._textUnderMouse=null,this.updateCursor()),!this._shape){var e=this._scene.hitTest(t.client,this._view.getWorldTransform(),null,!1,-1,this._scene.getProperty("pickDist"));e&&e.length&&e[0].element instanceof IFText&&(this._textUnderMouse=e[0].element,this.updateCursor())}},e.prototype._createShape=function(){return new IFRectangle},e.prototype._updateShape=function(t,e,i,o){o?t.setProperty("trf",new IFTransform(e.getWidth(),0,0,e.getHeight(),e.getX(),e.getY())):t.setProperty("trf",new IFTransform(e.getWidth()/2,0,0,e.getHeight()/2,e.getX()+e.getWidth()/2,e.getY()+e.getHeight()/2))},e.prototype._insertShape=function(t){var e=new IFText;e.setProperties(["aw","ah","trf"],[!1,!1,t.getProperty("trf")]),this._insertText(e)},e.prototype._hasCenterCross=function(){return!0},e.prototype._createShapeManually=function(t){var e=new IFText;e.setProperty("trf",new IFTransform(1,0,0,1,t.getX(),t.getY())),this._insertText(e)},e.prototype._insertText=function(t){IFShapeTool.prototype._insertShape.call(this,t);var e=this._editor,i=this._view;this._manager.activateTool(IFPointerTool),e.openInlineEditor(t,i)},e.prototype.toString=function(){return"[Object IFTextTool]"},t.IFTextTool=e}(this),function(t){function e(){IFSelectTool.call(this)}IFObject.inherit(e,IFSelectTool),e.prototype.toString=function(){return"[Object IFPointerTool]"},t.IFPointerTool=e}(this),function(t){function e(){IFSelectTool.call(this)}IFObject.inherit(e,IFSelectTool),e.prototype.activate=function(t){IFSelectTool.prototype.activate.call(this,t),this._editor.storeSelection();var e=this._scene.getActivePage();e?this._editor.updateSelection(!1,[e]):this._editor.clearSelection()},e.prototype.deactivate=function(t){this._editor.restoreSelection(),IFSelectTool.prototype.deactivate.call(this,t)},e.prototype._getSelectableElement=function(t){for(var e=t;null!==e;e=e.getParent())if(e instanceof IFPage)return e;return null},e.prototype.toString=function(){return"[Object IFPageTool]"},t.IFPageTool=e}(this),function(t){function e(){IFSelectTool.call(this)}IFObject.inherit(e,IFSelectTool),e.prototype.activate=function(t){IFSelectTool.prototype.activate.call(this,t);var e=t.getEditor().getSelection();e&&0!==e.length?this._openTransformBox():this._manager.activateTool(IFPointerTool)},e.prototype._mouseDblClick=function(){},e.prototype.toString=function(){return"[Object IFTransformTool]"},t.IFTransformTool=e}(this),function(t){function e(){IFTool.call(this)}IFObject.inherit(e,IFTool),e.prototype._dragStart=null,e.prototype._dragCurrent=null,e.prototype._slice=null,e.prototype._dragArea=null,e.prototype._hasCreatedSlice=!1,e.prototype.getCursor=function(){return IFCursor.Cross},e.prototype.activate=function(t){IFTool.prototype.activate.call(this,t),t.addEventListener(GUIMouseEvent.DragStart,this._mouseDragStart,this),t.addEventListener(GUIMouseEvent.Drag,this._mouseDrag,this),t.addEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd,this),t.addEventListener(GUIMouseEvent.Down,this._mouseDown,this),t.addEventListener(GUIMouseEvent.Release,this._mouseRelease,this),ifPlatform.addEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged,this)},e.prototype.deactivate=function(t){IFTool.prototype.deactivate.call(this,t),t.removeEventListener(GUIMouseEvent.DragStart,this._mouseDragStart),t.removeEventListener(GUIMouseEvent.Drag,this._mouseDrag),t.removeEventListener(GUIMouseEvent.DragEnd,this._mouseDragEnd),t.removeEventListener(GUIMouseEvent.Down,this._mouseDown),t.removeEventListener(GUIMouseEvent.Release,this._mouseRelease),ifPlatform.removeEventListener(GUIPlatform.ModifiersChangedEvent,this._modifiersChanged)},e.prototype.isDeactivatable=function(){return!this._dragStart},e.prototype.paint=function(t){if(this._slice){var e=this._slice.getGeometryBBox();e=this._view.getWorldTransform().mapRect(e);var i=Math.floor(e.getX())+.5,o=Math.floor(e.getY())+.5;t.canvas.strokeRect(i,o,e.getWidth(),e.getHeight(),1,t.selectionOutlineColor)}},e.prototype._mouseDown=function(t){t.button===GUIMouseEvent.BUTTON_LEFT&&this._editor.updateByMousePosition(t.client,this._view.getWorldTransform())},e.prototype._mouseRelease=function(t){if(!this._hasCreatedSlice){var e=this._view.getViewTransform().mapPoint(t.client);e=this._editor.getGuides().mapPoint(e)}this._hasCreatedSlice=!1},e.prototype._mouseDragStart=function(t){this._hasCreatedSlice=!1,this._dragStart=this._view.getViewTransform().mapPoint(t.client),this._editor.getGuides().beginMap(),this._dragStart=this._editor.getGuides().mapPoint(this._dragStart),this._editor.getGuides().finishMap(),this._slice=new IFSlice,this._invalidateSlice(),this.updateCursor()},e.prototype._mouseDrag=function(t){this._dragCurrent=this._view.getViewTransform().mapPoint(t.client),this._invalidateSlice()},e.prototype._mouseDragEnd=function(t){var e=this._slice;this._slice=null,this._invalidateSliceArea(e),this._updateSlice(e,this._dragArea),this._dragStart=null,this._dragCurrent=null,this._slice=null,this._dragArea=null,this.updateCursor(),this._editor.insertElements([e]),this._hasCreatedSlice=!0},e.prototype._modifiersChanged=function(t){(t.changed.shiftKey||t.changed.optionKey||t.changed.metaKey)&&this._invalidateSlice()},e.prototype._invalidateSlice=function(){if(this._dragStart&&this._dragCurrent){this._editor.getGuides().beginMap();var t=this._editor.getGuides().mapPoint(this._dragCurrent);if(this._editor.getGuides().finishMap(),IFPoint.equals(this._dragStart,t))this._invalidateSliceArea();else{var e=this._dragStart.getX(),i=this._dragStart.getY(),o=t.getX(),n=t.getY();if(ifPlatform.modifiers.shiftKey){var r=Math.abs(o-e),s=Math.abs(n-i),a=o<e?-1:1,l=n<i?-1:1;r>=s?(o=e+r*a,n=i+r*l):(o=e+s*a,n=i+s*l)}var h=null;h=ifPlatform.modifiers.optionKey?IFRect.fromPoints(new IFPoint(e-(o-e),i-(n-i)),new IFPoint(e+(o-e),i+(n-i))):IFRect.fromPoints(new IFPoint(e,i),new IFPoint(o,n)),this._dragArea=h,this._invalidateSliceArea(),this._updateSlice(this._slice,h),this._invalidateSliceArea()}}},e.prototype._invalidateSliceArea=function(t){if(t=t||this._slice){var e=this._view.getWorldTransform().mapRect(t.getGeometryBBox());e&&(e.getWidth()>0||e.getHeight()>0)&&this.invalidateArea(e.expanded(1,1,1,1))}},e.prototype._updateSlice=function(t,e){t.setProperty("trf",new IFTransform(e.getWidth()/2,0,0,e.getHeight()/2,e.getX()+e.getWidth()/2,e.getY()+e.getHeight()/2))},e.prototype.toString=function(){return"[Object IFSliceTool]"},t.IFSliceTool=e}(this),function(t){var e=null;function i(t){IFStage.call(this,t),t.getScene().addEventListener(IFScene.InvalidationRequestEvent,this._sceneInvalidationRequest,this)}IFObject.inherit(i,IFStage),i.prototype.release=function(){this._view.getScene().removeEventListener(IFScene.InvalidationRequestEvent,this._sceneInvalidationRequest,this)},i.prototype.paint=function(t){t.dirtyMatcher&&t.dirtyMatcher.transform(this._view.getViewTransform()),t.configuration.pagesVisible&&this._renderPages(t)},i.prototype._sceneInvalidationRequest=function(t){var e=t.area;e&&(e=this._view.getWorldTransform().mapRect(e)),this.invalidate(e)},i.prototype._renderPages=function(t){for(var e=this._view.getScene().getProperty("singlePage"),i=this._view.getWorldTransform(),o=this._view.getScene().getFirstChild();null!==o;o=o.getNext())o instanceof IFPage&&o.isRenderable(t)&&(!e||o.hasFlag(IFNode.Flag.Active))&&this._renderPage(t,i,o)},i.prototype._renderPage=function(t,i,o){var n=new IFRect(o.getProperty("x"),o.getProperty("y"),o.getProperty("w"),o.getProperty("h")),r=n.expanded(-o.getProperty("ml"),-o.getProperty("mt"),-o.getProperty("mr"),-o.getProperty("mb")),s=i.mapRect(n).toAlignedRect(),a=i.mapRect(r).toAlignedRect(),l=s.getX(),h=s.getY(),p=s.getWidth(),d=s.getHeight(),c=a.getX(),_=a.getY(),g=a.getWidth(),u=a.getHeight();e||(e=IFPaintCanvas.createChessboard(8,"white","rgb(205, 205, 205)"));var f=t.canvas.createTexture(e);t.canvas.setTransform(new IFTransform(1,0,0,1,l,h)),t.canvas.fillRect(0,0,p,d,f);var P=o.getProperty("cls");P&&t.canvas.fillRect(0,0,p,d,P),t.canvas.resetTransform(),IFRect.equals(n,r)||t.canvas.strokeRect(c+.5,_+.5,g,u,1,IFColor.MARGIN_OUTLINE)},i.prototype.toString=function(){return"[Object IFEditorBackStage]"},t.IFEditorBackStage=i}(this),function(t){function e(t){IFStage.call(this,t),t.getEditor().addEventListener(IFEditor.InvalidationRequestEvent,this._editorInvalidationRequest,this)}IFObject.inherit(e,IFStage),e.prototype.release=function(){this._view.getEditor().removeEventListener(IFEditor.InvalidationRequestEvent,this._editorInvalidationRequest,this)},e.prototype.paint=function(t){var e=IFElementEditor.getEditor(this._view.getScene());e&&e.paint(this._view.getWorldTransform(),t)},e.prototype._editorInvalidationRequest=function(t){if(t.editor){var e=t.editor.invalidate(this._view.getWorldTransform(),t.args);e&&this.invalidate(e)}},e.prototype.toString=function(){return"[Object IFEditorSceneStage]"},t.IFEditorSceneStage=e}(this),function(t){function e(t){IFStage.call(this,t)}IFObject.inherit(e,IFStage),e.prototype.toString=function(){return"[Object IFEditorToolStage]"},t.IFEditorToolStage=e}(this),function(t){function e(t){IFStage.call(this,t),t.getScene().addEventListener(IFNode.AfterPropertiesChangeEvent,this._sceneAfterPropertiesChanged,this),t.addEventListener(GUIMouseEvent.Release,this._cleanGuides,this),t.getEditor().getGuides().addEventListener(IFGuides.InvalidationRequestEvent,this._guidesInvalidationRequest,this)}IFObject.inherit(e,IFStage),e.prototype.release=function(){this._view.getScene().removeEventListener(IFNode.AfterPropertiesChangeEvent,this._sceneAfterPropertiesChanged,this),this._view.getEditor().removeEventListener(IFGuides.InvalidationRequestEvent,this._guidesInvalidationRequest,this),this._view.removeEventListener(GUIMouseEvent.Release,this._cleanGuides,this)},e.prototype.paint=function(t){this._view.getEditor().getGuides().paint(this._view.getWorldTransform(),t)},e.prototype._sceneAfterPropertiesChanged=function(t){(t.properties.indexOf("gridSizeX")>=0||t.properties.indexOf("gridSizeY")>=0||t.properties.indexOf("gridActive")>=0)&&this.invalidate()},e.prototype._guidesInvalidationRequest=function(t){if(t.area){var e=this._view.getWorldTransform().mapRect(t.area);this.invalidate(e)}},e.prototype._sceneInvalidationRequest=function(t){if(t.area){var e=this._view.getWorldTransform().mapRect(t.area);this.invalidate(e)}},e.prototype._cleanGuides=function(t){this._view.getEditor().getGuides().invalidate()},e.prototype.toString=function(){return"[Object IFEditorFrontStage]"},t.IFEditorFrontStage=e}(this),function(t){function e(t){var e=Array.prototype.slice.call(arguments);e[0]=t.getScene(),this._editor=t,this._viewConfiguration=new IFEditorPaintConfiguration,IFView.apply(this,e),$(this._htmlElement).on("dragenter",function(t){var e=t.originalEvent;e.preventDefault(),e.stopPropagation()}).on("dragover",function(t){var e=t.originalEvent;e.preventDefault(),e.stopPropagation(),t.originalEvent.dataTransfer.dropEffect="move"}).on("drop",function(t){var e=t.originalEvent;e.preventDefault(),e.stopPropagation();var i=GUIWidget.convertClientPositionFromMousePosition(this._htmlElement,e);return this._handleDrop(i,e.dataTransfer),!1}.bind(this))}IFObject.inherit(e,IFView),e.prototype._editor=null,e.prototype._toolStage=null,e.prototype.getEditor=function(){return this._editor},e.prototype.getToolStage=function(){return this._toolStage},e.prototype._initStages=function(){this.addStage(new IFEditorBackStage(this)),this.addStage(new IFSceneStage(this)),this.addStage(new IFEditorFrontStage(this)),this.addStage(new IFEditorSceneStage(this)),this._toolStage=this.addStage(new IFEditorToolStage(this))},e.prototype._updateViewTransforms=function(){IFView.prototype._updateViewTransforms.call(this),this._editor.updateInlineEditorForView(this)},e.prototype._handleDrop=function(t,e){var i=this.getViewTransform().mapPoint(t);if(e.files&&e.files.length>0)for(var o=/image.*/,n=0;n<e.files.length;++n){var r=e.files[n],s=r.name;if(s.lastIndexOf(".")>0&&(s=s.substr(0,s.lastIndexOf("."))),r.type.match(o)){var a=new FileReader;a.onload=function(t){var e=new IFImage;e.setProperties(["name","url","transform"],[s,t.target.result,new IFTransform(1,0,0,1,i.getX(),i.getY())]),this._editor.insertElements([e])}.bind(this),a.readAsDataURL(r)}}else if(e.items&&e.items.length>0)for(n=0;n<e.items.length;++n){var l=e.items[n],h=null,p=null;if(l.type===IFPattern.MIME_TYPE?(h=IFElementEditor.DropType.Pattern,p=(p=e.getData(IFPattern.MIME_TYPE))&&""!==p?IFPattern.parsePattern(p):null):l.type===IFNode.MIME_TYPE?(h=IFElementEditor.DropType.Node,p=(p=e.getData(IFNode.MIME_TYPE))&&""!==p?IFNode.deserialize(p):null):"text/plain"===l.type&&(h=IFElementEditor.DropType.Text,p=e.getData("text/plain")),null!==h){var d=this._scene.hitTest(t,this.getWorldTransform(),null,!0,-1,this._scene.getProperty("pickDist"),!0),c=!1;if(d&&d.length>0)for(var _=0;_<d.length;++_){var g=d[_],u=IFElementEditor.createEditor(g.element);if(u&&u.acceptDrop(i,h,p,g.data)){c=!0;break}}if(!c&&h===IFElementEditor.DropType.Node&&p instanceof IFElement){var f=p.getGeometryBBox();p.transform(new IFTransform(1,0,0,1,i.getX()-(f?f.getX():0),i.getY()-(f?f.getY():0))),this._editor.insertElements([p]),c=!0}}}},e.prototype.toString=function(){return"[Object IFEditorView]"},t.IFEditorView=e}(this),function(t){function e(t){this._scene=t,this._scene.__graphic_editor__=this,this._transactionStack=[],this._undoStates=[],this._redoStates=[],this._guides=new IFGuides(this._scene),this._scene.addEventListener(IFNode.AfterInsertEvent,this._afterNodeInsert,this),this._scene.addEventListener(IFNode.BeforeRemoveEvent,this._beforeNodeRemove,this),this._scene.addEventListener(IFNode.BeforePropertiesChangeEvent,this._beforePropertiesChange,this),this._scene.addEventListener(IFNode.BeforeFlagChangeEvent,this._beforeFlagChange,this),this._scene.addEventListener(IFNode.AfterFlagChangeEvent,this._afterFlagChange,this),this._scene.addEventListener(IFElement.GeometryChangeEvent,this._geometryChange,this);var e=this._scene.queryAll(":selected");if(e&&e.length)for(var i=0;i<e.length;++i)this._tryAddToSelection(e[i])}IFObject.inherit(e,GEventTarget),e.options={maxUndoSteps:20,smartUndoPropertyMerge:!0,cloneShift:10},e.getEditor=function(t){return t.__graphic_editor__?t.__graphic_editor__:null},e.tryRunTransaction=function(t,i,o){var n=e.getEditor(t.getScene());n&&n.beginTransaction();try{i()}finally{n&&n.commitTransaction(o)}},e.SelectionChangedEvent=function(){},IFObject.inherit(e.SelectionChangedEvent,GEvent),e.SelectionChangedEvent.prototype.toString=function(){return"[Event IFEditor.SelectionChangedEvent]"},e.SELECTION_CHANGED_EVENT=new e.SelectionChangedEvent,e.InlineEditorEvent=function(t,e){this.editor=t,this.type=e},IFObject.inherit(e.InlineEditorEvent,GEvent),e.InlineEditorEvent.Type={BeforeOpen:0,AfterOpen:1,BeforeClose:10,AfterClose:11,SelectionChanged:100},e.InlineEditorEvent.prototype.editor=null,e.InlineEditorEvent.prototype.type=null,e.InlineEditorEvent.prototype.toString=function(){return"[Event IFEditor.InlineEditorEvent]"},e.InvalidationRequestEvent=function(t,e){this.editor=t,this.args=e},IFObject.inherit(e.InvalidationRequestEvent,GEvent),e.InvalidationRequestEvent.prototype.editor=null,e.InvalidationRequestEvent.prototype.args=null,e.InvalidationRequestEvent.prototype.toString=function(){return"[Event IFEditor.InvalidationRequestEvent]"},e.prototype._scene=null,e.prototype._selection=null,e.prototype._lastCloneSelection=null,e.prototype._storedSelection=null,e.prototype._pageSelections=null,e.prototype._selectionUpdateCounter=0,e.prototype._selectionDetail=!1,e.prototype._transactionStack=null,e.prototype._undoStates=null,e.prototype._redoStates=null,e.prototype._guides=null,e.prototype._currentInlineEditorNode=null,e.prototype.getScene=function(){return this._scene},e.prototype.hasSelection=function(){return this._selection&&this._selection.length>0},e.prototype.getSelectionBBox=function(t){if(this.hasSelection()){for(var e=null,i=0;i<this._selection.length;++i){var o=t?this._selection[i].getGeometryBBox():this._selection[i].getPaintBBox();o&&!o.isEmpty()&&(e=e?e.united(o):new IFRect(o.getX(),o.getY(),o.getWidth(),o.getHeight()))}return e}return null},e.prototype.getSelection=function(){return this._selection},e.prototype.getSelectionCopy=function(){var t=null;if(this._selection&&this._selection.length>0){t=[];for(var e=0;e<this._selection.length;++e){var i=this._selection[e];if(i instanceof IFBlock){var o=i.getPage(),n=i.clone();n&&(n.transform(new IFTransform(1,0,0,1,-o.getProperty("x"),-o.getProperty("y"))),t.push(n))}}t.length||(t=null)}return t},e.prototype.hasSelectionDetail=function(){return this._selectionDetail},e.prototype.setSelectionDetail=function(t){if(t!==this._selectionDetail&&(this._selectionDetail=t,this._selection))for(var e=0;e<this._selection.length;++e){var i=IFElementEditor.getEditor(this._selection[e]);i&&(this._selectionDetail?i.setFlag(IFElementEditor.Flag.Detail):i.removeFlag(IFElementEditor.Flag.Detail))}},e.prototype.getGuides=function(){return this._guides},e.prototype.getPathSelection=function(){var t,e=null;if(this.hasSelection())for(t=0;t<this._selection.length;++t)if(this._selection[t]instanceof IFPath){if(e){e=null;break}e=this._selection[t]}else if(e){e=null;break}return e},e.prototype.release=function(){delete this._scene.__graphic_editor__,this._scene.removeEventListener(IFNode.AfterInsertEvent,this._afterNodeInsert),this._scene.removeEventListener(IFNode.BeforeRemoveEvent,this._beforeNodeRemove),this._scene.removeEventListener(IFNode.BeforePropertiesChangeEvent,this._beforePropertiesChange),this._scene.removeEventListener(IFNode.BeforeFlagChangeEvent,this._beforeFlagChange),this._scene.removeEventListener(IFNode.AfterFlagChangeEvent,this._afterFlagChange),this._scene.removeEventListener(IFElement.GeometryChangeEvent,this._geometryChange)},e.prototype.requestInvalidation=function(t,i){this.hasEventListeners(e.InvalidationRequestEvent)&&this.trigger(new e.InvalidationRequestEvent(t,i))},e.prototype.cloneSelection=function(t,i){if(this._selection&&this._selection.length>0){for(var o=[],n=0;n<this._selection.length;++n){(d=this._selection[n]).hasMixin(IFNode.Store)&&o.push({element:d,transform:t?new IFTransform(1,0,0,1,e.options.cloneShift,e.options.cloneShift):null})}var r=[];if(i&&this._lastCloneSelection)for(n=0;n<this._lastCloneSelection.length;++n){var s=this._lastCloneSelection[n],a=o[n].element;if(s.hasMixin(IFElement.Transform)&&a.hasMixin(IFElement.Transform)){var l=s.getTransform(),h=a.getTransform();if(h){var p=l?h.preMultiplied(l.inverted()):h;p.isIdentity()||(o[n].transform=p)}}}for(n=0;n<o.length;++n){var d=o[n].element,c=o[n].transform,_=d.clone();_&&(d.getParent().appendChild(_),c&&_.hasMixin(IFElement.Transform)&&_.transform(c),r.push(_))}if(r.length>0&&this.updateSelection(!1,r),i){this._lastCloneSelection=[];for(n=0;n<o.length;++n)this._lastCloneSelection.push(o[n].element)}return r}return null},e.prototype.deleteSelection=function(t){if(this._selection&&this._selection.length>0){t||this.beginTransaction();try{var e=IFNode.order(this._selection.slice(),!0);this.clearSelection();for(var i=0;i<e.length;++i){var o=e[i];o instanceof IFItem&&!o.hasFlag(IFElement.Flag.Locked)&&o.getParent().removeChild(o)}}finally{t||this.commitTransaction("Delete Selection")}}return null},e.prototype.updateSelection=function(t,e){this._beginSelectionUpdate();try{if(t){if(e&&e.length)for(i=0;i<e.length;++i)e[i].hasFlag(IFNode.Flag.Selected)?e[i].removeFlag(IFNode.Flag.Selected):e[i].setFlag(IFNode.Flag.Selected)}else{if(e&&e.length>0)for(var i=0;i<e.length;++i)e[i].setFlag(IFNode.Flag.Selected);this.clearSelection(e)}}finally{this._finishSelectionUpdate()}},e.prototype.clearSelection=function(t){if(!ifUtil.equals(t,this._selection)){this._beginSelectionUpdate();try{for(var e=0;this._selection&&e<this._selection.length;)t&&t.indexOf(this._selection[e])>=0?e++:this._selection[e].removeFlag(IFNode.Flag.Selected)}finally{this._finishSelectionUpdate()}}},e.prototype.storeSelection=function(){this._scene.getProperty("singlePage")?this._savePageSelection(this._scene.getActivePage(),!0):this._storedSelection=this._saveSelection()},e.prototype.restoreSelection=function(){this._scene.getProperty("singlePage")?this._restorePageSelection(this._scene.getActivePage()):this._loadSelection(this._storedSelection)},e.prototype.moveSelection=function(t,e,i,o,n){var r=t;if(e&&n&&1==this._selection.length){var s=IFElement.prototype.getGroupGeometryBBox(this._selection),a=s.getClosestSideName(n),l=s.getSide(a),h=l.add(t);this._guides.getShapeBoxGuide().useExclusions(this._selection),this._guides.beginMap(),h=this._guides.mapPoint(h),this._guides.finishMap(),r=h.subtract(l)}this.transformSelection(new IFTransform(1,0,0,1,r.getX(),r.getY()),i,o)},e.prototype.scaleSelection=function(t,e,i,o,n,r,s){var a=IFElement.prototype.getGroupGeometryBBox(this._selection);if(a){var l,h,p=a.getSide(IFRect.Side.TOP_LEFT),d=a.getSide(IFRect.Side.BOTTOM_RIGHT),c=a.getSide(IFRect.Side.CENTER);l=i<0?d.getX():i>0?p.getX():c.getX(),h=o<0?d.getY():o>0?p.getY():c.getY();var _=new IFTransform(1,0,0,1,-l,-h).multiplied(new IFTransform(t,0,0,e,0,0)).multiplied(new IFTransform(1,0,0,1,l,h));this.transformSelection(_,r,s)}},e.prototype.transformSelection=function(t,e,i){if(this._selection&&this._selection.length)for(var o=0;o<this._selection.length;++o){var n=this._selection[o],r=IFElementEditor.getEditor(n);r&&r.transform(t,e,i)}},e.prototype.resetSelectionTransform=function(){if(this._selection&&this._selection.length)for(var t=0;t<this._selection.length;++t){var e=this._selection[t],i=IFElementEditor.getEditor(e);i&&i.resetTransform()}},e.prototype.applySelectionTransform=function(t,e){if(this._selection&&this._selection.length){for(var i=[],o=0;o<this._selection.length;++o){var n=this._selection[o];(s=IFElementEditor.getEditor(n))&&(s.canApplyTransform()?i.push(n):s.resetTransform())}if(i&&i.length>0){e||this.beginTransaction();try{var r=[];for(o=0;o<i.length;++o){var s;n=i[o];if(s=IFElementEditor.getEditor(n)){var a=i[o],l=a;t?a.hasMixin(IFNode.Store)?(l=a.clone(),a.getParent().appendChild(l),r.push(l)):l=null:a.hasFlag(IFElement.Flag.Locked)&&(l=null),l?s.applyTransform(l):s.resetTransform()}}r.length>0&&this.updateSelection(!1,r)}finally{e||this.commitTransaction(t?"Transform & Clone Selection":"Transform Selection")}}}},e.prototype.insertElements=function(t,e,i){var o=this._scene.querySingle("page:active layer:active");if(!o)throw new Error("No active page/layer.");i||this.beginTransaction();try{for(var n=0;n<t.length;++n){var r=t[n];if(o.appendChild(r),!e){var s=IFElementEditor.createEditor(r);s&&s.initialSetup()}}this.updateSelection(!1,t)}finally{i||this.commitTransaction("Insert Element(s)")}},e.prototype.updateByMousePosition=function(t,e){if(!1===this._scene.getProperty("singlePage")){var i=this._scene.hitTest(t,e,function(t){return t instanceof IFPage}.bind(this),!1,1);if(i&&1===i.length)for(var o=this._scene.getFirstChild();null!==o;o=o.getNext())o instanceof IFPage&&(o===i[0].element?o.setFlag(IFNode.Flag.Active):o.removeFlag(IFNode.Flag.Active))}},e.prototype.beginTransaction=function(){var t=IFElementEditor.getEditor(this._scene);this._transactionStack.push({actions:[],selection:this._saveSelection(),transformBoxCenter:t?t.getTransformBoxCenter():null})},e.prototype._transactionRedo=function(t){for(var e=0;e<t.actions.length;++e)t.actions[e].action();this._loadSelection(t.newSelection);var i=IFElementEditor.getEditor(this._scene);(t.newTransformBoxCenter||i&&i.isTransformBoxActive())&&(t.newTransformBoxCenter?i.setTransformBoxActive(!0,t.newTransformBoxCenter):i.setTransformBoxActive(!1))},e.prototype._transactionUndo=function(t){for(var e=t.actions.length-1;e>=0;--e)t.actions[e].revert();this._loadSelection(t.selection);var i=IFElementEditor.getEditor(this._scene);(t.transformBoxCenter||i&&i.isTransformBoxActive())&&(t.transformBoxCenter?i.setTransformBoxActive(!0,t.transformBoxCenter):i.setTransformBoxActive(!1))},e.prototype._transactionMerge=function(t,i){if(e.options.smartUndoPropertyMerge&&1===i.actions.length&&1===t.actions.length){var o=i.actions[0],n=t.actions[0];if(o.isPropertyChangeAction&&n.isPropertyChangeAction&&o.node===n.node&&o.properties.length===n.properties.length){for(var r=!0,s=0;s<n.properties.length;++s){var a=n.properties[s];if(o.properties.indexOf(a)<0){r=!1;break}}if(r){for(s=0;s<o.properties.length;++s){a=o.properties[s];n.values[n.properties.indexOf(a)]=o.values[s]}return!0}}}return!1},e.prototype.commitTransaction=function(t){if(!this._transactionStack.length)throw new Error("Nothing to commit, transaction stack is empty.");var e=this._transactionStack.pop();if(e.actions.length>0){var i=IFElementEditor.getEditor(this._scene),o={actions:e.actions.slice(),selection:e.selection?e.selection.slice():null,newSelection:this._saveSelection(),transformBoxCenter:e.transformBoxCenter,newTransformBoxCenter:i?i.getTransformBoxCenter():null};this.pushState(t,this._transactionRedo.bind(this),this._transactionUndo.bind(this),o,this._transactionMerge.bind(this))}},e.prototype.pushState=function(t,i,o,n,r){if(r&&n&&this._undoStates.length>0){var s=this._undoStates[this._undoStates.length-1];if(s.data&&s.name===t&&r(s.data,n))return}this._undoStates.length>=e.options.maxUndoSteps&&this._undoStates.shift(),this._undoStates.push({name:t||"",action:i,revert:o,data:n}),this._redoStates=[]},e.prototype.hasUndoState=function(){return this._undoStates.length>0},e.prototype.hasRedoState=function(){return this._redoStates.length>0},e.prototype.getUndoStateName=function(){return this._undoStates.length>0?this._undoStates[this._undoStates.length-1].name:null},e.prototype.getRedoStateName=function(){return this._redoStates.length>0?this._redoStates[this._redoStates.length-1].name:null},e.prototype.undoState=function(){if(this._undoStates.length>0){var t=this._undoStates.pop();this._redoStates.push(t),t.revert(t.data)}},e.prototype.redoState=function(){if(this._redoStates.length>0){var t=this._redoStates.pop();this._undoStates.push(t),t.action(t.data)}},e.prototype.isInlineEditing=function(){return!!this._currentInlineEditorNode},e.prototype.openInlineEditor=function(t,i,o){this.closeInlineEditor();var n=IFElementEditor.getEditor(t);return!(!n||!n.canInlineEdit())&&(this.hasEventListeners(e.InlineEditorEvent)&&this.trigger(new e.InlineEditorEvent(n,e.InlineEditorEvent.Type.BeforeOpen)),n.beginInlineEdit(i,i._htmlElement),n.adjustInlineEditForView(i,o),this._currentInlineEditorNode=t,this.hasEventListeners(e.InlineEditorEvent)&&this.trigger(new e.InlineEditorEvent(n,e.InlineEditorEvent.Type.AfterOpen)),!0)},e.prototype.updateInlineEditorForView=function(t){if(this._currentInlineEditorNode){var e=IFElementEditor.getEditor(this._currentInlineEditorNode);e&&e.isInlineEdit()&&e.adjustInlineEditForView(t)}},e.prototype.closeInlineEditor=function(){return!!this._currentInlineEditorNode&&this._finishEditorInlineEdit(this._currentInlineEditorNode)},e.prototype._afterNodeInsert=function(t){if(this._transactionStack.length){var e=t.node,i=e.getParent(),o=e.getNext();this._transactionStack[this._transactionStack.length-1].actions.push({action:function(){i.insertChild(e,o)},revert:function(){i.removeChild(e)}})}this._tryAddToSelection(t.node)},e.prototype._beforeNodeRemove=function(t){if(this._transactionStack.length){var e=t.node,i=e.getParent(),o=e.getNext();this._transactionStack[this._transactionStack.length-1].actions.push({action:function(){i.removeChild(e)},revert:function(){i.insertChild(e,o)}})}t.node instanceof IFElement&&(this._selection&&this._selection.indexOf(t.node)>=0?t.node.removeFlag(IFNode.Flag.Selected):this._closeEditor(t.node)),t.node instanceof IFPage&&!0===this._scene.getProperty("singlePage")&&this._removePageSelection(t.node)},e.prototype._beforePropertiesChange=function(t){if(this._transactionStack.length){for(var e=t.node,i=t.properties,o=t.values,n=[],r=0;r<t.properties.length;++r)n.push(e.getProperty(t.properties[r]));this._transactionStack[this._transactionStack.length-1].actions.push({isPropertyChangeAction:!0,node:e,properties:i.slice(),values:o.slice(),oldValues:n,action:function(){e.setProperties(this.properties,this.values)},revert:function(){e.setProperties(this.properties,this.oldValues)}})}},e.prototype._beforeFlagChange=function(t){t.node instanceof IFElement&&t.flag===IFElement.Flag.Hidden&&t.set&&t.node.removeFlag(IFNode.Flag.Selected)},e.prototype._afterFlagChange=function(t){if(t.node instanceof IFElement)if(t.flag===IFNode.Flag.Selected)t.set?this._tryAddToSelection(t.node):this._tryRemoveFromSelection(t.node);else if(t.flag==IFNode.Flag.Highlighted){var e;if(t.set)(e=IFElementEditor.openEditor(t.node))&&e.setFlag(IFElementEditor.Flag.Highlighted);else(e=IFElementEditor.openEditor(t.node))&&e.removeFlag(IFElementEditor.Flag.Highlighted),this._tryCloseEditor(t.node)}else t.flag==IFNode.Flag.Active&&t.node instanceof IFPage&&!0===this._scene.getProperty("singlePage")&&(t.set?this._restorePageSelection(t.node):this._savePageSelection(t.node,!1,!0))},e.prototype._geometryChange=function(t){if(this._selection&&this._selection.indexOf(t.element)>=0)switch(t.type){case IFElement.GeometryChangeEvent.Type.Before:case IFElement.GeometryChangeEvent.Type.After:case IFElement.GeometryChangeEvent.Type.Child:var e=IFElementEditor.getEditor(t.element);e&&e.requestInvalidation()}},e.prototype._beginSelectionUpdate=function(){this._selectionUpdateCounter+=1},e.prototype._finishSelectionUpdate=function(){0===--this._selectionUpdateCounter&&this._updatedSelection()},e.prototype._updatedSelection=function(){0===this._selectionUpdateCounter&&(this._lastCloneSelection=null,this.hasEventListeners(e.SelectionChangedEvent)&&this.trigger(e.SELECTION_CHANGED_EVENT))},e.prototype._tryAddToSelection=function(t){if(t instanceof IFElement&&t.hasFlag(IFNode.Flag.Selected)){var e=IFElementEditor.openEditor(t);e&&(e.setFlag(IFElementEditor.Flag.Selected),this._selectionDetail&&e.setFlag(IFElementEditor.Flag.Detail)),this._selection||(this._selection=[]),this._selection.push(t),this._updatedSelection()}},e.prototype._tryRemoveFromSelection=function(t){if(t instanceof IFElement){var e=IFElementEditor.getEditor(t);if(e&&e.hasFlag(IFElementEditor.Flag.Selected)&&(e.removeFlag(IFElementEditor.Flag.Selected),this._tryCloseEditor(t)),this._selection){for(var i=-1,o=0;o<this._selection.length;++o){var n=this._selection[o];n===t?i=o:n.getParent()===t.getParent()&&!0}this._selection.splice(i,1),0==this._selection.length&&(this._selection=null),this._updatedSelection()}}},e.prototype._tryCloseEditor=function(t){var e=IFElementEditor.getEditor(t);if(e&&!e.hasFlag(IFElementEditor.Flag.Selected)&&!e.hasFlag(IFElementEditor.Flag.Highlighted)&&(null==e.getEditors()||0==e.getEditors().length)){var i=e.getParentEditor();this._closeEditor(t),i&&this._tryCloseEditor(i.getElement())}},e.prototype._finishEditorInlineEdit=function(t){var i=IFElementEditor.getEditor(t);if(i&&i.isInlineEdit()){this.hasEventListeners(e.InlineEditorEvent)&&this.trigger(new e.InlineEditorEvent(i,e.InlineEditorEvent.Type.BeforeClose));var o=null;this.beginTransaction();try{o=i.finishInlineEdit()}finally{this.commitTransaction(o||"Inline Editing")}return t===this._currentInlineEditorNode&&(this._currentInlineEditorNode=null),this.hasEventListeners(e.InlineEditorEvent)&&this.trigger(new e.InlineEditorEvent(i,e.InlineEditorEvent.Type.AfterClose)),!0}return!1},e.prototype._closeEditor=function(t){this._finishEditorInlineEdit(t),IFElementEditor.closeEditor(t)},e.prototype._savePageSelection=function(t,e,i){this._pageSelections||(this._pageSelections=[]);for(var o=0;o<this._pageSelections.length;++o){var n=this._pageSelections[o];if(n.page===t)return void(i&&n.noOverwrite||(n.selection=this._saveSelection(),n.noOverwrite=e))}this._pageSelections.push({page:t,selection:this._saveSelection()})},e.prototype._restorePageSelection=function(t){if(this._pageSelections)for(var e=0;e<this._pageSelections.length;++e){var i=this._pageSelections[e];if(i.page===t)return void this._loadSelection(i.selection)}this.clearSelection()},e.prototype._removePageSelection=function(t){if(this._pageSelections)for(var e=0;e<this._pageSelections.length;++e){if(this._pageSelections[e].page===t){this._pageSelections.splice(e,1);break}}},e.prototype._saveSelection=function(){if(!this._selection||0===this._selection.length)return null;for(var t=[],e=0;e<this._selection.length;++e){var i=this._selection[e],o=IFElementEditor.getEditor(i),n=o?o.getPartSelection():null;t.push({element:i,parts:n?n.slice():null})}return t},e.prototype._loadSelection=function(t){if(t&&0!==t.length){for(var e=[],i=0;i<t.length;++i)e.push(t[i].element);this.updateSelection(!1,e);for(i=0;i<t.length;++i)if(t[i].parts){var o=IFElementEditor.getEditor(t[i].element);o&&o.updatePartSelection(!1,t[i].parts)}}else this.clearSelection()},e.prototype.toString=function(){return"[Object IFEditor]"},t.IFEditor=e}(this),function(t){function e(){}IFObject.inherit(e,IFScenePaintConfiguration),e.prototype.pagesVisible=!0,e.prototype.gridVisible=!0,e.prototype.toString=function(){return"[Object IFEditorPaintConfiguration]"},t.IFEditorPaintConfiguration=e}(this),ifLocale.setValues(IFSceneEditor,IFLocale.Language.English,["action.insert","action.remove","action.properties"],["Insert","Remove","Change Properties"]);